<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    package net.global_village.eofextensions;<a name="line.1"></a>
<FONT color="green">002</FONT>    <a name="line.2"></a>
<FONT color="green">003</FONT>    import java.lang.reflect.*;<a name="line.3"></a>
<FONT color="green">004</FONT>    import java.math.*;<a name="line.4"></a>
<FONT color="green">005</FONT>    import java.util.*;<a name="line.5"></a>
<FONT color="green">006</FONT>    <a name="line.6"></a>
<FONT color="green">007</FONT>    import com.webobjects.eoaccess.*;<a name="line.7"></a>
<FONT color="green">008</FONT>    import com.webobjects.eocontrol.*;<a name="line.8"></a>
<FONT color="green">009</FONT>    import com.webobjects.foundation.*;<a name="line.9"></a>
<FONT color="green">010</FONT>    <a name="line.10"></a>
<FONT color="green">011</FONT>    import net.global_village.foundation.*;<a name="line.11"></a>
<FONT color="green">012</FONT>    import net.global_village.foundation.Collection;<a name="line.12"></a>
<FONT color="green">013</FONT>    <a name="line.13"></a>
<FONT color="green">014</FONT>    <a name="line.14"></a>
<FONT color="green">015</FONT>    /**<a name="line.15"></a>
<FONT color="green">016</FONT>     * Methods added to extended the functionality of EOEditingContext in the manner of EOUtilities<a name="line.16"></a>
<FONT color="green">017</FONT>     *<a name="line.17"></a>
<FONT color="green">018</FONT>     * @author Copyright (c) 2001-2005  Global Village Consulting, Inc.  All rights reserved.<a name="line.18"></a>
<FONT color="green">019</FONT>     * This software is published under the terms of the Educational Community License (ECL) version 1.0,<a name="line.19"></a>
<FONT color="green">020</FONT>     * a copy of which has been included with this distribution in the LICENSE.TXT file.<a name="line.20"></a>
<FONT color="green">021</FONT>     * @version $Revision: 10$<a name="line.21"></a>
<FONT color="green">022</FONT>     */  <a name="line.22"></a>
<FONT color="green">023</FONT>    public class EOEditingContextAdditions<a name="line.23"></a>
<FONT color="green">024</FONT>    {<a name="line.24"></a>
<FONT color="green">025</FONT>        /** Aggregate function constants. */<a name="line.25"></a>
<FONT color="green">026</FONT>        public static final String Max = "max";<a name="line.26"></a>
<FONT color="green">027</FONT>        public static final String Min = "min";<a name="line.27"></a>
<FONT color="green">028</FONT>        public static final String Count = "count";<a name="line.28"></a>
<FONT color="green">029</FONT>        public static final String Avg = "avg";<a name="line.29"></a>
<FONT color="green">030</FONT>        public static final String Sum = "sum";<a name="line.30"></a>
<FONT color="green">031</FONT>    <a name="line.31"></a>
<FONT color="green">032</FONT>        /**<a name="line.32"></a>
<FONT color="green">033</FONT>         * A set of aggregate functions.<a name="line.33"></a>
<FONT color="green">034</FONT>         */<a name="line.34"></a>
<FONT color="green">035</FONT>        public static final NSSet setOfAllAggregateFunctions = new NSSet(new Object[] {Max, Min, Count, Avg, Sum});<a name="line.35"></a>
<FONT color="green">036</FONT>    <a name="line.36"></a>
<FONT color="green">037</FONT>    <a name="line.37"></a>
<FONT color="green">038</FONT>        /**<a name="line.38"></a>
<FONT color="green">039</FONT>         * Static methods only.  You'll never need to instantiate this class.<a name="line.39"></a>
<FONT color="green">040</FONT>         */<a name="line.40"></a>
<FONT color="green">041</FONT>        private EOEditingContextAdditions()<a name="line.41"></a>
<FONT color="green">042</FONT>        {<a name="line.42"></a>
<FONT color="green">043</FONT>            super();<a name="line.43"></a>
<FONT color="green">044</FONT>        }<a name="line.44"></a>
<FONT color="green">045</FONT>    <a name="line.45"></a>
<FONT color="green">046</FONT>    <a name="line.46"></a>
<FONT color="green">047</FONT>    <a name="line.47"></a>
<FONT color="green">048</FONT>        /**<a name="line.48"></a>
<FONT color="green">049</FONT>         * Returns an array of all the objects of the named entitiy, except for the ones in the &lt;code&gt;objectsToExclude&lt;/code&gt; array.<a name="line.49"></a>
<FONT color="green">050</FONT>         *<a name="line.50"></a>
<FONT color="green">051</FONT>         * @param editingContext the editing context to be used for fetching the all the objects<a name="line.51"></a>
<FONT color="green">052</FONT>         * @param entityName the entity name of the objects being compared to<a name="line.52"></a>
<FONT color="green">053</FONT>         * @param objectsToExclude the list of objects that will be removed from the the objects associated with the entityName<a name="line.53"></a>
<FONT color="green">054</FONT>         * @return an array of objects excluding the ones in the &lt;code&gt;objectsToExclude&lt;/code&gt; array<a name="line.54"></a>
<FONT color="green">055</FONT>         */<a name="line.55"></a>
<FONT color="green">056</FONT>        public static NSArray objectsForEntityNamed(EOEditingContext editingContext,<a name="line.56"></a>
<FONT color="green">057</FONT>                                                    String entityName,      <a name="line.57"></a>
<FONT color="green">058</FONT>                                                    NSArray objectsToExclude)<a name="line.58"></a>
<FONT color="green">059</FONT>        {<a name="line.59"></a>
<FONT color="green">060</FONT>            /** require<a name="line.60"></a>
<FONT color="green">061</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.61"></a>
<FONT color="green">062</FONT>            [valid_entityName_param] entityName != null;<a name="line.62"></a>
<FONT color="green">063</FONT>            [valid_objectsToExclude_param] objectsToExclude != null; **/<a name="line.63"></a>
<FONT color="green">064</FONT>            JassAdditions.pre("EOEditingContextAdditions", "objectsForEntityNamed", EOModelGroup.defaultGroup().entityNamed(entityName) != null);<a name="line.64"></a>
<FONT color="green">065</FONT>    <a name="line.65"></a>
<FONT color="green">066</FONT>            NSArray allObjects = EOUtilities.objectsForEntityNamed(editingContext, entityName);<a name="line.66"></a>
<FONT color="green">067</FONT>    <a name="line.67"></a>
<FONT color="green">068</FONT>            //Convert the arrays to sets<a name="line.68"></a>
<FONT color="green">069</FONT>            NSMutableSet setOfAllObjects = Collection.collectionToNSMutableSet(allObjects);<a name="line.69"></a>
<FONT color="green">070</FONT>            NSMutableSet setObjectsToExclude = Collection.collectionToNSMutableSet(objectsToExclude);<a name="line.70"></a>
<FONT color="green">071</FONT>    <a name="line.71"></a>
<FONT color="green">072</FONT>            setOfAllObjects.subtractSet(setObjectsToExclude);<a name="line.72"></a>
<FONT color="green">073</FONT>    <a name="line.73"></a>
<FONT color="green">074</FONT>            return setOfAllObjects.allObjects();<a name="line.74"></a>
<FONT color="green">075</FONT>    <a name="line.75"></a>
<FONT color="green">076</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.76"></a>
<FONT color="green">077</FONT>        }<a name="line.77"></a>
<FONT color="green">078</FONT>    <a name="line.78"></a>
<FONT color="green">079</FONT>    <a name="line.79"></a>
<FONT color="green">080</FONT>    <a name="line.80"></a>
<FONT color="green">081</FONT>        /**<a name="line.81"></a>
<FONT color="green">082</FONT>         * Returns the number of objects of the specified entity, optionally restricted by qualifer.  This should be used when fetching all the objects is not desirable and server side evaluation is needed.&lt;p&gt;<a name="line.82"></a>
<FONT color="green">083</FONT>         *<a name="line.83"></a>
<FONT color="green">084</FONT>         * Example Usage:&lt;code&gt;&lt;pre&gt;<a name="line.84"></a>
<FONT color="green">085</FONT>         *    EOQualfier unpaidInvoices = EOQualfier.qualifierWithQualifierFormat("isPaid = 'N'", null);<a name="line.85"></a>
<FONT color="green">086</FONT>         *    Number numberOfUnpaidInvoices = countObjectsForEntityNamed(editingContext,<a name="line.86"></a>
<FONT color="green">087</FONT>         *                                                               "Invoice",<a name="line.87"></a>
<FONT color="green">088</FONT>         *                                                               unpaidInvoices);&lt;/pre&gt;&lt;/code&gt;<a name="line.88"></a>
<FONT color="green">089</FONT>         *<a name="line.89"></a>
<FONT color="green">090</FONT>         * @param editingContext the editingContext to be used for fetching<a name="line.90"></a>
<FONT color="green">091</FONT>         * @param entityName the entity name of the objects to be counted<a name="line.91"></a>
<FONT color="green">092</FONT>         * @param qualifier the qualifier to be applied <a name="line.92"></a>
<FONT color="green">093</FONT>         * @return the number of objects of the specified entity<a name="line.93"></a>
<FONT color="green">094</FONT>         */<a name="line.94"></a>
<FONT color="green">095</FONT>        public static Number countOfObjectsForEntityNamed(EOEditingContext editingContext,<a name="line.95"></a>
<FONT color="green">096</FONT>                                                          String entityName,<a name="line.96"></a>
<FONT color="green">097</FONT>                                                          EOQualifier qualifier)<a name="line.97"></a>
<FONT color="green">098</FONT>        {<a name="line.98"></a>
<FONT color="green">099</FONT>            /** require<a name="line.99"></a>
<FONT color="green">100</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.100"></a>
<FONT color="green">101</FONT>            [valid_entityName_param] entityName != null; **/<a name="line.101"></a>
<FONT color="green">102</FONT>            JassAdditions.pre("EOEditingContextAdditions", "countOfObjectsForEntityNamed", EOModelGroup.defaultGroup().entityNamed(entityName) != null);<a name="line.102"></a>
<FONT color="green">103</FONT>    <a name="line.103"></a>
<FONT color="green">104</FONT>            Number result;<a name="line.104"></a>
<FONT color="green">105</FONT>    <a name="line.105"></a>
<FONT color="green">106</FONT>            EOEntity anEntity = EOModelGroup.defaultGroup().entityNamed(entityName);<a name="line.106"></a>
<FONT color="green">107</FONT>    //        String dummyAttributeName = ((EOAttribute) (anEntity.attributes().objectAtIndex(0))).name();<a name="line.107"></a>
<FONT color="green">108</FONT>    <a name="line.108"></a>
<FONT color="green">109</FONT>            String dummyAttributeName = ((EOAttribute) anEntity.primaryKeyAttributes().objectAtIndex(0)).name();<a name="line.109"></a>
<FONT color="green">110</FONT>            result = (Number) EOEditingContextAdditions.computeAggregateFunction(editingContext,<a name="line.110"></a>
<FONT color="green">111</FONT>                                                                                 "count",<a name="line.111"></a>
<FONT color="green">112</FONT>                                                                                 dummyAttributeName,<a name="line.112"></a>
<FONT color="green">113</FONT>                                                                                 entityName,<a name="line.113"></a>
<FONT color="green">114</FONT>                                                                                 qualifier);<a name="line.114"></a>
<FONT color="green">115</FONT>    <a name="line.115"></a>
<FONT color="green">116</FONT>            if (result == null)<a name="line.116"></a>
<FONT color="green">117</FONT>            {<a name="line.117"></a>
<FONT color="green">118</FONT>                result = new Integer(0);<a name="line.118"></a>
<FONT color="green">119</FONT>            }<a name="line.119"></a>
<FONT color="green">120</FONT>    <a name="line.120"></a>
<FONT color="green">121</FONT>            JassAdditions.post("EOEditingContextAdditions", "countOfObjectsForEntityNamed", result.intValue() &gt;= 0);<a name="line.121"></a>
<FONT color="green">122</FONT>            return result;<a name="line.122"></a>
<FONT color="green">123</FONT>    <a name="line.123"></a>
<FONT color="green">124</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.124"></a>
<FONT color="green">125</FONT>        }<a name="line.125"></a>
<FONT color="green">126</FONT>    <a name="line.126"></a>
<FONT color="green">127</FONT>    <a name="line.127"></a>
<FONT color="green">128</FONT>    <a name="line.128"></a>
<FONT color="green">129</FONT>        /**<a name="line.129"></a>
<FONT color="green">130</FONT>         * Computes aggregate function (min, max, sum, and avg are currently supported) on the attribute named &lt;code&gt;attributeName&lt;/code&gt; on the entity named &lt;code&gt;entityName&lt;/code&gt;, the objects operated on are optionally restricted by &lt;code&gt;qualifer&lt;/code&gt;. The result is returned as the appropriate class. NOTE: there is a bug in the SQL generation facility that this method uses, so if you use a qualifier that qualifies based on a literal, you will have to properly quote and escape the literal &lt;em&gt;before&lt;/em&gt; creating the qualifier (see the example).  Qualifiers used elsewhere seem to work fine...&lt;p&gt;<a name="line.130"></a>
<FONT color="green">131</FONT>         *<a name="line.131"></a>
<FONT color="green">132</FONT>         * Example Usage:&lt;code&gt;&lt;pre&gt;<a name="line.132"></a>
<FONT color="green">133</FONT>         *    EOQualifier unpaidInvoices = EOQualfier.qualifierWithQualifierFormat("isPaid = 'N'", null);<a name="line.133"></a>
<FONT color="green">134</FONT>         *    BigDecimal totalOfUnpaidInvoices = EOEditingContextAdditions.computeAggregateFunction(editingContext, "sum", "grandTotal", "Invoice", unpaidInvoices);<a name="line.134"></a>
<FONT color="green">135</FONT>         * &lt;/pre&gt;&lt;/code&gt;<a name="line.135"></a>
<FONT color="green">136</FONT>         *<a name="line.136"></a>
<FONT color="green">137</FONT>         * @param editingContext the editing context to be used for fetching<a name="line.137"></a>
<FONT color="green">138</FONT>         * @param aggregateFunction the aggregate function to be applied to the attribute<a name="line.138"></a>
<FONT color="green">139</FONT>         * @param attributeName the name of the attibute to be evaluated<a name="line.139"></a>
<FONT color="green">140</FONT>         * @param entityName the name of the attribute's entity<a name="line.140"></a>
<FONT color="green">141</FONT>         * @param qualifier the qualifier to be applied to the fetch<a name="line.141"></a>
<FONT color="green">142</FONT>         * @return the result of the aggregate function, null is returned if there are no matching records in the database<a name="line.142"></a>
<FONT color="green">143</FONT>         */<a name="line.143"></a>
<FONT color="green">144</FONT>        public static Object computeAggregateFunction(EOEditingContext editingContext,<a name="line.144"></a>
<FONT color="green">145</FONT>                                                      String aggregateFunction,<a name="line.145"></a>
<FONT color="green">146</FONT>                                                      String attributeName,<a name="line.146"></a>
<FONT color="green">147</FONT>                                                      String entityName,<a name="line.147"></a>
<FONT color="green">148</FONT>                                                      EOQualifier qualifier)<a name="line.148"></a>
<FONT color="green">149</FONT>         {<a name="line.149"></a>
<FONT color="green">150</FONT>            /** require<a name="line.150"></a>
<FONT color="green">151</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.151"></a>
<FONT color="green">152</FONT>            [valid_aggregateFunction_param] aggregateFunction != null;<a name="line.152"></a>
<FONT color="green">153</FONT>            [valid_entityName_param] entityName != null;<a name="line.153"></a>
<FONT color="green">154</FONT>            [valid_attributeName_param] attributeName != null; **/<a name="line.154"></a>
<FONT color="green">155</FONT>            JassAdditions.pre("EOEditingContextAdditions", "computeAggregateFunction", EOModelGroup.defaultGroup().entityNamed(entityName) != null);<a name="line.155"></a>
<FONT color="green">156</FONT>            JassAdditions.pre("EOEditingContextAdditions", "computeAggregateFunction", EOModelGroup.defaultGroup().entityNamed(entityName).attributeNamed(attributeName) != null);<a name="line.156"></a>
<FONT color="green">157</FONT>            JassAdditions.pre("EOEditingContextAdditions", "computeAggregateFunction", setOfAllAggregateFunctions.containsObject(aggregateFunction));<a name="line.157"></a>
<FONT color="green">158</FONT>    <a name="line.158"></a>
<FONT color="green">159</FONT>            editingContext.rootObjectStore().lock();<a name="line.159"></a>
<FONT color="green">160</FONT>            Object anObject = null;<a name="line.160"></a>
<FONT color="green">161</FONT>            try<a name="line.161"></a>
<FONT color="green">162</FONT>            {<a name="line.162"></a>
<FONT color="green">163</FONT>                EOEntity anEntity = EOModelGroup.defaultGroup().entityNamed(entityName);<a name="line.163"></a>
<FONT color="green">164</FONT>                EOAttribute theAttribute = EOModelGroup.defaultGroup().entityNamed(entityName).attributeNamed(attributeName);<a name="line.164"></a>
<FONT color="green">165</FONT>                EODatabaseContext context = EODatabaseContext.registeredDatabaseContextForModel(anEntity.model(), editingContext);<a name="line.165"></a>
<FONT color="green">166</FONT>                EOAdaptorChannel channel = (context.availableChannel()).adaptorChannel();<a name="line.166"></a>
<FONT color="green">167</FONT>                EOAdaptor adaptor = channel.adaptorContext().adaptor();<a name="line.167"></a>
<FONT color="green">168</FONT>    <a name="line.168"></a>
<FONT color="green">169</FONT>                EOSQLExpression expression = null;<a name="line.169"></a>
<FONT color="green">170</FONT>                try<a name="line.170"></a>
<FONT color="green">171</FONT>                {<a name="line.171"></a>
<FONT color="green">172</FONT>                    Constructor eoConstructor = adaptor.expressionClass().getConstructor(new Class[] {EOEntity.class});<a name="line.172"></a>
<FONT color="green">173</FONT>                    expression = (EOSQLExpression) eoConstructor.newInstance(new Object[] {anEntity});<a name="line.173"></a>
<FONT color="green">174</FONT>                }<a name="line.174"></a>
<FONT color="green">175</FONT>                catch(Exception e)<a name="line.175"></a>
<FONT color="green">176</FONT>                {<a name="line.176"></a>
<FONT color="green">177</FONT>                    //ClassNotFoundException, NoSuchMethodException, InstantiationException, illegalAccessException, InvocationTargetException<a name="line.177"></a>
<FONT color="green">178</FONT>                    System.out.println("Exception thrown: " + e.getMessage());<a name="line.178"></a>
<FONT color="green">179</FONT>                }<a name="line.179"></a>
<FONT color="green">180</FONT>    <a name="line.180"></a>
<FONT color="green">181</FONT>                expression.setUseAliases(true);<a name="line.181"></a>
<FONT color="green">182</FONT>    <a name="line.182"></a>
<FONT color="green">183</FONT>                String selectFunction = aggregateFunction + "(" + expression.sqlStringForAttribute(theAttribute) + ")";<a name="line.183"></a>
<FONT color="green">184</FONT>                String sql;<a name="line.184"></a>
<FONT color="green">185</FONT>    <a name="line.185"></a>
<FONT color="green">186</FONT>                if (qualifier != null)<a name="line.186"></a>
<FONT color="green">187</FONT>                {<a name="line.187"></a>
<FONT color="green">188</FONT>                    String whereClause = EOSQLExpressionAdditions.sqlStringForQualifier(expression, qualifier);<a name="line.188"></a>
<FONT color="green">189</FONT>    <a name="line.189"></a>
<FONT color="green">190</FONT>                    expression.joinExpression();<a name="line.190"></a>
<FONT color="green">191</FONT>    <a name="line.191"></a>
<FONT color="green">192</FONT>                    if (expression.joinClauseString().length() &gt; 0)<a name="line.192"></a>
<FONT color="green">193</FONT>                    {<a name="line.193"></a>
<FONT color="green">194</FONT>                        whereClause = "(" + expression.joinClauseString() + ") AND " + whereClause;<a name="line.194"></a>
<FONT color="green">195</FONT>                    }<a name="line.195"></a>
<FONT color="green">196</FONT>                    sql = "SELECT " + selectFunction + " FROM " + expression.tableListWithRootEntity(anEntity) + " WHERE " + whereClause;<a name="line.196"></a>
<FONT color="green">197</FONT>                }<a name="line.197"></a>
<FONT color="green">198</FONT>                else<a name="line.198"></a>
<FONT color="green">199</FONT>                {<a name="line.199"></a>
<FONT color="green">200</FONT>                    sql = "SELECT " + selectFunction + " FROM " + expression.tableListWithRootEntity(anEntity);<a name="line.200"></a>
<FONT color="green">201</FONT>                }<a name="line.201"></a>
<FONT color="green">202</FONT>    <a name="line.202"></a>
<FONT color="green">203</FONT>                expression.setStatement(sql);<a name="line.203"></a>
<FONT color="green">204</FONT>    <a name="line.204"></a>
<FONT color="green">205</FONT>                anObject = EOAdaptorChannelAdditions.resultOfEvaluatingSQLExpression(channel, expression);<a name="line.205"></a>
<FONT color="green">206</FONT>            }<a name="line.206"></a>
<FONT color="green">207</FONT>            finally<a name="line.207"></a>
<FONT color="green">208</FONT>            {<a name="line.208"></a>
<FONT color="green">209</FONT>                editingContext.rootObjectStore().unlock();<a name="line.209"></a>
<FONT color="green">210</FONT>            }<a name="line.210"></a>
<FONT color="green">211</FONT>    <a name="line.211"></a>
<FONT color="green">212</FONT>            return anObject;<a name="line.212"></a>
<FONT color="green">213</FONT>        }<a name="line.213"></a>
<FONT color="green">214</FONT>    <a name="line.214"></a>
<FONT color="green">215</FONT>    <a name="line.215"></a>
<FONT color="green">216</FONT>    <a name="line.216"></a>
<FONT color="green">217</FONT>        /**<a name="line.217"></a>
<FONT color="green">218</FONT>         * Fetches and returns the enterprise objects retrieved with the specified qualifier using the specified editing context. If qualifier is null, it will return all the objects.<a name="line.218"></a>
<FONT color="green">219</FONT>         *<a name="line.219"></a>
<FONT color="green">220</FONT>         * @param editingContext the editingContext to be used for fetching<a name="line.220"></a>
<FONT color="green">221</FONT>         * @param entityName the name of the entity to be qualified<a name="line.221"></a>
<FONT color="green">222</FONT>         * @param qualifier the qualifier to be used in the fetch<a name="line.222"></a>
<FONT color="green">223</FONT>         * @return an array of enterprise objects<a name="line.223"></a>
<FONT color="green">224</FONT>         */<a name="line.224"></a>
<FONT color="green">225</FONT>        public static NSArray objectsWithQualifier(EOEditingContext editingContext,<a name="line.225"></a>
<FONT color="green">226</FONT>                                                   String entityName,<a name="line.226"></a>
<FONT color="green">227</FONT>                                                   EOQualifier qualifier)<a name="line.227"></a>
<FONT color="green">228</FONT>        {<a name="line.228"></a>
<FONT color="green">229</FONT>            /** require<a name="line.229"></a>
<FONT color="green">230</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.230"></a>
<FONT color="green">231</FONT>            [valid_entityName_param] entityName != null; **/<a name="line.231"></a>
<FONT color="green">232</FONT>    <a name="line.232"></a>
<FONT color="green">233</FONT>            EOFetchSpecification fetchSpec = new EOFetchSpecification (entityName,<a name="line.233"></a>
<FONT color="green">234</FONT>                                                                       qualifier,<a name="line.234"></a>
<FONT color="green">235</FONT>                                                                       null);<a name="line.235"></a>
<FONT color="green">236</FONT>            return editingContext.objectsWithFetchSpecification(fetchSpec);<a name="line.236"></a>
<FONT color="green">237</FONT>    <a name="line.237"></a>
<FONT color="green">238</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.238"></a>
<FONT color="green">239</FONT>        }<a name="line.239"></a>
<FONT color="green">240</FONT>    <a name="line.240"></a>
<FONT color="green">241</FONT>    <a name="line.241"></a>
<FONT color="green">242</FONT>    <a name="line.242"></a>
<FONT color="green">243</FONT>        /**<a name="line.243"></a>
<FONT color="green">244</FONT>         * Fetches and returns the enterprise objects retrieved with the specified qualifier using the specified editing context. If qualifier is null, it will return all the objects.<a name="line.244"></a>
<FONT color="green">245</FONT>         *<a name="line.245"></a>
<FONT color="green">246</FONT>         * @param editingContext the editingContext to be used for fetching<a name="line.246"></a>
<FONT color="green">247</FONT>         * @param entityName the name of the entity to be qualified<a name="line.247"></a>
<FONT color="green">248</FONT>         * @param qualifier the qualifier to be used in the fetch<a name="line.248"></a>
<FONT color="green">249</FONT>         * @return an array of enterprise objects<a name="line.249"></a>
<FONT color="green">250</FONT>         */<a name="line.250"></a>
<FONT color="green">251</FONT>        public static int countOfObjectsWithQualifier(EOEditingContext editingContext,<a name="line.251"></a>
<FONT color="green">252</FONT>                                                      String entityName,<a name="line.252"></a>
<FONT color="green">253</FONT>                                                      EOQualifier qualifier)<a name="line.253"></a>
<FONT color="green">254</FONT>        {<a name="line.254"></a>
<FONT color="green">255</FONT>            /** require<a name="line.255"></a>
<FONT color="green">256</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.256"></a>
<FONT color="green">257</FONT>            [valid_entityName_param] entityName != null; **/<a name="line.257"></a>
<FONT color="green">258</FONT>    <a name="line.258"></a>
<FONT color="green">259</FONT>            NSArray objects = EOEditingContextAdditions.objectsWithQualifier(editingContext,<a name="line.259"></a>
<FONT color="green">260</FONT>                                                                             entityName,<a name="line.260"></a>
<FONT color="green">261</FONT>                                                                             qualifier);<a name="line.261"></a>
<FONT color="green">262</FONT>    <a name="line.262"></a>
<FONT color="green">263</FONT>            return objects.count();<a name="line.263"></a>
<FONT color="green">264</FONT>    <a name="line.264"></a>
<FONT color="green">265</FONT>            /** ensure [valid_result] Result &gt;= 0; **/<a name="line.265"></a>
<FONT color="green">266</FONT>        }<a name="line.266"></a>
<FONT color="green">267</FONT>    <a name="line.267"></a>
<FONT color="green">268</FONT>    <a name="line.268"></a>
<FONT color="green">269</FONT>    <a name="line.269"></a>
<FONT color="green">270</FONT>        /**<a name="line.270"></a>
<FONT color="green">271</FONT>         * Returns an array of all the objects of the named entitiy, sorted on the named attribute, with the sort determined by selector.  Selector will most commonly be one of CompareAscending, CompareDescending, CompareCaseInsensitiveAscending, CompareCaseInsensitiveDescending.  See EOSortOrdering for more details.<a name="line.271"></a>
<FONT color="green">272</FONT>         *<a name="line.272"></a>
<FONT color="green">273</FONT>         * @param editingContext the editingContext to be used for fetching<a name="line.273"></a>
<FONT color="green">274</FONT>         * @param entityName the entityName of the objects to fetch<a name="line.274"></a>
<FONT color="green">275</FONT>         * @param attributeName the name of the attribute to be sorted<a name="line.275"></a>
<FONT color="green">276</FONT>         * @param selector the selector to be used for sorting<a name="line.276"></a>
<FONT color="green">277</FONT>         * @return an array of objects<a name="line.277"></a>
<FONT color="green">278</FONT>         */<a name="line.278"></a>
<FONT color="green">279</FONT>        public static NSArray orderedObjects(EOEditingContext editingContext,<a name="line.279"></a>
<FONT color="green">280</FONT>                                             String entityName,<a name="line.280"></a>
<FONT color="green">281</FONT>                                             String attributeName,<a name="line.281"></a>
<FONT color="green">282</FONT>                                             NSSelector selector)    <a name="line.282"></a>
<FONT color="green">283</FONT>        {<a name="line.283"></a>
<FONT color="green">284</FONT>            /** require<a name="line.284"></a>
<FONT color="green">285</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.285"></a>
<FONT color="green">286</FONT>            [valid_entityName_param] entityName != null;<a name="line.286"></a>
<FONT color="green">287</FONT>            [valid_attributeName_param] attributeName != null;<a name="line.287"></a>
<FONT color="green">288</FONT>            [valid_selector_param] selector != null; **/<a name="line.288"></a>
<FONT color="green">289</FONT>            JassAdditions.pre("EOEditingContextAdditions", "orderedObjects", EOModelGroup.defaultGroup().entityNamed(entityName) != null);<a name="line.289"></a>
<FONT color="green">290</FONT>    <a name="line.290"></a>
<FONT color="green">291</FONT>            NSArray ordering = new NSArray(new EOSortOrdering(attributeName, selector));<a name="line.291"></a>
<FONT color="green">292</FONT>    <a name="line.292"></a>
<FONT color="green">293</FONT>            EOFetchSpecification fetchSpec = new EOFetchSpecification(entityName,<a name="line.293"></a>
<FONT color="green">294</FONT>                                                                      null,<a name="line.294"></a>
<FONT color="green">295</FONT>                                                                      ordering);<a name="line.295"></a>
<FONT color="green">296</FONT>    <a name="line.296"></a>
<FONT color="green">297</FONT>            return editingContext.objectsWithFetchSpecification(fetchSpec);<a name="line.297"></a>
<FONT color="green">298</FONT>    <a name="line.298"></a>
<FONT color="green">299</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.299"></a>
<FONT color="green">300</FONT>        }<a name="line.300"></a>
<FONT color="green">301</FONT>    <a name="line.301"></a>
<FONT color="green">302</FONT>    <a name="line.302"></a>
<FONT color="green">303</FONT>    <a name="line.303"></a>
<FONT color="green">304</FONT>        /**<a name="line.304"></a>
<FONT color="green">305</FONT>         * Returns an array of the objects of the named entitiy, which have aKey = aValue, sorted on the named attribute, with the sort determined by selector.  Selector will most commonly be one of EOCompareAscending, EOCompareDescending, EOCompareCaseInsensitiveAscending, EOCompareCaseInsensitiveDescending.  See EOSortOrdering for more details.<a name="line.305"></a>
<FONT color="green">306</FONT>         *<a name="line.306"></a>
<FONT color="green">307</FONT>         * @param editingContext the editing context to be used for the fetch<a name="line.307"></a>
<FONT color="green">308</FONT>         * @param aValue the value of the key to match<a name="line.308"></a>
<FONT color="green">309</FONT>         * @param aKey the key to match<a name="line.309"></a>
<FONT color="green">310</FONT>         * @param entityName the entity name of the objects to fetch<a name="line.310"></a>
<FONT color="green">311</FONT>         * @param attributeName the attribute name to which the ordering will be applied<a name="line.311"></a>
<FONT color="green">312</FONT>         * @param selector the selector to be used for the ordering of the resulting array<a name="line.312"></a>
<FONT color="green">313</FONT>         * @return an array of objects <a name="line.313"></a>
<FONT color="green">314</FONT>         */<a name="line.314"></a>
<FONT color="green">315</FONT>        public static NSArray objectsMatchingValue(EOEditingContext editingContext,<a name="line.315"></a>
<FONT color="green">316</FONT>                                                   Object aValue,<a name="line.316"></a>
<FONT color="green">317</FONT>                                                   String aKey,<a name="line.317"></a>
<FONT color="green">318</FONT>                                                   String entityName,<a name="line.318"></a>
<FONT color="green">319</FONT>                                                   String attributeName,<a name="line.319"></a>
<FONT color="green">320</FONT>                                                   NSSelector selector)<a name="line.320"></a>
<FONT color="green">321</FONT>        {<a name="line.321"></a>
<FONT color="green">322</FONT>            /** require<a name="line.322"></a>
<FONT color="green">323</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.323"></a>
<FONT color="green">324</FONT>            [valid_aKey_param] aKey != null;<a name="line.324"></a>
<FONT color="green">325</FONT>            [valid_entityName_param] entityName != null;<a name="line.325"></a>
<FONT color="green">326</FONT>            [valid_attributeName_param] attributeName != null;<a name="line.326"></a>
<FONT color="green">327</FONT>            [valid_selector_param] selector != null; **/<a name="line.327"></a>
<FONT color="green">328</FONT>            JassAdditions.pre("EOEditingContextAdditions", "objectsMatchingValue", EOModelGroup.defaultGroup().entityNamed(entityName) != null);<a name="line.328"></a>
<FONT color="green">329</FONT>            JassAdditions.pre("EOEditingContextAdditions", "objectsMatchingValue", EOModelGroup.defaultGroup().entityNamed(entityName).attributeNamed(attributeName) != null);<a name="line.329"></a>
<FONT color="green">330</FONT>    <a name="line.330"></a>
<FONT color="green">331</FONT>            EOQualifier qualifier = new EOKeyValueQualifier(aKey,<a name="line.331"></a>
<FONT color="green">332</FONT>                                                            EOQualifier.QualifierOperatorEqual,<a name="line.332"></a>
<FONT color="green">333</FONT>                                                            aValue);<a name="line.333"></a>
<FONT color="green">334</FONT>            NSArray ordering = new NSArray (new EOSortOrdering(attributeName, selector));<a name="line.334"></a>
<FONT color="green">335</FONT>            EOFetchSpecification fetchSpec = new EOFetchSpecification (entityName,<a name="line.335"></a>
<FONT color="green">336</FONT>                                                                       qualifier,<a name="line.336"></a>
<FONT color="green">337</FONT>                                                                       ordering);<a name="line.337"></a>
<FONT color="green">338</FONT>    <a name="line.338"></a>
<FONT color="green">339</FONT>            return editingContext.objectsWithFetchSpecification(fetchSpec);<a name="line.339"></a>
<FONT color="green">340</FONT>    <a name="line.340"></a>
<FONT color="green">341</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.341"></a>
<FONT color="green">342</FONT>        }<a name="line.342"></a>
<FONT color="green">343</FONT>    <a name="line.343"></a>
<FONT color="green">344</FONT>    <a name="line.344"></a>
<FONT color="green">345</FONT>    <a name="line.345"></a>
<FONT color="green">346</FONT>        /**<a name="line.346"></a>
<FONT color="green">347</FONT>         * Returns an array of the objects identified by the EOGlobalIDs in &lt;code&gt;globalIDs&lt;/code&gt;, or raises RuntimeException if no object has been registered in the EOEditingContext with one of the global IDs.<a name="line.347"></a>
<FONT color="green">348</FONT>         *<a name="line.348"></a>
<FONT color="green">349</FONT>         * @param editingContext the editingContext to be used for identifying the objects<a name="line.349"></a>
<FONT color="green">350</FONT>         * @param globalIDs the array of globalIDs to look for<a name="line.350"></a>
<FONT color="green">351</FONT>         * @return an array of objects<a name="line.351"></a>
<FONT color="green">352</FONT>         * @exception RuntimeException if no object has been registered in the &lt;code&gt;EOEditingContext&lt;/code&gt; with one of the global IDs<a name="line.352"></a>
<FONT color="green">353</FONT>         */<a name="line.353"></a>
<FONT color="green">354</FONT>        public static NSArray objectsForGlobalIDs(EOEditingContext editingContext,<a name="line.354"></a>
<FONT color="green">355</FONT>                                                  NSArray globalIDs)<a name="line.355"></a>
<FONT color="green">356</FONT>        {<a name="line.356"></a>
<FONT color="green">357</FONT>            /** require<a name="line.357"></a>
<FONT color="green">358</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.358"></a>
<FONT color="green">359</FONT>            [valid_globalIDs_param] globalIDs != null; **/<a name="line.359"></a>
<FONT color="green">360</FONT>    <a name="line.360"></a>
<FONT color="green">361</FONT>            NSMutableArray objects = new NSMutableArray();<a name="line.361"></a>
<FONT color="green">362</FONT>    <a name="line.362"></a>
<FONT color="green">363</FONT>            Enumeration globalIDEnumerator = globalIDs.objectEnumerator();<a name="line.363"></a>
<FONT color="green">364</FONT>            while(globalIDEnumerator.hasMoreElements())<a name="line.364"></a>
<FONT color="green">365</FONT>            {<a name="line.365"></a>
<FONT color="green">366</FONT>                EOGlobalID globalID = (EOGlobalID) globalIDEnumerator.nextElement();<a name="line.366"></a>
<FONT color="green">367</FONT>    <a name="line.367"></a>
<FONT color="green">368</FONT>                Object localObject = editingContext.objectForGlobalID(globalID);<a name="line.368"></a>
<FONT color="green">369</FONT>    <a name="line.369"></a>
<FONT color="green">370</FONT>                if (localObject == null)<a name="line.370"></a>
<FONT color="green">371</FONT>                {<a name="line.371"></a>
<FONT color="green">372</FONT>                    throw new RuntimeException("There is no object for GlobalID " + globalID +<a name="line.372"></a>
<FONT color="green">373</FONT>                                               " in editing context " + editingContext);<a name="line.373"></a>
<FONT color="green">374</FONT>                }<a name="line.374"></a>
<FONT color="green">375</FONT>                objects.addObject(localObject);<a name="line.375"></a>
<FONT color="green">376</FONT>            }<a name="line.376"></a>
<FONT color="green">377</FONT>    <a name="line.377"></a>
<FONT color="green">378</FONT>            JassAdditions.post("EOEditingContextAdditions", "objectsForGlobalIDs", objects.count() == globalIDs.count());<a name="line.378"></a>
<FONT color="green">379</FONT>            return objects;<a name="line.379"></a>
<FONT color="green">380</FONT>    <a name="line.380"></a>
<FONT color="green">381</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.381"></a>
<FONT color="green">382</FONT>        }<a name="line.382"></a>
<FONT color="green">383</FONT>    <a name="line.383"></a>
<FONT color="green">384</FONT>    <a name="line.384"></a>
<FONT color="green">385</FONT>    <a name="line.385"></a>
<FONT color="green">386</FONT>        /**<a name="line.386"></a>
<FONT color="green">387</FONT>         * Returns an array of the EOGlobalIDs identifying the EOEnterpriseObjects in &lt;code&gt;eoObjects&lt;/code&gt;, or raises RuntimeException if one of the objects has not been registered in &lt;code&gt;editingContext&lt;/code&gt;.<a name="line.387"></a>
<FONT color="green">388</FONT>         *<a name="line.388"></a>
<FONT color="green">389</FONT>         * @param editingContext the editingContext to be used for identifying the objects<a name="line.389"></a>
<FONT color="green">390</FONT>         * @param eoObjects the array of EOEnterpriseObjects to look for<a name="line.390"></a>
<FONT color="green">391</FONT>         * @return an array of EOGlobalIDs<a name="line.391"></a>
<FONT color="green">392</FONT>         * @exception RuntimeException one of the objects has not been registered in &lt;code&gt;editingContext&lt;/code&gt;<a name="line.392"></a>
<FONT color="green">393</FONT>         */<a name="line.393"></a>
<FONT color="green">394</FONT>        public static NSArray globalIDsForObjects(EOEditingContext editingContext,<a name="line.394"></a>
<FONT color="green">395</FONT>                                                  NSArray eoObjects)<a name="line.395"></a>
<FONT color="green">396</FONT>        {<a name="line.396"></a>
<FONT color="green">397</FONT>            /** require<a name="line.397"></a>
<FONT color="green">398</FONT>            [valid_editingContext_param] editingContext != null;<a name="line.398"></a>
<FONT color="green">399</FONT>            [valid_globalIDs_param] eoObjects != null; **/<a name="line.399"></a>
<FONT color="green">400</FONT>    <a name="line.400"></a>
<FONT color="green">401</FONT>            NSMutableArray globalIDs = new NSMutableArray();<a name="line.401"></a>
<FONT color="green">402</FONT>    <a name="line.402"></a>
<FONT color="green">403</FONT>            Enumeration eoObjectEnumerator = eoObjects.objectEnumerator();<a name="line.403"></a>
<FONT color="green">404</FONT>            while(eoObjectEnumerator.hasMoreElements())<a name="line.404"></a>
<FONT color="green">405</FONT>            {<a name="line.405"></a>
<FONT color="green">406</FONT>                EOEnterpriseObject eoObject = (EOEnterpriseObject) eoObjectEnumerator.nextElement();<a name="line.406"></a>
<FONT color="green">407</FONT>    <a name="line.407"></a>
<FONT color="green">408</FONT>                EOGlobalID globalID = editingContext.globalIDForObject(eoObject);<a name="line.408"></a>
<FONT color="green">409</FONT>    <a name="line.409"></a>
<FONT color="green">410</FONT>                if (globalID == null)<a name="line.410"></a>
<FONT color="green">411</FONT>                {<a name="line.411"></a>
<FONT color="green">412</FONT>                    throw new RuntimeException("There is no object " + eoObject +<a name="line.412"></a>
<FONT color="green">413</FONT>                                               " registered in editing context " + editingContext);<a name="line.413"></a>
<FONT color="green">414</FONT>                }<a name="line.414"></a>
<FONT color="green">415</FONT>                globalIDs.addObject(globalID);<a name="line.415"></a>
<FONT color="green">416</FONT>            }<a name="line.416"></a>
<FONT color="green">417</FONT>    <a name="line.417"></a>
<FONT color="green">418</FONT>            JassAdditions.post("EOEditingContextAdditions", "objectsForGlobalIDs", eoObjects.count() == globalIDs.count());<a name="line.418"></a>
<FONT color="green">419</FONT>            return globalIDs;<a name="line.419"></a>
<FONT color="green">420</FONT>    <a name="line.420"></a>
<FONT color="green">421</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.421"></a>
<FONT color="green">422</FONT>        }<a name="line.422"></a>
<FONT color="green">423</FONT>    <a name="line.423"></a>
<FONT color="green">424</FONT>    <a name="line.424"></a>
<FONT color="green">425</FONT>    <a name="line.425"></a>
<FONT color="green">426</FONT>        /**<a name="line.426"></a>
<FONT color="green">427</FONT>         * Returns the resulting BigDecimal value after evaluating the specified SQL for entityName.  Returns 0 if the SQL evaluates to null.  Note that this method should only be used for SQL returning one and only one BigDecimal value. This is very useful when using aggregate functions, ie sum, avg, min, max, etc.  <a name="line.427"></a>
<FONT color="green">428</FONT>         *<a name="line.428"></a>
<FONT color="green">429</FONT>         * @return the value of the of the passed sql.<a name="line.429"></a>
<FONT color="green">430</FONT>         */<a name="line.430"></a>
<FONT color="green">431</FONT>        public static BigDecimal valueForAggregateSQL(EOEditingContext ec, String entityName, String sqlString)<a name="line.431"></a>
<FONT color="green">432</FONT>        {<a name="line.432"></a>
<FONT color="green">433</FONT>            /** require<a name="line.433"></a>
<FONT color="green">434</FONT>            [entityName_not_null] entityName != null;<a name="line.434"></a>
<FONT color="green">435</FONT>            [sqlString_not_null] sqlString != null;<a name="line.435"></a>
<FONT color="green">436</FONT>            [ec_not_null] ec != null;<a name="line.436"></a>
<FONT color="green">437</FONT>            **/<a name="line.437"></a>
<FONT color="green">438</FONT>            <a name="line.438"></a>
<FONT color="green">439</FONT>            EOEntity entity = EOUtilities.entityNamed(ec, entityName);<a name="line.439"></a>
<FONT color="green">440</FONT>            String modelName = entity.model().name();<a name="line.440"></a>
<FONT color="green">441</FONT>    <a name="line.441"></a>
<FONT color="green">442</FONT>            NSArray resultSet = EOUtilities.rawRowsForSQL(ec, modelName, sqlString, null);<a name="line.442"></a>
<FONT color="green">443</FONT>    <a name="line.443"></a>
<FONT color="green">444</FONT>            //Get the corresponding value from the resulting Dictionary<a name="line.444"></a>
<FONT color="green">445</FONT>            NSDictionary firstRow = (NSDictionary)resultSet.objectAtIndex(0);<a name="line.445"></a>
<FONT color="green">446</FONT>            String firstColumnKey = (String)firstRow.allKeys().objectAtIndex(0);<a name="line.446"></a>
<FONT color="green">447</FONT>    <a name="line.447"></a>
<FONT color="green">448</FONT>            BigDecimal value;<a name="line.448"></a>
<FONT color="green">449</FONT>            if (firstRow.objectForKey(firstColumnKey) != NSKeyValueCoding.NullValue)<a name="line.449"></a>
<FONT color="green">450</FONT>            {<a name="line.450"></a>
<FONT color="green">451</FONT>                value = new BigDecimal(((java.lang.Double) firstRow.objectForKey(firstColumnKey)).doubleValue());<a name="line.451"></a>
<FONT color="green">452</FONT>            }<a name="line.452"></a>
<FONT color="green">453</FONT>            else<a name="line.453"></a>
<FONT color="green">454</FONT>            {<a name="line.454"></a>
<FONT color="green">455</FONT>                value = new BigDecimal("0");<a name="line.455"></a>
<FONT color="green">456</FONT>            }<a name="line.456"></a>
<FONT color="green">457</FONT>    <a name="line.457"></a>
<FONT color="green">458</FONT>            return value;<a name="line.458"></a>
<FONT color="green">459</FONT>            <a name="line.459"></a>
<FONT color="green">460</FONT>            /** ensure [Result_not_null] Result != null; **/<a name="line.460"></a>
<FONT color="green">461</FONT>        }<a name="line.461"></a>
<FONT color="green">462</FONT>    <a name="line.462"></a>
<FONT color="green">463</FONT>    <a name="line.463"></a>
<FONT color="green">464</FONT>        <a name="line.464"></a>
<FONT color="green">465</FONT>        /**<a name="line.465"></a>
<FONT color="green">466</FONT>         * A convenience method for returning the primary key of an Object with the passed key.<a name="line.466"></a>
<FONT color="green">467</FONT>         *<a name="line.467"></a>
<FONT color="green">468</FONT>         * @return primary key of this Object with the passed key.<a name="line.468"></a>
<FONT color="green">469</FONT>         */<a name="line.469"></a>
<FONT color="green">470</FONT>        public static Object primaryKey(EOEditingContext ec, EOEnterpriseObject theObject, String theKey)<a name="line.470"></a>
<FONT color="green">471</FONT>        {<a name="line.471"></a>
<FONT color="green">472</FONT>            /** require<a name="line.472"></a>
<FONT color="green">473</FONT>            [valid_param] ec != null;<a name="line.473"></a>
<FONT color="green">474</FONT>            [valid_param] theObject != null;<a name="line.474"></a>
<FONT color="green">475</FONT>            [valid_param] theKey != null;<a name="line.475"></a>
<FONT color="green">476</FONT>            **/<a name="line.476"></a>
<FONT color="green">477</FONT>            Object result = null;<a name="line.477"></a>
<FONT color="green">478</FONT>            <a name="line.478"></a>
<FONT color="green">479</FONT>            NSDictionary primaryKeyDictionary = EOUtilities.primaryKeyForObject(ec, theObject);<a name="line.479"></a>
<FONT color="green">480</FONT>            if (primaryKeyDictionary != null)<a name="line.480"></a>
<FONT color="green">481</FONT>            {<a name="line.481"></a>
<FONT color="green">482</FONT>                result = primaryKeyDictionary.objectForKey(theKey);<a name="line.482"></a>
<FONT color="green">483</FONT>            }<a name="line.483"></a>
<FONT color="green">484</FONT>            <a name="line.484"></a>
<FONT color="green">485</FONT>            JassAdditions.post("EOEditingContextAdditions",<a name="line.485"></a>
<FONT color="green">486</FONT>                               "primaryKey",<a name="line.486"></a>
<FONT color="green">487</FONT>                               (result != null) || (theObject.editingContext().globalIDForObject(theObject).isTemporary() &amp;&amp; (result == null)));<a name="line.487"></a>
<FONT color="green">488</FONT>    <a name="line.488"></a>
<FONT color="green">489</FONT>            return result;<a name="line.489"></a>
<FONT color="green">490</FONT>        }<a name="line.490"></a>
<FONT color="green">491</FONT>    }<a name="line.491"></a>




























































</PRE>
</BODY>
</HTML>
