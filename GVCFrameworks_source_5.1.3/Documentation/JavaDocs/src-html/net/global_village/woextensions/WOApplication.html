<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    package net.global_village.woextensions;<a name="line.1"></a>
<FONT color="green">002</FONT>    <a name="line.2"></a>
<FONT color="green">003</FONT>    import java.lang.reflect.*;<a name="line.3"></a>
<FONT color="green">004</FONT>    import java.net.*;<a name="line.4"></a>
<FONT color="green">005</FONT>    import java.util.*;<a name="line.5"></a>
<FONT color="green">006</FONT>    <a name="line.6"></a>
<FONT color="green">007</FONT>    import ognl.webobjects.*;<a name="line.7"></a>
<FONT color="green">008</FONT>    <a name="line.8"></a>
<FONT color="green">009</FONT>    import org.apache.log4j.*;<a name="line.9"></a>
<FONT color="green">010</FONT>    import org.apache.log4j.xml.*;<a name="line.10"></a>
<FONT color="green">011</FONT>    <a name="line.11"></a>
<FONT color="green">012</FONT>    import com.webobjects.appserver.*;<a name="line.12"></a>
<FONT color="green">013</FONT>    import com.webobjects.appserver.WOComponent;<a name="line.13"></a>
<FONT color="green">014</FONT>    import com.webobjects.eoaccess.*;<a name="line.14"></a>
<FONT color="green">015</FONT>    import com.webobjects.eocontrol.*;<a name="line.15"></a>
<FONT color="green">016</FONT>    import com.webobjects.foundation.*;<a name="line.16"></a>
<FONT color="green">017</FONT>    <a name="line.17"></a>
<FONT color="green">018</FONT>    import er.ajax.*;<a name="line.18"></a>
<FONT color="green">019</FONT>    import er.extensions.appserver.*;<a name="line.19"></a>
<FONT color="green">020</FONT>    import er.extensions.appserver.ajax.*;<a name="line.20"></a>
<FONT color="green">021</FONT>    import er.extensions.components._private.*;<a name="line.21"></a>
<FONT color="green">022</FONT>    import er.extensions.eof.*;<a name="line.22"></a>
<FONT color="green">023</FONT>    import er.extensions.foundation.*;<a name="line.23"></a>
<FONT color="green">024</FONT>    import er.extensions.jdbc.*;<a name="line.24"></a>
<FONT color="green">025</FONT>    import er.extensions.logging.*;<a name="line.25"></a>
<FONT color="green">026</FONT>    import er.extensions.migration.*;<a name="line.26"></a>
<FONT color="green">027</FONT>    <a name="line.27"></a>
<FONT color="green">028</FONT>    import net.global_village.eofextensions.*;<a name="line.28"></a>
<FONT color="green">029</FONT>    import net.global_village.foundation.*;<a name="line.29"></a>
<FONT color="green">030</FONT>    import net.global_village.jmail.*;<a name="line.30"></a>
<FONT color="green">031</FONT>    <a name="line.31"></a>
<FONT color="green">032</FONT>    <a name="line.32"></a>
<FONT color="green">033</FONT>    /**<a name="line.33"></a>
<FONT color="green">034</FONT>     * &lt;p&gt;A collection of extensions for WOApplication. Your Application class should sub-class this class. &lt;br&gt;<a name="line.34"></a>
<FONT color="green">035</FONT>     * Note that this class uses the property lists extensively. You must ensure that the keys exist and contain valid data if you wish to use GVC's WOApplication.  See documentation for loadConfigurationInfo() on how to specify additional property lists. &lt;br&gt;<a name="line.35"></a>
<FONT color="green">036</FONT>     * &lt;b&gt;A typical project will set the following keys:&lt;/b&gt;&lt;br&gt;<a name="line.36"></a>
<FONT color="green">037</FONT>     * &lt;ul&gt;<a name="line.37"></a>
<FONT color="green">038</FONT>     * &lt;li&gt; WOAdaptorURL (&lt;b&gt;Required&lt;/b&gt;) - returns the URL for the web server including the path to the WebObjects CGI adaptor (eg. http://localhost/cgi-bin/WebObjects).&lt;/li&gt;<a name="line.38"></a>
<FONT color="green">039</FONT>     * &lt;li&gt; SMTPHost (&lt;b&gt;Deprecated&lt;/b&gt;  use mail.smtp.host in Properties) - name of the host that will be used to send email messages. (eg. mail.global-village.net)&lt;/li&gt;<a name="line.39"></a>
<FONT color="green">040</FONT>     * &lt;li&gt; PageCacheSize - size of the internal cache for page instances. The default is 30 instances.&lt;/li&gt;<a name="line.40"></a>
<FONT color="green">041</FONT>     * &lt;li&gt; PermanentPageCacheSize - size of the internal cache for permanent page instances. The default is 10 instances.&lt;/li&gt;<a name="line.41"></a>
<FONT color="green">042</FONT>     * &lt;li&gt; CachingEnabled - returns whether or not component caching is enabled. The default is true.&lt;/li&gt;<a name="line.42"></a>
<FONT color="green">043</FONT>     * &lt;li&gt; SessionTimeoutInMinutes - the number of seconds which will be used as the default timeout for each newly created session.&lt;/li&gt;<a name="line.43"></a>
<FONT color="green">044</FONT>     * &lt;li&gt; DateFormat - the format to be used for displaying dates. (eg. "%b %d %Y")&lt;/li&gt;<a name="line.44"></a>
<FONT color="green">045</FONT>     * &lt;li&gt; NumberFormat - the format to be used for displaying numbers (eg. "##.####,0;(##.####)")&lt;/li&gt;<a name="line.45"></a>
<FONT color="green">046</FONT>     * &lt;li&gt; ApplicationsEmailAddress - Should be the complete e-mail address representing the application. This is used as the from address for all e-mail sent to the supportAddress.&lt;/li&gt;<a name="line.46"></a>
<FONT color="green">047</FONT>     * &lt;li&gt; SupportsEmailAddress - Should be the complete e-mail address of whoever is doing technical support for the application.  Application error messages go here.  For support messages to be sent, it requires Application.email.applicationsEmailAddress to be supplied.&lt;/li&gt;<a name="line.47"></a>
<FONT color="green">048</FONT>     * &lt;li&gt; JDBCUrl - the URL to be used by all the EOModels when connecting to the database.&lt;/li&gt;<a name="line.48"></a>
<FONT color="green">049</FONT>     * &lt;/ul&gt;<a name="line.49"></a>
<FONT color="green">050</FONT>     *  To use the functionality available you may want to set the following page name defaults in your property list:<a name="line.50"></a>
<FONT color="green">051</FONT>     * &lt;ul&gt;<a name="line.51"></a>
<FONT color="green">052</FONT>     *   &lt;li&gt; &lt;code&gt;DefaultPageName&lt;/code&gt; -  (&lt;b&gt;Required&lt;/b&gt;)The name of the page to be shown when the requested page can not be shown.&lt;/li&gt;<a name="line.52"></a>
<FONT color="green">053</FONT>     *   &lt;li&gt; &lt;code&gt;ExceptionPageName&lt;/code&gt; - The name of the page to display when an exception occurs. The DefaultPageName is used if not specified. Note that if specified, the page should implement the ExceptionPage interface as defined in GVCJWOExtensions. &lt;/li&gt;<a name="line.53"></a>
<FONT color="green">054</FONT>     *   &lt;li&gt; &lt;code&gt;PageRestorationErrorPageName&lt;/code&gt; - The name of the page to display when the page cannot be restored (A user has clicked 'back' past the page cache). The DefaultPageName is used if not specified.&lt;/li&gt;<a name="line.54"></a>
<FONT color="green">055</FONT>     *   &lt;li&gt; &lt;code&gt;SessionCreationErrorPageName&lt;/code&gt; - The name of the page to display when an exception occurs while creating a session. The DefaultPageName is used if not specified.&lt;/li&gt;<a name="line.55"></a>
<FONT color="green">056</FONT>     *   &lt;li&gt; &lt;code&gt;SessionRestorationErrorPageName&lt;/code&gt; - The name of the page to display when a session cannot be restored (A user's session has timed out). The DefaultPageName is used if not specified.&lt;/li&gt;<a name="line.56"></a>
<FONT color="green">057</FONT>     *   &lt;li&gt; &lt;code&gt;PageMapFileName&lt;/code&gt; - Maps existing WOComponents to other WOComponents that will be used at run time.&lt;/li&gt;<a name="line.57"></a>
<FONT color="green">058</FONT>     * &lt;/ul&gt;<a name="line.58"></a>
<FONT color="green">059</FONT>     * &lt;p&gt;Note also that pageWithName has been overridden and your components may need to implement various methods to work as desired (SSL, page security, etc). See that method for documentation.&lt;/p&gt;<a name="line.59"></a>
<FONT color="green">060</FONT>     *<a name="line.60"></a>
<FONT color="green">061</FONT>     * @author Copyright (c) 2001-2005  Global Village Consulting, Inc.  All rights reserved.<a name="line.61"></a>
<FONT color="green">062</FONT>     * This software is published under the terms of the Educational Community License (ECL) version 1.0,<a name="line.62"></a>
<FONT color="green">063</FONT>     * a copy of which has been included with this distribution in the LICENSE.TXT file.<a name="line.63"></a>
<FONT color="green">064</FONT>     * @version $Revision: 51$<a name="line.64"></a>
<FONT color="green">065</FONT>     */<a name="line.65"></a>
<FONT color="green">066</FONT>    abstract public class WOApplication extends ERXAjaxApplication<a name="line.66"></a>
<FONT color="green">067</FONT>    {<a name="line.67"></a>
<FONT color="green">068</FONT>        protected ApplicationProperties properties;<a name="line.68"></a>
<FONT color="green">069</FONT>        protected NSMutableArray requiredProperties = new NSMutableArray();<a name="line.69"></a>
<FONT color="green">070</FONT>        public static final String PageMapFileNamePropertyKey = "PageMapFileName";<a name="line.70"></a>
<FONT color="green">071</FONT>        protected Class editingContextClass;<a name="line.71"></a>
<FONT color="green">072</FONT>        protected NSDictionary pageMap = null;     // Map substituting one page to another<a name="line.72"></a>
<FONT color="green">073</FONT>    <a name="line.73"></a>
<FONT color="green">074</FONT>        protected  ModelConnector modelConnector;  //To be used in configuring EOModels<a name="line.74"></a>
<FONT color="green">075</FONT>        protected EOPrototypeSelector prototypeSwitcher; // Sets prototypes for active database<a name="line.75"></a>
<FONT color="green">076</FONT>    <a name="line.76"></a>
<FONT color="green">077</FONT>        private GVCBoolean isDevelopmentMode;<a name="line.77"></a>
<FONT color="green">078</FONT>        private Logger logger = LoggerFactory.makeLogger();<a name="line.78"></a>
<FONT color="green">079</FONT>    <a name="line.79"></a>
<FONT color="green">080</FONT>        /**  log4j Logger name for the conceptual area of RR loop logging.  This logger name does not match any code.  */<a name="line.80"></a>
<FONT color="green">081</FONT>        public static final String RRLoopLoggerName = "com.webobjects.RequestResponseLoop";<a name="line.81"></a>
<FONT color="green">082</FONT>        private Logger rrLoopLogger = Logger.getLogger(RRLoopLoggerName);<a name="line.82"></a>
<FONT color="green">083</FONT>    <a name="line.83"></a>
<FONT color="green">084</FONT>    <a name="line.84"></a>
<FONT color="green">085</FONT>        public static final String EditingContextClassNamePropertyKey = "EditingContextClassName";<a name="line.85"></a>
<FONT color="green">086</FONT>        public static final String DebuggingEditingContextClassNamePropertyKey = "DebuggingEditingContextClassName";<a name="line.86"></a>
<FONT color="green">087</FONT>        public static final String DispatchRequestsConcurrentlyPropertyKey = "DispatchRequestsConcurrently";<a name="line.87"></a>
<FONT color="green">088</FONT>        public static final String DebugEditingContextLockingPropertyKey = "DebugEditingContextLocking";<a name="line.88"></a>
<FONT color="green">089</FONT>        public static final String LogSlowQueriesKey = "LogSlowQueries";<a name="line.89"></a>
<FONT color="green">090</FONT>        public static final String LogSlowQueryThesholdInMillisecondsKey = "LogSlowQueryThesholdInMilliseconds";<a name="line.90"></a>
<FONT color="green">091</FONT>        public static final String LogFetchedRowsKey = "LogFetchedRows";<a name="line.91"></a>
<FONT color="green">092</FONT>        public static final String LogSQLSourceKey = "LogSQLSource";<a name="line.92"></a>
<FONT color="green">093</FONT>    <a name="line.93"></a>
<FONT color="green">094</FONT>        public static final String SessionTimeOutInMinutesKey = "SessionTimeOutInMinutes";<a name="line.94"></a>
<FONT color="green">095</FONT>        public static final String DefaultFetchTimestampLag = "DefaultFetchTimestampLag";<a name="line.95"></a>
<FONT color="green">096</FONT>        public static final String TestingDirectActionsEnabled   = "TestingDirectActionsEnabled";<a name="line.96"></a>
<FONT color="green">097</FONT>    <a name="line.97"></a>
<FONT color="green">098</FONT>        public static final String CookieHeaderKey = "cookie";<a name="line.98"></a>
<FONT color="green">099</FONT>    <a name="line.99"></a>
<FONT color="green">100</FONT>    <a name="line.100"></a>
<FONT color="green">101</FONT>        /**<a name="line.101"></a>
<FONT color="green">102</FONT>         * Convenience method to access properties() statically.  Returns the properies object containing the application configuration.<a name="line.102"></a>
<FONT color="green">103</FONT>         *<a name="line.103"></a>
<FONT color="green">104</FONT>         * @return the properies object containing the application configuration.<a name="line.104"></a>
<FONT color="green">105</FONT>         */<a name="line.105"></a>
<FONT color="green">106</FONT>        static public ApplicationProperties appProperties()<a name="line.106"></a>
<FONT color="green">107</FONT>        {<a name="line.107"></a>
<FONT color="green">108</FONT>            return ((WOApplication) WOApplication.application()).properties();<a name="line.108"></a>
<FONT color="green">109</FONT>        }<a name="line.109"></a>
<FONT color="green">110</FONT>    <a name="line.110"></a>
<FONT color="green">111</FONT>    <a name="line.111"></a>
<FONT color="green">112</FONT>    <a name="line.112"></a>
<FONT color="green">113</FONT>        /**<a name="line.113"></a>
<FONT color="green">114</FONT>         * This constructor sets up the application object using default values from property lists.<a name="line.114"></a>
<FONT color="green">115</FONT>         */<a name="line.115"></a>
<FONT color="green">116</FONT>        public WOApplication()<a name="line.116"></a>
<FONT color="green">117</FONT>        {<a name="line.117"></a>
<FONT color="green">118</FONT>            super();<a name="line.118"></a>
<FONT color="green">119</FONT>    <a name="line.119"></a>
<FONT color="green">120</FONT>            /* WOFrameworksBaseURL and WOApplicationBaseURL properties are broken in 5.4.<a name="line.120"></a>
<FONT color="green">121</FONT>               This is the workaround from Project Wonder.  This goes along with the<a name="line.121"></a>
<FONT color="green">122</FONT>               in the woapplication Ant task when fully embedding frameworks:<a name="line.122"></a>
<FONT color="green">123</FONT>    <a name="line.123"></a>
<FONT color="green">124</FONT>               &lt;woapplication name="${build.app.name}"  stdFrameworks="false"<a name="line.124"></a>
<FONT color="green">125</FONT>                    ...<a name="line.125"></a>
<FONT color="green">126</FONT>                    frameworksBaseURL="/WebObjects/${build.app.name}.woa/Frameworks"&gt;<a name="line.126"></a>
<FONT color="green">127</FONT>             */<a name="line.127"></a>
<FONT color="green">128</FONT>            frameworksBaseURL();<a name="line.128"></a>
<FONT color="green">129</FONT>            applicationBaseURL();<a name="line.129"></a>
<FONT color="green">130</FONT>            if (System.getProperty("WOFrameworksBaseURL") != null) {<a name="line.130"></a>
<FONT color="green">131</FONT>                setFrameworksBaseURL(System.getProperty("WOFrameworksBaseURL"));<a name="line.131"></a>
<FONT color="green">132</FONT>            }<a name="line.132"></a>
<FONT color="green">133</FONT>            if (System.getProperty("WOApplicationBaseURL") != null) {<a name="line.133"></a>
<FONT color="green">134</FONT>                setApplicationBaseURL(System.getProperty("WOApplicationBaseURL"));<a name="line.134"></a>
<FONT color="green">135</FONT>            }<a name="line.135"></a>
<FONT color="green">136</FONT>    <a name="line.136"></a>
<FONT color="green">137</FONT>            // Add WOForm replacement needed for some Ajax components<a name="line.137"></a>
<FONT color="green">138</FONT>            ERXPatcher.setClassForName(ERXWOForm.class, "WOForm");<a name="line.138"></a>
<FONT color="green">139</FONT>    <a name="line.139"></a>
<FONT color="green">140</FONT>            // Redirect System.out and System.err to NSLog.out<a name="line.140"></a>
<FONT color="green">141</FONT>            System.setOut(((NSLog.PrintStreamLogger)NSLog.out).printStream());<a name="line.141"></a>
<FONT color="green">142</FONT>            System.setErr(((NSLog.PrintStreamLogger)NSLog.out).printStream());<a name="line.142"></a>
<FONT color="green">143</FONT>    <a name="line.143"></a>
<FONT color="green">144</FONT>            // Dump the system properties and classpath to aid in debugging<a name="line.144"></a>
<FONT color="green">145</FONT>            logger.info(Debug.dumpJVMConfiguration());<a name="line.145"></a>
<FONT color="green">146</FONT>    <a name="line.146"></a>
<FONT color="green">147</FONT>            initializeLog4J();<a name="line.147"></a>
<FONT color="green">148</FONT>    <a name="line.148"></a>
<FONT color="green">149</FONT>            // Calls willFinishLaunching(NSNotification) when ApplicationWillFinishLaunchingNotification is broadcast<a name="line.149"></a>
<FONT color="green">150</FONT>            NSNotificationCenter.defaultCenter().addObserver(this, new NSSelector("willFinishLaunching", ERXConstant.NotificationClassArray), WOApplication.ApplicationWillFinishLaunchingNotification, null);<a name="line.150"></a>
<FONT color="green">151</FONT>        }<a name="line.151"></a>
<FONT color="green">152</FONT>    <a name="line.152"></a>
<FONT color="green">153</FONT>    <a name="line.153"></a>
<FONT color="green">154</FONT>    <a name="line.154"></a>
<FONT color="green">155</FONT>        /**<a name="line.155"></a>
<FONT color="green">156</FONT>         * Notification method called when the application posts the notification<a name="line.156"></a>
<FONT color="green">157</FONT>         * {@link WOApplication#ApplicationWillFinishLaunchingNotification}. This method calls<a name="line.157"></a>
<FONT color="green">158</FONT>         * initializeApplicationConfiguration() and installs the ApplicationDidDispatchRequestNotification<a name="line.158"></a>
<FONT color="green">159</FONT>         * handler.<a name="line.159"></a>
<FONT color="green">160</FONT>         *<a name="line.160"></a>
<FONT color="green">161</FONT>         * @see #initializeApplicationConfiguration()<a name="line.161"></a>
<FONT color="green">162</FONT>         * @see #applicationDidHandleRequest(NSNotification)<a name="line.162"></a>
<FONT color="green">163</FONT>         *<a name="line.163"></a>
<FONT color="green">164</FONT>         * @param n notification that is posted just before the WOApplication has finished launching<a name="line.164"></a>
<FONT color="green">165</FONT>         * and is ready for accepting requests<a name="line.165"></a>
<FONT color="green">166</FONT>         */<a name="line.166"></a>
<FONT color="green">167</FONT>        public void willFinishLaunching(NSNotification n)<a name="line.167"></a>
<FONT color="green">168</FONT>        {<a name="line.168"></a>
<FONT color="green">169</FONT>            initializeApplicationConfiguration();<a name="line.169"></a>
<FONT color="green">170</FONT>            NSNotificationCenter.defaultCenter().addObserver(this,<a name="line.170"></a>
<FONT color="green">171</FONT>                                                             ERXSelectorUtilities.notificationSelector("applicationDidHandleRequest"),<a name="line.171"></a>
<FONT color="green">172</FONT>                                                             WOApplication.ApplicationDidDispatchRequestNotification, null);<a name="line.172"></a>
<FONT color="green">173</FONT>        }<a name="line.173"></a>
<FONT color="green">174</FONT>    <a name="line.174"></a>
<FONT color="green">175</FONT>    <a name="line.175"></a>
<FONT color="green">176</FONT>    <a name="line.176"></a>
<FONT color="green">177</FONT>        /**<a name="line.177"></a>
<FONT color="green">178</FONT>         * Initializes log4j with configuration referenced by log4jConfigUrl().  Changes NSLog to use log4j for output.<a name="line.178"></a>
<FONT color="green">179</FONT>         * if log4jConfigUrl() returns null, log4j is not activated.<a name="line.179"></a>
<FONT color="green">180</FONT>         * &lt;p&gt;<a name="line.180"></a>
<FONT color="green">181</FONT>         * This method does not use &lt;code&gt;NSLog.Log4JLogger&lt;/code&gt; to direct NSLog messages to log4j.  &lt;code&gt;NSLog.Log4JLogger&lt;/code&gt;<a name="line.181"></a>
<FONT color="green">182</FONT>         * either has a bug or a conflict with more recent versions of log4j that makes it always report that LogLevelDetailed is on.<a name="line.182"></a>
<FONT color="green">183</FONT>         * This causes a lot of extra processing and output.  This method uses &lt;code&gt;er.extensions.ERXNSLogLog4jBridge&lt;/code&gt; to direct<a name="line.183"></a>
<FONT color="green">184</FONT>         * NSLog messages to log4j.  This requires that the configuration returned by log4jConfigUrl() defines the &lt;code&gt;NSLog&lt;/code&gt; logger.<a name="line.184"></a>
<FONT color="green">185</FONT>         */<a name="line.185"></a>
<FONT color="green">186</FONT>        protected void initializeLog4J()<a name="line.186"></a>
<FONT color="green">187</FONT>        {<a name="line.187"></a>
<FONT color="green">188</FONT>            URL configURL = log4jConfigUrl();<a name="line.188"></a>
<FONT color="green">189</FONT>            if (configURL != null)<a name="line.189"></a>
<FONT color="green">190</FONT>            {<a name="line.190"></a>
<FONT color="green">191</FONT>                logger.info("Initializing log4j from " + configURL.toString());<a name="line.191"></a>
<FONT color="green">192</FONT>                if (configURL.toString().endsWith(".xml"))<a name="line.192"></a>
<FONT color="green">193</FONT>                {<a name="line.193"></a>
<FONT color="green">194</FONT>                    DOMConfigurator.configure(configURL);<a name="line.194"></a>
<FONT color="green">195</FONT>                }<a name="line.195"></a>
<FONT color="green">196</FONT>                else<a name="line.196"></a>
<FONT color="green">197</FONT>                {<a name="line.197"></a>
<FONT color="green">198</FONT>                    PropertyConfigurator.configure(configURL);<a name="line.198"></a>
<FONT color="green">199</FONT>                }<a name="line.199"></a>
<FONT color="green">200</FONT>    <a name="line.200"></a>
<FONT color="green">201</FONT>                int allowedLevel = NSLog.debug.allowedDebugLevel();<a name="line.201"></a>
<FONT color="green">202</FONT>                NSLog.setOut(new ERXNSLogLog4jBridge(ERXNSLogLog4jBridge.OUT));<a name="line.202"></a>
<FONT color="green">203</FONT>                NSLog.setErr(new ERXNSLogLog4jBridge(ERXNSLogLog4jBridge.ERR));<a name="line.203"></a>
<FONT color="green">204</FONT>                NSLog.setDebug(new ERXNSLogLog4jBridge(ERXNSLogLog4jBridge.DEBUG));<a name="line.204"></a>
<FONT color="green">205</FONT>                NSLog.debug.setAllowedDebugLevel(allowedLevel);<a name="line.205"></a>
<FONT color="green">206</FONT>            }<a name="line.206"></a>
<FONT color="green">207</FONT>        }<a name="line.207"></a>
<FONT color="green">208</FONT>    <a name="line.208"></a>
<FONT color="green">209</FONT>    <a name="line.209"></a>
<FONT color="green">210</FONT>    <a name="line.210"></a>
<FONT color="green">211</FONT>        /**<a name="line.211"></a>
<FONT color="green">212</FONT>         * Returns the URL to the log4j configuration (either .properties or .xml).  The default is to return null which results in<a name="line.212"></a>
<FONT color="green">213</FONT>         * log4j not being active.  This method can be implemented as:<a name="line.213"></a>
<FONT color="green">214</FONT>         * &lt;pre&gt;<a name="line.214"></a>
<FONT color="green">215</FONT>         * return resourceManager().pathURLForResourceNamed("log4j.xml", null, null);<a name="line.215"></a>
<FONT color="green">216</FONT>         * &lt;/pre&gt;<a name="line.216"></a>
<FONT color="green">217</FONT>         * @return URL to log4j configuration or null if log4j should not be configured.<a name="line.217"></a>
<FONT color="green">218</FONT>         */<a name="line.218"></a>
<FONT color="green">219</FONT>        protected URL log4jConfigUrl()<a name="line.219"></a>
<FONT color="green">220</FONT>        {<a name="line.220"></a>
<FONT color="green">221</FONT>            return resourceManager().pathURLForResourceNamed("log4j.xml", "GVCWOExtensions", null);<a name="line.221"></a>
<FONT color="green">222</FONT>            /** ensure [result_not_null] Result != null; **/<a name="line.222"></a>
<FONT color="green">223</FONT>        }<a name="line.223"></a>
<FONT color="green">224</FONT>    <a name="line.224"></a>
<FONT color="green">225</FONT>    <a name="line.225"></a>
<FONT color="green">226</FONT>    <a name="line.226"></a>
<FONT color="green">227</FONT>        /**<a name="line.227"></a>
<FONT color="green">228</FONT>         * Loads the application configuration information and configures the debugging and WebObjects environment. The initialization is performed in the following sequence of method calls, where each method can be overriden to add customizations. &lt;br&gt;<a name="line.228"></a>
<FONT color="green">229</FONT>         * Called when ApplicationWillFinishLaunchingNotification is broadcast.<a name="line.229"></a>
<FONT color="green">230</FONT>         * &lt;b&gt;Steps performed during initialization:&lt;/b&gt;<a name="line.230"></a>
<FONT color="green">231</FONT>         * &lt;ol&gt;<a name="line.231"></a>
<FONT color="green">232</FONT>         * &lt;li&gt;loadConfigurationInfo()&lt;/li&gt;<a name="line.232"></a>
<FONT color="green">233</FONT>         * &lt;li&gt;performConfigurationDiagnostics()&lt;/li&gt;<a name="line.233"></a>
<FONT color="green">234</FONT>         * &lt;li&gt;configureDatabaseConnections()&lt;/li&gt;<a name="line.234"></a>
<FONT color="green">235</FONT>         * &lt;li&gt;configureWebObjectsEnvironment()&lt;/li&gt;<a name="line.235"></a>
<FONT color="green">236</FONT>         * &lt;li&gt;createFormatters()&lt;/li&gt;<a name="line.236"></a>
<FONT color="green">237</FONT>         * &lt;li&gt;migrate schema&lt;/li&gt;<a name="line.237"></a>
<FONT color="green">238</FONT>         * &lt;/ol&gt;<a name="line.238"></a>
<FONT color="green">239</FONT>         * &lt;br&gt;<a name="line.239"></a>
<FONT color="green">240</FONT>         * &lt;b&gt;IMPORTANT:&lt;/b&gt; Read notes/instructions carefully on overriding each of these methods to ensure proper initialization.<a name="line.240"></a>
<FONT color="green">241</FONT>         */<a name="line.241"></a>
<FONT color="green">242</FONT>        protected void initializeApplicationConfiguration()<a name="line.242"></a>
<FONT color="green">243</FONT>        {<a name="line.243"></a>
<FONT color="green">244</FONT>            logger.info("Initializing Application Configuration...");<a name="line.244"></a>
<FONT color="green">245</FONT>    <a name="line.245"></a>
<FONT color="green">246</FONT>            loadConfigurationInfo();<a name="line.246"></a>
<FONT color="green">247</FONT>            loadCommandLineOverrides();<a name="line.247"></a>
<FONT color="green">248</FONT>            loadPageMap();<a name="line.248"></a>
<FONT color="green">249</FONT>            loadPropertyDependantConfiguration();<a name="line.249"></a>
<FONT color="green">250</FONT>    <a name="line.250"></a>
<FONT color="green">251</FONT>            // For backwards compatibility, use this property to set the logger level<a name="line.251"></a>
<FONT color="green">252</FONT>            if (properties().booleanPropertyForKey("DebugRequestResponseLoop"))<a name="line.252"></a>
<FONT color="green">253</FONT>            {<a name="line.253"></a>
<FONT color="green">254</FONT>                rrLoopLogger.setLevel(Level.DEBUG);<a name="line.254"></a>
<FONT color="green">255</FONT>            }<a name="line.255"></a>
<FONT color="green">256</FONT>    <a name="line.256"></a>
<FONT color="green">257</FONT>            if ( ! isTerminating())<a name="line.257"></a>
<FONT color="green">258</FONT>            {<a name="line.258"></a>
<FONT color="green">259</FONT>                performConfigurationDiagnostics();<a name="line.259"></a>
<FONT color="green">260</FONT>            }<a name="line.260"></a>
<FONT color="green">261</FONT>    <a name="line.261"></a>
<FONT color="green">262</FONT>            if ( ! isTerminating())<a name="line.262"></a>
<FONT color="green">263</FONT>            {<a name="line.263"></a>
<FONT color="green">264</FONT>                    configureDatabaseConnections(modelsToIgnore());<a name="line.264"></a>
<FONT color="green">265</FONT>            }<a name="line.265"></a>
<FONT color="green">266</FONT>    <a name="line.266"></a>
<FONT color="green">267</FONT>            if ( ! isTerminating())<a name="line.267"></a>
<FONT color="green">268</FONT>            {<a name="line.268"></a>
<FONT color="green">269</FONT>                    configureWebObjectsEnvironment();<a name="line.269"></a>
<FONT color="green">270</FONT>            }<a name="line.270"></a>
<FONT color="green">271</FONT>    <a name="line.271"></a>
<FONT color="green">272</FONT>            if ( ! isTerminating())<a name="line.272"></a>
<FONT color="green">273</FONT>            {<a name="line.273"></a>
<FONT color="green">274</FONT>                // Create formatters for all the date formats to work around a bug in WO 5.1 where there is no time zone set on a formatter by default.<a name="line.274"></a>
<FONT color="green">275</FONT>                createFormatters();<a name="line.275"></a>
<FONT color="green">276</FONT>            }<a name="line.276"></a>
<FONT color="green">277</FONT>    <a name="line.277"></a>
<FONT color="green">278</FONT>            if ( ! isTerminating())<a name="line.278"></a>
<FONT color="green">279</FONT>            {<a name="line.279"></a>
<FONT color="green">280</FONT>                logger.info("Checking for needed migation");<a name="line.280"></a>
<FONT color="green">281</FONT>                if (ERXMigrator.shouldMigrateAtStartup())<a name="line.281"></a>
<FONT color="green">282</FONT>                {<a name="line.282"></a>
<FONT color="green">283</FONT>                    try<a name="line.283"></a>
<FONT color="green">284</FONT>                    {<a name="line.284"></a>
<FONT color="green">285</FONT>                        migrator().migrateToLatest();<a name="line.285"></a>
<FONT color="green">286</FONT>                    }<a name="line.286"></a>
<FONT color="green">287</FONT>                    catch (ERXMigrationFailedException e)<a name="line.287"></a>
<FONT color="green">288</FONT>                    {<a name="line.288"></a>
<FONT color="green">289</FONT>                        // It might be a missing plugin problem<a name="line.289"></a>
<FONT color="green">290</FONT>                        new ERXJDBCConnectionAnalyzer(databaseConnectionDictionary());<a name="line.290"></a>
<FONT color="green">291</FONT>                        throw e;<a name="line.291"></a>
<FONT color="green">292</FONT>                    }<a name="line.292"></a>
<FONT color="green">293</FONT>                }<a name="line.293"></a>
<FONT color="green">294</FONT>            }<a name="line.294"></a>
<FONT color="green">295</FONT>    <a name="line.295"></a>
<FONT color="green">296</FONT>            if ( ! isTerminating())<a name="line.296"></a>
<FONT color="green">297</FONT>            {<a name="line.297"></a>
<FONT color="green">298</FONT>                logger.info("Application Configuration Initialized");<a name="line.298"></a>
<FONT color="green">299</FONT>            }<a name="line.299"></a>
<FONT color="green">300</FONT>            else<a name="line.300"></a>
<FONT color="green">301</FONT>            {<a name="line.301"></a>
<FONT color="green">302</FONT>                logger.fatal("\n*** SHUTDOWN *** Application shutting down due to configuration issues above.\n");<a name="line.302"></a>
<FONT color="green">303</FONT>            }<a name="line.303"></a>
<FONT color="green">304</FONT>        }<a name="line.304"></a>
<FONT color="green">305</FONT>    <a name="line.305"></a>
<FONT color="green">306</FONT>    <a name="line.306"></a>
<FONT color="green">307</FONT>    <a name="line.307"></a>
<FONT color="green">308</FONT>        /**<a name="line.308"></a>
<FONT color="green">309</FONT>         * Loads the application configuration information.  Subclasses can override this method to add more properties. &lt;br&gt;<a name="line.309"></a>
<FONT color="green">310</FONT>         * IMPORTANT: When overriding this method, make sure that you call &lt;code&gt;super&lt;/code&gt; before doing anything else, to initialize the list and load all the other framework defaults. &lt;br&gt;<a name="line.310"></a>
<FONT color="green">311</FONT>         *<a name="line.311"></a>
<FONT color="green">312</FONT>         * In example: &lt;br&gt;<a name="line.312"></a>
<FONT color="green">313</FONT>         * &lt;code&gt;&lt;pre&gt;<a name="line.313"></a>
<FONT color="green">314</FONT>         * protected void loadConfigurationInfo()<a name="line.314"></a>
<FONT color="green">315</FONT>         * {<a name="line.315"></a>
<FONT color="green">316</FONT>         *     super.loadConfigurationInfo();<a name="line.316"></a>
<FONT color="green">317</FONT>         *     properties().addPropertiesFromFile(aFile, aFramework);  //to load a plist file<a name="line.317"></a>
<FONT color="green">318</FONT>         *     properties().addPropertyForKey(anObject, aKey);  //to load a single property<a name="line.318"></a>
<FONT color="green">319</FONT>         * }<a name="line.319"></a>
<FONT color="green">320</FONT>         * &lt;/pre&gt;&lt;/code&gt;<a name="line.320"></a>
<FONT color="green">321</FONT>         * &lt;br&gt;<a name="line.321"></a>
<FONT color="green">322</FONT>         * Take note of the order you load the properties, since properties loaded later override properties loaded earlier.<a name="line.322"></a>
<FONT color="green">323</FONT>         */<a name="line.323"></a>
<FONT color="green">324</FONT>        protected void loadConfigurationInfo()<a name="line.324"></a>
<FONT color="green">325</FONT>        {<a name="line.325"></a>
<FONT color="green">326</FONT>            try<a name="line.326"></a>
<FONT color="green">327</FONT>            {<a name="line.327"></a>
<FONT color="green">328</FONT>                properties = new ApplicationProperties();<a name="line.328"></a>
<FONT color="green">329</FONT>    <a name="line.329"></a>
<FONT color="green">330</FONT>                // Convenience default<a name="line.330"></a>
<FONT color="green">331</FONT>                properties().addPropertyForKey(cgiAdaptorURL() + "/" + name(), "FrontDoorURL");<a name="line.331"></a>
<FONT color="green">332</FONT>    <a name="line.332"></a>
<FONT color="green">333</FONT>                //pre-load all GVC framework property lists which include this framework<a name="line.333"></a>
<FONT color="green">334</FONT>                NSArray frameworkNames = (NSArray) NSBundle.frameworkBundles().valueForKey("name");<a name="line.334"></a>
<FONT color="green">335</FONT>                Enumeration frameworkNameEnumerator = frameworkNames.objectEnumerator();<a name="line.335"></a>
<FONT color="green">336</FONT>                while (frameworkNameEnumerator.hasMoreElements())<a name="line.336"></a>
<FONT color="green">337</FONT>                {<a name="line.337"></a>
<FONT color="green">338</FONT>                    String frameworkName = (String) frameworkNameEnumerator.nextElement();<a name="line.338"></a>
<FONT color="green">339</FONT>                    if (frameworkName.startsWith("GVC"))<a name="line.339"></a>
<FONT color="green">340</FONT>                    {<a name="line.340"></a>
<FONT color="green">341</FONT>                        properties.addPropertiesFromFile(frameworkName + ".plist", frameworkName);<a name="line.341"></a>
<FONT color="green">342</FONT>                    }<a name="line.342"></a>
<FONT color="green">343</FONT>                }<a name="line.343"></a>
<FONT color="green">344</FONT>            }<a name="line.344"></a>
<FONT color="green">345</FONT>            catch (java.lang.IllegalArgumentException e)<a name="line.345"></a>
<FONT color="green">346</FONT>            {<a name="line.346"></a>
<FONT color="green">347</FONT>                logger.fatal("Terminating: Load properties failed with exception: " + e.getMessage());<a name="line.347"></a>
<FONT color="green">348</FONT>                terminate();<a name="line.348"></a>
<FONT color="green">349</FONT>            }<a name="line.349"></a>
<FONT color="green">350</FONT>        }<a name="line.350"></a>
<FONT color="green">351</FONT>    <a name="line.351"></a>
<FONT color="green">352</FONT>    <a name="line.352"></a>
<FONT color="green">353</FONT>    <a name="line.353"></a>
<FONT color="green">354</FONT>        /**<a name="line.354"></a>
<FONT color="green">355</FONT>         * Adds any properties from the command line and the Properties file to the application properties.<a name="line.355"></a>
<FONT color="green">356</FONT>         * This is done after loadConfigurationInfo() so it can be used to override properties loaded that way.<a name="line.356"></a>
<FONT color="green">357</FONT>         * if you don't want that to happen, you can override this and not call super.<a name="line.357"></a>
<FONT color="green">358</FONT>         */<a name="line.358"></a>
<FONT color="green">359</FONT>        protected void loadCommandLineOverrides()<a name="line.359"></a>
<FONT color="green">360</FONT>        {<a name="line.360"></a>
<FONT color="green">361</FONT>            Properties sysProperties = System.getProperties();<a name="line.361"></a>
<FONT color="green">362</FONT>            Enumeration propertyNames = sysProperties.propertyNames();<a name="line.362"></a>
<FONT color="green">363</FONT>            while (propertyNames.hasMoreElements())<a name="line.363"></a>
<FONT color="green">364</FONT>            {<a name="line.364"></a>
<FONT color="green">365</FONT>                String propertyName = (String) propertyNames.nextElement();<a name="line.365"></a>
<FONT color="green">366</FONT>                properties().addPropertyForKey(sysProperties.getProperty(propertyName), propertyName);<a name="line.366"></a>
<FONT color="green">367</FONT>            }<a name="line.367"></a>
<FONT color="green">368</FONT>        }<a name="line.368"></a>
<FONT color="green">369</FONT>    <a name="line.369"></a>
<FONT color="green">370</FONT>    <a name="line.370"></a>
<FONT color="green">371</FONT>    <a name="line.371"></a>
<FONT color="green">372</FONT>        /**<a name="line.372"></a>
<FONT color="green">373</FONT>         * Loads the page mapping, if any.  The name of the page map file is taken from pageMapFileName().<a name="line.373"></a>
<FONT color="green">374</FONT>         * It is loaded from the configurationFrameworkName() if specified, otherwise from the application bundle.<a name="line.374"></a>
<FONT color="green">375</FONT>         * This method can be overridden if a different method of loading is needed.<a name="line.375"></a>
<FONT color="green">376</FONT>         *<a name="line.376"></a>
<FONT color="green">377</FONT>         * @see #pageMapFileName()<a name="line.377"></a>
<FONT color="green">378</FONT>         * @see #configurationFrameworkName()<a name="line.378"></a>
<FONT color="green">379</FONT>         */<a name="line.379"></a>
<FONT color="green">380</FONT>        protected void loadPageMap()<a name="line.380"></a>
<FONT color="green">381</FONT>        {<a name="line.381"></a>
<FONT color="green">382</FONT>                pageMap = new NSDictionary();<a name="line.382"></a>
<FONT color="green">383</FONT>    <a name="line.383"></a>
<FONT color="green">384</FONT>                String pageMapFileName = pageMapFileName();<a name="line.384"></a>
<FONT color="green">385</FONT>                if (pageMapFileName != null)<a name="line.385"></a>
<FONT color="green">386</FONT>                {<a name="line.386"></a>
<FONT color="green">387</FONT>                    WOResourceManager rm = WOApplication.application().resourceManager();<a name="line.387"></a>
<FONT color="green">388</FONT>    <a name="line.388"></a>
<FONT color="green">389</FONT>                    // Try this first as bytesForResourceNamed throws a null pointer exception if the file cannot be found.<a name="line.389"></a>
<FONT color="green">390</FONT>                java.io.InputStream resourceStream = rm.inputStreamForResourceNamed(pageMapFileName, configurationFrameworkName(), null);<a name="line.390"></a>
<FONT color="green">391</FONT>                if (resourceStream != null)<a name="line.391"></a>
<FONT color="green">392</FONT>                {<a name="line.392"></a>
<FONT color="green">393</FONT>                    byte[] bytesFromResource = rm.bytesForResourceNamed(pageMapFileName, configurationFrameworkName(), null);<a name="line.393"></a>
<FONT color="green">394</FONT>                    pageMap = (NSDictionary) NSPropertyListSerialization.propertyListFromData(new NSData(bytesFromResource), "US-ASCII");<a name="line.394"></a>
<FONT color="green">395</FONT>                    logger.info("Loaded page map " + pageMapFileName + ".plist from " + (configurationFrameworkName() == null ? "Application" : configurationFrameworkName())) ;<a name="line.395"></a>
<FONT color="green">396</FONT>                }<a name="line.396"></a>
<FONT color="green">397</FONT>                else<a name="line.397"></a>
<FONT color="green">398</FONT>                {<a name="line.398"></a>
<FONT color="green">399</FONT>                    logger.fatal("Terminating: Failed to find page map " + pageMapFileName + ".plist from " + (configurationFrameworkName() == null ? "Application" : configurationFrameworkName())) ;<a name="line.399"></a>
<FONT color="green">400</FONT>                    terminate();<a name="line.400"></a>
<FONT color="green">401</FONT>                }<a name="line.401"></a>
<FONT color="green">402</FONT>            }<a name="line.402"></a>
<FONT color="green">403</FONT>        }<a name="line.403"></a>
<FONT color="green">404</FONT>    <a name="line.404"></a>
<FONT color="green">405</FONT>    <a name="line.405"></a>
<FONT color="green">406</FONT>    <a name="line.406"></a>
<FONT color="green">407</FONT>        /**<a name="line.407"></a>
<FONT color="green">408</FONT>         * Returns the name of the file that defines the page mapping, if any. This implementation uses the<a name="line.408"></a>
<FONT color="green">409</FONT>         * value of PageMapFileNamePropertyKey.<a name="line.409"></a>
<FONT color="green">410</FONT>         *<a name="line.410"></a>
<FONT color="green">411</FONT>         * @return he name of the file that defines the page mapping or null if pages are not mapped<a name="line.411"></a>
<FONT color="green">412</FONT>         *<a name="line.412"></a>
<FONT color="green">413</FONT>         * @see #PageMapFileNamePropertyKey<a name="line.413"></a>
<FONT color="green">414</FONT>         * @see #pageMapFileName()<a name="line.414"></a>
<FONT color="green">415</FONT>         * @see #configurationFrameworkName()<a name="line.415"></a>
<FONT color="green">416</FONT>         */<a name="line.416"></a>
<FONT color="green">417</FONT>        public String pageMapFileName()<a name="line.417"></a>
<FONT color="green">418</FONT>        {<a name="line.418"></a>
<FONT color="green">419</FONT>            return properties.stringPropertyForKey(PageMapFileNamePropertyKey);<a name="line.419"></a>
<FONT color="green">420</FONT>        }<a name="line.420"></a>
<FONT color="green">421</FONT>    <a name="line.421"></a>
<FONT color="green">422</FONT>    <a name="line.422"></a>
<FONT color="green">423</FONT>    <a name="line.423"></a>
<FONT color="green">424</FONT>        /**<a name="line.424"></a>
<FONT color="green">425</FONT>         * Loads application configuration that is dependant on all the properties being loaded.  Subclasses can override this method to load additional configuration. &lt;br&gt;<a name="line.425"></a>
<FONT color="green">426</FONT>         */<a name="line.426"></a>
<FONT color="green">427</FONT>        protected void loadPropertyDependantConfiguration()<a name="line.427"></a>
<FONT color="green">428</FONT>        {<a name="line.428"></a>
<FONT color="green">429</FONT>            try<a name="line.429"></a>
<FONT color="green">430</FONT>            {<a name="line.430"></a>
<FONT color="green">431</FONT>                // get the page map, if one is specified in the config<a name="line.431"></a>
<FONT color="green">432</FONT>                if (properties().hasPropertyForKey(PageMapFileNamePropertyKey))<a name="line.432"></a>
<FONT color="green">433</FONT>                {<a name="line.433"></a>
<FONT color="green">434</FONT>                    String pageMapFileName = properties().stringPropertyForKey(PageMapFileNamePropertyKey);<a name="line.434"></a>
<FONT color="green">435</FONT>                    if (NSBundleAdditions.tableExistsWithName(NSBundle.mainBundle(), pageMapFileName))<a name="line.435"></a>
<FONT color="green">436</FONT>                    {<a name="line.436"></a>
<FONT color="green">437</FONT>                        pageMap = NSBundleAdditions.tableWithName(NSBundle.mainBundle(), pageMapFileName);<a name="line.437"></a>
<FONT color="green">438</FONT>                    }<a name="line.438"></a>
<FONT color="green">439</FONT>                }<a name="line.439"></a>
<FONT color="green">440</FONT>    <a name="line.440"></a>
<FONT color="green">441</FONT>                if (developmentMode())<a name="line.441"></a>
<FONT color="green">442</FONT>                {<a name="line.442"></a>
<FONT color="green">443</FONT>                    // Set some default for Wonder properties<a name="line.443"></a>
<FONT color="green">444</FONT>                    if ( ! properties.hasPropertyForKey("er.component.clickToOpen"))<a name="line.444"></a>
<FONT color="green">445</FONT>                    {<a name="line.445"></a>
<FONT color="green">446</FONT>                        properties.addPropertyForKey(Boolean.TRUE, "er.component.clickToOpen");<a name="line.446"></a>
<FONT color="green">447</FONT>                    }<a name="line.447"></a>
<FONT color="green">448</FONT>                    if ( ! properties.hasPropertyForKey("er.extensions.ERXApplication.developmentMode"))<a name="line.448"></a>
<FONT color="green">449</FONT>                    {<a name="line.449"></a>
<FONT color="green">450</FONT>                        properties.addPropertyForKey(Boolean.TRUE, "er.extensions.ERXApplication.developmentMode");<a name="line.450"></a>
<FONT color="green">451</FONT>                    }<a name="line.451"></a>
<FONT color="green">452</FONT>                }<a name="line.452"></a>
<FONT color="green">453</FONT>            }<a name="line.453"></a>
<FONT color="green">454</FONT>            catch (java.lang.IllegalArgumentException e)<a name="line.454"></a>
<FONT color="green">455</FONT>            {<a name="line.455"></a>
<FONT color="green">456</FONT>                logger.fatal("Terminating: Load property dependant configuration failed with exception: " + e.getMessage());<a name="line.456"></a>
<FONT color="green">457</FONT>                terminate();<a name="line.457"></a>
<FONT color="green">458</FONT>            }<a name="line.458"></a>
<FONT color="green">459</FONT>        }<a name="line.459"></a>
<FONT color="green">460</FONT>    <a name="line.460"></a>
<FONT color="green">461</FONT>    <a name="line.461"></a>
<FONT color="green">462</FONT>        /**<a name="line.462"></a>
<FONT color="green">463</FONT>         * Configures all EOModels in this project, using ModelConnector, so it can be updated with the proper connection dictionary<a name="line.463"></a>
<FONT color="green">464</FONT>         * (from the configuration files) when they are loaded.<a name="line.464"></a>
<FONT color="green">465</FONT>         *<a name="line.465"></a>
<FONT color="green">466</FONT>         * @param modelsToIgnore list of models to not connect<a name="line.466"></a>
<FONT color="green">467</FONT>         */<a name="line.467"></a>
<FONT color="green">468</FONT>        protected void configureDatabaseConnections(NSArray modelsToIgnore)<a name="line.468"></a>
<FONT color="green">469</FONT>        {<a name="line.469"></a>
<FONT color="green">470</FONT>            /** require [valid_model_list] modelsToIgnore != null;  **/<a name="line.470"></a>
<FONT color="green">471</FONT>    <a name="line.471"></a>
<FONT color="green">472</FONT>            logger.info("Configuring for a " + databaseType() + " database");<a name="line.472"></a>
<FONT color="green">473</FONT>            logger.info("Connecting with " + databaseConnectionDictionary());<a name="line.473"></a>
<FONT color="green">474</FONT>            prototypeSwitcher = new EOPrototypeSelector(databaseType());<a name="line.474"></a>
<FONT color="green">475</FONT>            prototypeSwitcher.installModelAddedListener();<a name="line.475"></a>
<FONT color="green">476</FONT>    <a name="line.476"></a>
<FONT color="green">477</FONT>            // A bogus trace is output by the constructor of EODatabaseContext.  Ignore it.<a name="line.477"></a>
<FONT color="green">478</FONT>            if (NSLog.debugLoggingAllowedForGroups(NSLog.DebugGroupMultithreading))<a name="line.478"></a>
<FONT color="green">479</FONT>            {<a name="line.479"></a>
<FONT color="green">480</FONT>                logger.info("***** Ignore the 'access without lock' trace below, it is not a real locking problem.");<a name="line.480"></a>
<FONT color="green">481</FONT>            }<a name="line.481"></a>
<FONT color="green">482</FONT>    <a name="line.482"></a>
<FONT color="green">483</FONT>            modelConnector = new ModelConnector(databaseConnectionDictionary(), modelsToIgnore);<a name="line.483"></a>
<FONT color="green">484</FONT>    <a name="line.484"></a>
<FONT color="green">485</FONT>            /* Ensure that we have a EOJDBCPrototypes entity or none of the DB will work.  We need<a name="line.485"></a>
<FONT color="green">486</FONT>             * to check this here and not earlier so that the EOPrototypeSelector and ModelConnector<a name="line.486"></a>
<FONT color="green">487</FONT>             * can catch the model added notification.  Otherwise this could go in<a name="line.487"></a>
<FONT color="green">488</FONT>             * perfromConfigurationDiagnostics().<a name="line.488"></a>
<FONT color="green">489</FONT>             */<a name="line.489"></a>
<FONT color="green">490</FONT>            if (EOModelGroup.defaultGroup().entityNamed("EOJDBCPrototypes") == null)<a name="line.490"></a>
<FONT color="green">491</FONT>            {<a name="line.491"></a>
<FONT color="green">492</FONT>                terminate();    // It is required do not proceed with launching the application.<a name="line.492"></a>
<FONT color="green">493</FONT>                logger.fatal("No EOJDBCPrototypes entity found.  Is the Prototypes framework missing?");<a name="line.493"></a>
<FONT color="green">494</FONT>            }<a name="line.494"></a>
<FONT color="green">495</FONT>    <a name="line.495"></a>
<FONT color="green">496</FONT>            /** ensure [modelConnector_no_null] modelConnector != null; **/<a name="line.496"></a>
<FONT color="green">497</FONT>        }<a name="line.497"></a>
<FONT color="green">498</FONT>    <a name="line.498"></a>
<FONT color="green">499</FONT>    <a name="line.499"></a>
<FONT color="green">500</FONT>    <a name="line.500"></a>
<FONT color="green">501</FONT>        /**<a name="line.501"></a>
<FONT color="green">502</FONT>         * Returns array of models (models for testing in this case) to not attempt to connect to.<a name="line.502"></a>
<FONT color="green">503</FONT>         * This can be overriden and additional models added to the list.<a name="line.503"></a>
<FONT color="green">504</FONT>         *<a name="line.504"></a>
<FONT color="green">505</FONT>         * @return array of models to not attempt to connect to<a name="line.505"></a>
<FONT color="green">506</FONT>         */<a name="line.506"></a>
<FONT color="green">507</FONT>        public NSArray modelsToIgnore()<a name="line.507"></a>
<FONT color="green">508</FONT>        {<a name="line.508"></a>
<FONT color="green">509</FONT>            return new NSArray(new Object[]{"TestModel1", "TestModel2", "TestModel3", "GVCJEOFValidationTest",<a name="line.509"></a>
<FONT color="green">510</FONT>                                            "GVCGenericObjectsTest"});<a name="line.510"></a>
<FONT color="green">511</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.511"></a>
<FONT color="green">512</FONT>        }<a name="line.512"></a>
<FONT color="green">513</FONT>    <a name="line.513"></a>
<FONT color="green">514</FONT>    <a name="line.514"></a>
<FONT color="green">515</FONT>    <a name="line.515"></a>
<FONT color="green">516</FONT>        /**<a name="line.516"></a>
<FONT color="green">517</FONT>         * Returns the database type (e.g. DB2, Oracle, FrontBase, OpenBase, mySQL etc.) that is to be<a name="line.517"></a>
<FONT color="green">518</FONT>         * used.  This must match the name as used in the EO&lt;database name&gt;Prototypes entity for this<a name="line.518"></a>
<FONT color="green">519</FONT>         * database in the EOModel.  Remember - case counts!<a name="line.519"></a>
<FONT color="green">520</FONT>         *<a name="line.520"></a>
<FONT color="green">521</FONT>         * @return the database type that is to be used for this test run<a name="line.521"></a>
<FONT color="green">522</FONT>         */<a name="line.522"></a>
<FONT color="green">523</FONT>         public String databaseType()<a name="line.523"></a>
<FONT color="green">524</FONT>        {<a name="line.524"></a>
<FONT color="green">525</FONT>            return properties().stringPropertyForKey("DBType");<a name="line.525"></a>
<FONT color="green">526</FONT>    <a name="line.526"></a>
<FONT color="green">527</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.527"></a>
<FONT color="green">528</FONT>        }<a name="line.528"></a>
<FONT color="green">529</FONT>    <a name="line.529"></a>
<FONT color="green">530</FONT>    <a name="line.530"></a>
<FONT color="green">531</FONT>    <a name="line.531"></a>
<FONT color="green">532</FONT>        /**<a name="line.532"></a>
<FONT color="green">533</FONT>         * Returns the connection dictionary to use for all EOModels.  This is built from information in the configuration files.  A connection dictionary looks like this;<a name="line.533"></a>
<FONT color="green">534</FONT>         * &lt;br&gt;&lt;br&gt;<a name="line.534"></a>
<FONT color="green">535</FONT>         * &lt;pre&gt;<a name="line.535"></a>
<FONT color="green">536</FONT>         * connectionDictionary = {<a name="line.536"></a>
<FONT color="green">537</FONT>         *          URL = "jdbc:oracle:thin:@OTTAWA:1521:GVC";<a name="line.537"></a>
<FONT color="green">538</FONT>         *          driver = "";<a name="line.538"></a>
<FONT color="green">539</FONT>         *          password = smaker2;<a name="line.539"></a>
<FONT color="green">540</FONT>         *          plugin = "";<a name="line.540"></a>
<FONT color="green">541</FONT>         *          username = smaker2;<a name="line.541"></a>
<FONT color="green">542</FONT>         * };<a name="line.542"></a>
<FONT color="green">543</FONT>         * &lt;/pre&gt;<a name="line.543"></a>
<FONT color="green">544</FONT>         *<a name="line.544"></a>
<FONT color="green">545</FONT>         * @return the connection dictionary to use for all EOModels.<a name="line.545"></a>
<FONT color="green">546</FONT>         */<a name="line.546"></a>
<FONT color="green">547</FONT>        public NSDictionary databaseConnectionDictionary()<a name="line.547"></a>
<FONT color="green">548</FONT>        {<a name="line.548"></a>
<FONT color="green">549</FONT>            NSMutableDictionary connectionDictionary = new NSMutableDictionary();<a name="line.549"></a>
<FONT color="green">550</FONT>    <a name="line.550"></a>
<FONT color="green">551</FONT>            connectionDictionary.setObjectForKey(properties().stringPropertyForKey("JDBCUrl"), "URL");<a name="line.551"></a>
<FONT color="green">552</FONT>            connectionDictionary.setObjectForKey(properties().stringPropertyForKey("JDBCDriver"), "driver");<a name="line.552"></a>
<FONT color="green">553</FONT>            connectionDictionary.setObjectForKey(properties().stringPropertyForKey("DBPassword"), "password");<a name="line.553"></a>
<FONT color="green">554</FONT>            connectionDictionary.setObjectForKey(properties().stringPropertyForKey("EOFPlugin"), "plugin");<a name="line.554"></a>
<FONT color="green">555</FONT>            connectionDictionary.setObjectForKey(properties().stringPropertyForKey("DBUserName"), "username");<a name="line.555"></a>
<FONT color="green">556</FONT>    <a name="line.556"></a>
<FONT color="green">557</FONT>            return connectionDictionary;<a name="line.557"></a>
<FONT color="green">558</FONT>    <a name="line.558"></a>
<FONT color="green">559</FONT>            /** ensure<a name="line.559"></a>
<FONT color="green">560</FONT>            [valid_result] Result != null;<a name="line.560"></a>
<FONT color="green">561</FONT>            [has_url] Result.objectForKey("URL") != null;<a name="line.561"></a>
<FONT color="green">562</FONT>            [has_username] Result.objectForKey("username") != null;<a name="line.562"></a>
<FONT color="green">563</FONT>            [has_password] Result.objectForKey("password") != null; **/<a name="line.563"></a>
<FONT color="green">564</FONT>        }<a name="line.564"></a>
<FONT color="green">565</FONT>    <a name="line.565"></a>
<FONT color="green">566</FONT>    <a name="line.566"></a>
<FONT color="green">567</FONT>    <a name="line.567"></a>
<FONT color="green">568</FONT>        /**<a name="line.568"></a>
<FONT color="green">569</FONT>         * Perform diagnostic checks to ensure that the application configuration information is complete and reasonable.  The application is marked for temination if the configuration is not complete and reasonable.&lt;br&gt;<a name="line.569"></a>
<FONT color="green">570</FONT>         * To add add more properties to require, override this method, but don't forget to call super at the end. Below is an example: &lt;br&gt;<a name="line.570"></a>
<FONT color="green">571</FONT>         * &lt;code&gt;&lt;pre&gt;<a name="line.571"></a>
<FONT color="green">572</FONT>         * protected void performConfigurationDiagnostics()<a name="line.572"></a>
<FONT color="green">573</FONT>         * {<a name="line.573"></a>
<FONT color="green">574</FONT>         *     requiredProperties().addObjectsFromArray(&lt;array of additional properties names you want to require&gt;);<a name="line.574"></a>
<FONT color="green">575</FONT>         *     super.performConfigurationDiagnostics();<a name="line.575"></a>
<FONT color="green">576</FONT>         * }<a name="line.576"></a>
<FONT color="green">577</FONT>         * &lt;/pre&gt;&lt;/code&gt;<a name="line.577"></a>
<FONT color="green">578</FONT>         *<a name="line.578"></a>
<FONT color="green">579</FONT>         * Note: Aside from overriding this method, you can also just call requireProperty(String) anytime to require a single property.<a name="line.579"></a>
<FONT color="green">580</FONT>         */<a name="line.580"></a>
<FONT color="green">581</FONT>        protected void performConfigurationDiagnostics()<a name="line.581"></a>
<FONT color="green">582</FONT>        {<a name="line.582"></a>
<FONT color="green">583</FONT>            //add default requiredProperties<a name="line.583"></a>
<FONT color="green">584</FONT>            requiredProperties().addObjectsFromArray(new NSArray(new Object[] {<a name="line.584"></a>
<FONT color="green">585</FONT>                            "WOAdaptorURL",<a name="line.585"></a>
<FONT color="green">586</FONT>                            SessionTimeOutInMinutesKey,<a name="line.586"></a>
<FONT color="green">587</FONT>                            "SessionTerminateTimeOutInSeconds",<a name="line.587"></a>
<FONT color="green">588</FONT>                            "PageCacheSize",<a name="line.588"></a>
<FONT color="green">589</FONT>                            "PermanentPageCacheSize",<a name="line.589"></a>
<FONT color="green">590</FONT>                            "CachingEnabled",<a name="line.590"></a>
<FONT color="green">591</FONT>                            "DocumentRootPath",<a name="line.591"></a>
<FONT color="green">592</FONT>                            "ErrorsTitle",<a name="line.592"></a>
<FONT color="green">593</FONT>                            "DBType",<a name="line.593"></a>
<FONT color="green">594</FONT>                            "JDBCUrl",<a name="line.594"></a>
<FONT color="green">595</FONT>                            "DBUserName",<a name="line.595"></a>
<FONT color="green">596</FONT>                            "DBPassword",<a name="line.596"></a>
<FONT color="green">597</FONT>                            "JDBCDriver",<a name="line.597"></a>
<FONT color="green">598</FONT>                            "EOFPlugin",<a name="line.598"></a>
<FONT color="green">599</FONT>                            "DateFormat",<a name="line.599"></a>
<FONT color="green">600</FONT>                            "TimeFormat",<a name="line.600"></a>
<FONT color="green">601</FONT>                            "DateTimeFormat",<a name="line.601"></a>
<FONT color="green">602</FONT>                            "IntegerFormat",<a name="line.602"></a>
<FONT color="green">603</FONT>                            "NumberFormat",<a name="line.603"></a>
<FONT color="green">604</FONT>                            "CurrencyFormat",<a name="line.604"></a>
<FONT color="green">605</FONT>                            "DevelopmentMode",<a name="line.605"></a>
<FONT color="green">606</FONT>                            "DefaultPageName",<a name="line.606"></a>
<FONT color="green">607</FONT>                            DispatchRequestsConcurrentlyPropertyKey,<a name="line.607"></a>
<FONT color="green">608</FONT>                            EditingContextClassNamePropertyKey,<a name="line.608"></a>
<FONT color="green">609</FONT>                            DefaultFetchTimestampLag,<a name="line.609"></a>
<FONT color="green">610</FONT>                            DebuggingEditingContextClassNamePropertyKey,<a name="line.610"></a>
<FONT color="green">611</FONT>                            DebugEditingContextLockingPropertyKey,<a name="line.611"></a>
<FONT color="green">612</FONT>                            LogSlowQueriesKey,<a name="line.612"></a>
<FONT color="green">613</FONT>                            LogSlowQueryThesholdInMillisecondsKey,<a name="line.613"></a>
<FONT color="green">614</FONT>                            LogFetchedRowsKey,<a name="line.614"></a>
<FONT color="green">615</FONT>                            LogSQLSourceKey<a name="line.615"></a>
<FONT color="green">616</FONT>                            }));<a name="line.616"></a>
<FONT color="green">617</FONT>    <a name="line.617"></a>
<FONT color="green">618</FONT>            Enumeration propertiesEnumerator = requiredProperties().objectEnumerator();<a name="line.618"></a>
<FONT color="green">619</FONT>            while (propertiesEnumerator.hasMoreElements())<a name="line.619"></a>
<FONT color="green">620</FONT>            {<a name="line.620"></a>
<FONT color="green">621</FONT>                String requiredProperty = (String) propertiesEnumerator.nextElement();<a name="line.621"></a>
<FONT color="green">622</FONT>                requireProperty(requiredProperty);<a name="line.622"></a>
<FONT color="green">623</FONT>            }<a name="line.623"></a>
<FONT color="green">624</FONT>    <a name="line.624"></a>
<FONT color="green">625</FONT>            if (properties().booleanPropertyForKey("DevelopmentMode"))<a name="line.625"></a>
<FONT color="green">626</FONT>            {<a name="line.626"></a>
<FONT color="green">627</FONT>                requireProperty("DeveloperID");<a name="line.627"></a>
<FONT color="green">628</FONT>                requireProperty("DeveloperPassword");<a name="line.628"></a>
<FONT color="green">629</FONT>                requireProperty("DeveloperEmail");<a name="line.629"></a>
<FONT color="green">630</FONT>            }<a name="line.630"></a>
<FONT color="green">631</FONT>        }<a name="line.631"></a>
<FONT color="green">632</FONT>    <a name="line.632"></a>
<FONT color="green">633</FONT>    <a name="line.633"></a>
<FONT color="green">634</FONT>    <a name="line.634"></a>
<FONT color="green">635</FONT>        /**<a name="line.635"></a>
<FONT color="green">636</FONT>         * Checks to see if the named property exists.  Marks the application for termination and prints a message if it does not.  This is for use by performConfigurationDiagnostics.<a name="line.636"></a>
<FONT color="green">637</FONT>         *<a name="line.637"></a>
<FONT color="green">638</FONT>         * @param propertyName the name of the property to require<a name="line.638"></a>
<FONT color="green">639</FONT>         */<a name="line.639"></a>
<FONT color="green">640</FONT>        protected void requireProperty(String propertyName)<a name="line.640"></a>
<FONT color="green">641</FONT>        {<a name="line.641"></a>
<FONT color="green">642</FONT>            /** require propertyName != null; **/<a name="line.642"></a>
<FONT color="green">643</FONT>    <a name="line.643"></a>
<FONT color="green">644</FONT>            if ( ! properties().hasPropertyForKey(propertyName))<a name="line.644"></a>
<FONT color="green">645</FONT>            {<a name="line.645"></a>
<FONT color="green">646</FONT>                terminate();    // It is required do not proceed with launching the application.<a name="line.646"></a>
<FONT color="green">647</FONT>                logger.fatal("Fatal: " +propertyName + " is not defined in application configuration information (e.g. ApplicationName.plist etc.)");<a name="line.647"></a>
<FONT color="green">648</FONT>            }<a name="line.648"></a>
<FONT color="green">649</FONT>        }<a name="line.649"></a>
<FONT color="green">650</FONT>    <a name="line.650"></a>
<FONT color="green">651</FONT>    <a name="line.651"></a>
<FONT color="green">652</FONT>    <a name="line.652"></a>
<FONT color="green">653</FONT>        /**<a name="line.653"></a>
<FONT color="green">654</FONT>         * Checks to see if the named page is mapped.  Marks the application for termination and<a name="line.654"></a>
<FONT color="green">655</FONT>         * prints a message if it does not.  This is for use by performConfigurationDiagnostics.<a name="line.655"></a>
<FONT color="green">656</FONT>         */<a name="line.656"></a>
<FONT color="green">657</FONT>        protected void requireMappingForPage(String pageName)<a name="line.657"></a>
<FONT color="green">658</FONT>        {<a name="line.658"></a>
<FONT color="green">659</FONT>            if (pageMap().objectForKey(pageName) == null)<a name="line.659"></a>
<FONT color="green">660</FONT>            {<a name="line.660"></a>
<FONT color="green">661</FONT>                terminate();    // It is required do not proceed with launching the application.<a name="line.661"></a>
<FONT color="green">662</FONT>                logger.fatal(pageName + " is not mapped in the page map file (e.g. GVCSiteMakerPageMap.plist etc.)");<a name="line.662"></a>
<FONT color="green">663</FONT>            }<a name="line.663"></a>
<FONT color="green">664</FONT>        }<a name="line.664"></a>
<FONT color="green">665</FONT>    <a name="line.665"></a>
<FONT color="green">666</FONT>    <a name="line.666"></a>
<FONT color="green">667</FONT>    <a name="line.667"></a>
<FONT color="green">668</FONT>        /**<a name="line.668"></a>
<FONT color="green">669</FONT>         * Sets up the WebObjects application environment.  IMPORTANT: When overriding this method, be sure to call super before doing anything else.<a name="line.669"></a>
<FONT color="green">670</FONT>         */<a name="line.670"></a>
<FONT color="green">671</FONT>        protected void configureWebObjectsEnvironment()<a name="line.671"></a>
<FONT color="green">672</FONT>        {<a name="line.672"></a>
<FONT color="green">673</FONT>            setAllowsConcurrentRequestHandling(appProperties().booleanPropertyForKey(DispatchRequestsConcurrentlyPropertyKey));<a name="line.673"></a>
<FONT color="green">674</FONT>            logger.info("Application is handling requests concurrently " + isConcurrentRequestHandlingEnabled());<a name="line.674"></a>
<FONT color="green">675</FONT>    <a name="line.675"></a>
<FONT color="green">676</FONT>            // Initialize WO Ognl<a name="line.676"></a>
<FONT color="green">677</FONT>            WOOgnl.factory();<a name="line.677"></a>
<FONT color="green">678</FONT>    <a name="line.678"></a>
<FONT color="green">679</FONT>            // What a mess!  Why did we decide to rename these properties?<a name="line.679"></a>
<FONT color="green">680</FONT>            String smtpHost = properties().stringPropertyForKey("SMTPHost");<a name="line.680"></a>
<FONT color="green">681</FONT>            if (smtpHost == null)<a name="line.681"></a>
<FONT color="green">682</FONT>            {<a name="line.682"></a>
<FONT color="green">683</FONT>                smtpHost = SMTPHost();<a name="line.683"></a>
<FONT color="green">684</FONT>            }<a name="line.684"></a>
<FONT color="green">685</FONT>            if (smtpHost == null)<a name="line.685"></a>
<FONT color="green">686</FONT>            {<a name="line.686"></a>
<FONT color="green">687</FONT>                smtpHost = System.getProperty("mail.smtp.host");<a name="line.687"></a>
<FONT color="green">688</FONT>            }<a name="line.688"></a>
<FONT color="green">689</FONT>            if (smtpHost != null)<a name="line.689"></a>
<FONT color="green">690</FONT>            {<a name="line.690"></a>
<FONT color="green">691</FONT>                // OK, let's get everyone on the same page<a name="line.691"></a>
<FONT color="green">692</FONT>                properties.addPropertyForKey(smtpHost, "SMTPHost");<a name="line.692"></a>
<FONT color="green">693</FONT>                setSMTPHost(smtpHost);<a name="line.693"></a>
<FONT color="green">694</FONT>                System.setProperty("mail.smtp.host", smtpHost);<a name="line.694"></a>
<FONT color="green">695</FONT>                System.setProperty("mail.transport.protocol", "smtp");<a name="line.695"></a>
<FONT color="green">696</FONT>    <a name="line.696"></a>
<FONT color="green">697</FONT>                // Please use ThreadedMailAgent instead of this<a name="line.697"></a>
<FONT color="green">698</FONT>                MailDelivery.createInstance(SMTPHost());<a name="line.698"></a>
<FONT color="green">699</FONT>            }<a name="line.699"></a>
<FONT color="green">700</FONT>    <a name="line.700"></a>
<FONT color="green">701</FONT>    <a name="line.701"></a>
<FONT color="green">702</FONT>            // Direct connect is evil<a name="line.702"></a>
<FONT color="green">703</FONT>            System.setProperty("WODirectConnectEnabled", java.lang.Boolean.FALSE.toString());<a name="line.703"></a>
<FONT color="green">704</FONT>    <a name="line.704"></a>
<FONT color="green">705</FONT>            // Set the default encoding to be UTF-8<a name="line.705"></a>
<FONT color="green">706</FONT>            WOMessage.setDefaultURLEncoding("UTF-8");<a name="line.706"></a>
<FONT color="green">707</FONT>            WOMessage.setDefaultEncoding("UTF-8");<a name="line.707"></a>
<FONT color="green">708</FONT>    <a name="line.708"></a>
<FONT color="green">709</FONT>            // This is needed for DA user search URLs that include Unicode search values<a name="line.709"></a>
<FONT color="green">710</FONT>            WORequest.setDefaultURLEncoding("UTF-8");<a name="line.710"></a>
<FONT color="green">711</FONT>    <a name="line.711"></a>
<FONT color="green">712</FONT>            setPageCacheSize(properties().intPropertyForKey("PageCacheSize"));<a name="line.712"></a>
<FONT color="green">713</FONT>            setPermanentPageCacheSize(properties().intPropertyForKey("PermanentPageCacheSize"));<a name="line.713"></a>
<FONT color="green">714</FONT>            setCachingEnabled(properties().booleanPropertyForKey("CachingEnabled"));<a name="line.714"></a>
<FONT color="green">715</FONT>    <a name="line.715"></a>
<FONT color="green">716</FONT>            setSessionTimeOut(new Integer(60 * properties().intPropertyForKey(SessionTimeOutInMinutesKey)));<a name="line.716"></a>
<FONT color="green">717</FONT>    <a name="line.717"></a>
<FONT color="green">718</FONT>            // Uses the standard WOAdaptorURL if the old name is not defined<a name="line.718"></a>
<FONT color="green">719</FONT>            if (properties().stringPropertyForKey("CGIAdaptorURL") != null)<a name="line.719"></a>
<FONT color="green">720</FONT>            {<a name="line.720"></a>
<FONT color="green">721</FONT>                logger.error("**** CGIAdaptorURL is deprecated, please use WOAdaptorURL. ****");<a name="line.721"></a>
<FONT color="green">722</FONT>                terminate();<a name="line.722"></a>
<FONT color="green">723</FONT>            }<a name="line.723"></a>
<FONT color="green">724</FONT>    <a name="line.724"></a>
<FONT color="green">725</FONT>            // This enables direct actions, thus allowing the mainPage to be renamed. The default request<a name="line.725"></a>
<FONT color="green">726</FONT>            // handler must be changed to avoid a bug which is manifested by a new session being created<a name="line.726"></a>
<FONT color="green">727</FONT>            // when the request URI is of the from http://www.myserver.com/cgi-bin/WebObjects/MyApp.woa<a name="line.727"></a>
<FONT color="green">728</FONT>            // even though there is a wosid cookie with a valid, unexpired session ID in the request.<a name="line.728"></a>
<FONT color="green">729</FONT>            // Possibly related is that request.sessionID() returns null in this case, while works as<a name="line.729"></a>
<FONT color="green">730</FONT>            // expected for URLs which have a request handler key.  The WORequest docs state that sessionID()<a name="line.730"></a>
<FONT color="green">731</FONT>            // "Returns the session ID, or null if no session ID is found. This method first looks for the<a name="line.731"></a>
<FONT color="green">732</FONT>            // session ID in the URL, then checks the form values, and finally checks to see if the session<a name="line.732"></a>
<FONT color="green">733</FONT>            // ID is stored in a cookie."  This does not seem to be happening.<a name="line.733"></a>
<FONT color="green">734</FONT>            setDefaultRequestHandler(requestHandlerForKey(directActionRequestHandlerKey()));<a name="line.734"></a>
<FONT color="green">735</FONT>    <a name="line.735"></a>
<FONT color="green">736</FONT>            // Query logging<a name="line.736"></a>
<FONT color="green">737</FONT>            if (properties().booleanPropertyForKey(LogSlowQueriesKey) ||<a name="line.737"></a>
<FONT color="green">738</FONT>                properties().booleanPropertyForKey(LogFetchedRowsKey) ||<a name="line.738"></a>
<FONT color="green">739</FONT>                properties().booleanPropertyForKey(LogSQLSourceKey))<a name="line.739"></a>
<FONT color="green">740</FONT>            {<a name="line.740"></a>
<FONT color="green">741</FONT>                SQLLoggingAdaptorChannelDelegate.installDelegate(properties().booleanPropertyForKey(LogSlowQueriesKey),<a name="line.741"></a>
<FONT color="green">742</FONT>                                                                 properties().longPropertyForKey(LogSlowQueryThesholdInMillisecondsKey),<a name="line.742"></a>
<FONT color="green">743</FONT>                                                                 properties().booleanPropertyForKey(LogFetchedRowsKey),<a name="line.743"></a>
<FONT color="green">744</FONT>                                                                 properties().booleanPropertyForKey(LogSQLSourceKey));<a name="line.744"></a>
<FONT color="green">745</FONT>            }<a name="line.745"></a>
<FONT color="green">746</FONT>    <a name="line.746"></a>
<FONT color="green">747</FONT>            // Set EditingContext snapshot timeout so that data is frequently refetched to compensate for multiple instances.<a name="line.747"></a>
<FONT color="green">748</FONT>            EOEditingContext.setDefaultFetchTimestampLag( properties().intPropertyForKey(DefaultFetchTimestampLag) );<a name="line.748"></a>
<FONT color="green">749</FONT>            logger.info("EC DefaultFetchTimestampLag is set to " + (EOEditingContext.defaultFetchTimestampLag()/1000) + " seconds" );<a name="line.749"></a>
<FONT color="green">750</FONT>    <a name="line.750"></a>
<FONT color="green">751</FONT>        }<a name="line.751"></a>
<FONT color="green">752</FONT>    <a name="line.752"></a>
<FONT color="green">753</FONT>    <a name="line.753"></a>
<FONT color="green">754</FONT>    <a name="line.754"></a>
<FONT color="green">755</FONT>        /**<a name="line.755"></a>
<FONT color="green">756</FONT>         * Creates formatters for each date and number format and removes the format strings so that they do not get used by accident.<a name="line.756"></a>
<FONT color="green">757</FONT>         */<a name="line.757"></a>
<FONT color="green">758</FONT>        protected void createFormatters()<a name="line.758"></a>
<FONT color="green">759</FONT>        {<a name="line.759"></a>
<FONT color="green">760</FONT>            //date formatters<a name="line.760"></a>
<FONT color="green">761</FONT>            properties().createDateFormatter("DateFormat");<a name="line.761"></a>
<FONT color="green">762</FONT>            properties().createDateFormatter("TimeFormat");<a name="line.762"></a>
<FONT color="green">763</FONT>            properties().createDateFormatter("DateTimeFormat");<a name="line.763"></a>
<FONT color="green">764</FONT>    <a name="line.764"></a>
<FONT color="green">765</FONT>            //number formatters<a name="line.765"></a>
<FONT color="green">766</FONT>            properties().createNumberFormatter("IntegerFormat");<a name="line.766"></a>
<FONT color="green">767</FONT>            properties().createNumberFormatter("NumberFormat");<a name="line.767"></a>
<FONT color="green">768</FONT>            properties().createNumberFormatter("CurrencyFormat");<a name="line.768"></a>
<FONT color="green">769</FONT>        }<a name="line.769"></a>
<FONT color="green">770</FONT>    <a name="line.770"></a>
<FONT color="green">771</FONT>    <a name="line.771"></a>
<FONT color="green">772</FONT>    <a name="line.772"></a>
<FONT color="green">773</FONT>        /**<a name="line.773"></a>
<FONT color="green">774</FONT>         * WO 5.4 version.  Creates and returns a request configured to use UTF-8 for the &lt;code&gt;defaultFormValueEncoding()&lt;/code&gt;.<a name="line.774"></a>
<FONT color="green">775</FONT>         * This is done here as doing it in takeValueFromRequest was too late when the form used<a name="line.775"></a>
<FONT color="green">776</FONT>         * &lt;code&gt;enctype="multipart/form-data&lt;/code&gt;.  Multi-part form data triggers the new streaming<a name="line.776"></a>
<FONT color="green">777</FONT>         * handling and changing the encoding after the stream has been read discards the form values.<a name="line.777"></a>
<FONT color="green">778</FONT>         * This might also have been because some of our code peeked at the form values.<a name="line.778"></a>
<FONT color="green">779</FONT>         */<a name="line.779"></a>
<FONT color="green">780</FONT>        public WORequest createRequest(String aMethod, String aURL, String anHTTPVersion,<a name="line.780"></a>
<FONT color="green">781</FONT>                                       Map someHeaders, NSData aContent,<a name="line.781"></a>
<FONT color="green">782</FONT>                                       Map someInfo)<a name="line.782"></a>
<FONT color="green">783</FONT>        {<a name="line.783"></a>
<FONT color="green">784</FONT>            // Workaround for Safari on Leopard bug (post followed by redirect to GET incorrectly has content-type header).<a name="line.784"></a>
<FONT color="green">785</FONT>            // The content-type header makes the WO parser only look at the content. Which is empty.<a name="line.785"></a>
<FONT color="green">786</FONT>            // http://lists.macosforge.org/pipermail/webkit-unassigned/2007-November/053847.html<a name="line.786"></a>
<FONT color="green">787</FONT>            // http://jira.atlassian.com/browse/JRA-13791<a name="line.787"></a>
<FONT color="green">788</FONT>            if ("GET".equalsIgnoreCase(aMethod) &amp;&amp; someHeaders != null &amp;&amp; someHeaders.get("content-type") != null)<a name="line.788"></a>
<FONT color="green">789</FONT>            {<a name="line.789"></a>
<FONT color="green">790</FONT>                someHeaders.remove("content-type");<a name="line.790"></a>
<FONT color="green">791</FONT>            }<a name="line.791"></a>
<FONT color="green">792</FONT>    <a name="line.792"></a>
<FONT color="green">793</FONT>            WORequest newRequest = new Request(<a name="line.793"></a>
<FONT color="green">794</FONT>                    aMethod,<a name="line.794"></a>
<FONT color="green">795</FONT>                    aURL,<a name="line.795"></a>
<FONT color="green">796</FONT>                    anHTTPVersion,<a name="line.796"></a>
<FONT color="green">797</FONT>                    someHeaders == null ? null : new NSDictionary(someHeaders),<a name="line.797"></a>
<FONT color="green">798</FONT>                    aContent,<a name="line.798"></a>
<FONT color="green">799</FONT>                    someInfo == null ? null : new NSDictionary(someInfo));<a name="line.799"></a>
<FONT color="green">800</FONT>            newRequest.setDefaultFormValueEncoding("UTF-8");<a name="line.800"></a>
<FONT color="green">801</FONT>            return newRequest;<a name="line.801"></a>
<FONT color="green">802</FONT>        }<a name="line.802"></a>
<FONT color="green">803</FONT>    <a name="line.803"></a>
<FONT color="green">804</FONT>    <a name="line.804"></a>
<FONT color="green">805</FONT>        /**<a name="line.805"></a>
<FONT color="green">806</FONT>         * WO 5.3 and prior version Creates and returns a request configured to use UTF-8 for the &lt;code&gt;defaultFormValueEncoding()&lt;/code&gt;.<a name="line.806"></a>
<FONT color="green">807</FONT>         * This is done here as doing it in takeValueFromRequest was too late when the form used<a name="line.807"></a>
<FONT color="green">808</FONT>         * &lt;code&gt;enctype="multipart/form-data&lt;/code&gt;.  Multi-part form data triggers the new streaming<a name="line.808"></a>
<FONT color="green">809</FONT>         * handling and changing the encoding after the stream has been read discards the form values.<a name="line.809"></a>
<FONT color="green">810</FONT>         * This might also have been because some of our code peeked at the form values.<a name="line.810"></a>
<FONT color="green">811</FONT>         */<a name="line.811"></a>
<FONT color="green">812</FONT>        public WORequest createRequest(String aMethod,<a name="line.812"></a>
<FONT color="green">813</FONT>                                       String aURL,<a name="line.813"></a>
<FONT color="green">814</FONT>                                       String anHTTPVersion,<a name="line.814"></a>
<FONT color="green">815</FONT>                                       NSDictionary someHeaders,<a name="line.815"></a>
<FONT color="green">816</FONT>                                       NSData aContent,<a name="line.816"></a>
<FONT color="green">817</FONT>                                       NSDictionary someInfo)<a name="line.817"></a>
<FONT color="green">818</FONT>        {<a name="line.818"></a>
<FONT color="green">819</FONT>            // Workaround for Safari on Leopard bug (post followed by redirect to GET incorrectly has content-type header).<a name="line.819"></a>
<FONT color="green">820</FONT>            // The content-type header makes the WO parser only look at the content. Which is empty.<a name="line.820"></a>
<FONT color="green">821</FONT>            // http://lists.macosforge.org/pipermail/webkit-unassigned/2007-November/053847.html<a name="line.821"></a>
<FONT color="green">822</FONT>            // http://jira.atlassian.com/browse/JRA-13791<a name="line.822"></a>
<FONT color="green">823</FONT>            if ("GET".equalsIgnoreCase(aMethod) &amp;&amp; someHeaders != null &amp;&amp; someHeaders.objectForKey("content-type") != null)<a name="line.823"></a>
<FONT color="green">824</FONT>            {<a name="line.824"></a>
<FONT color="green">825</FONT>                someHeaders = someHeaders.mutableClone();<a name="line.825"></a>
<FONT color="green">826</FONT>                ((NSMutableDictionary)someHeaders).removeObjectForKey("content-type");<a name="line.826"></a>
<FONT color="green">827</FONT>            }<a name="line.827"></a>
<FONT color="green">828</FONT>    <a name="line.828"></a>
<FONT color="green">829</FONT>            WORequest newRequest = new Request(aMethod, aURL, anHTTPVersion, someHeaders, aContent, someInfo);<a name="line.829"></a>
<FONT color="green">830</FONT>            newRequest.setDefaultFormValueEncoding("UTF-8");<a name="line.830"></a>
<FONT color="green">831</FONT>            return newRequest;<a name="line.831"></a>
<FONT color="green">832</FONT>        }<a name="line.832"></a>
<FONT color="green">833</FONT>    <a name="line.833"></a>
<FONT color="green">834</FONT>    <a name="line.834"></a>
<FONT color="green">835</FONT>    <a name="line.835"></a>
<FONT color="green">836</FONT>        /**<a name="line.836"></a>
<FONT color="green">837</FONT>         * When a context is created we push it into thread local storage.<a name="line.837"></a>
<FONT color="green">838</FONT>         *<a name="line.838"></a>
<FONT color="green">839</FONT>         * @see #applicationDidHandleRequest(NSNotification)<a name="line.839"></a>
<FONT color="green">840</FONT>         * @param request the request<a name="line.840"></a>
<FONT color="green">841</FONT>         * @return the newly created context<a name="line.841"></a>
<FONT color="green">842</FONT>         */<a name="line.842"></a>
<FONT color="green">843</FONT>        public WOContext createContextForRequest(WORequest request) {<a name="line.843"></a>
<FONT color="green">844</FONT>            WOContext context = super.createContextForRequest(request);<a name="line.844"></a>
<FONT color="green">845</FONT>            // We only want to push in the context the first time it is<a name="line.845"></a>
<FONT color="green">846</FONT>            // created, ie we don't want to lose the current context<a name="line.846"></a>
<FONT color="green">847</FONT>            // when we create a context for an error page.<a name="line.847"></a>
<FONT color="green">848</FONT>            if (ERXWOContext.currentContext() == null) {<a name="line.848"></a>
<FONT color="green">849</FONT>                ERXWOContext.setCurrentContext(context);<a name="line.849"></a>
<FONT color="green">850</FONT>            }<a name="line.850"></a>
<FONT color="green">851</FONT>            return context;<a name="line.851"></a>
<FONT color="green">852</FONT>        }<a name="line.852"></a>
<FONT color="green">853</FONT>    <a name="line.853"></a>
<FONT color="green">854</FONT>    <a name="line.854"></a>
<FONT color="green">855</FONT>    <a name="line.855"></a>
<FONT color="green">856</FONT>        /**<a name="line.856"></a>
<FONT color="green">857</FONT>         * When request is finished, we remove the context from thread local storage.<a name="line.857"></a>
<FONT color="green">858</FONT>         *<a name="line.858"></a>
<FONT color="green">859</FONT>         * @see #createContextForRequest(WORequest)<a name="line.859"></a>
<FONT color="green">860</FONT>         * @param n notification<a name="line.860"></a>
<FONT color="green">861</FONT>         */<a name="line.861"></a>
<FONT color="green">862</FONT>        public void applicationDidHandleRequest(NSNotification n) {<a name="line.862"></a>
<FONT color="green">863</FONT>            ERXWOContext.setCurrentContext(null);<a name="line.863"></a>
<FONT color="green">864</FONT>            ERXThreadStorage.removeValueForKey(ERXWOContext.CONTEXT_DICTIONARY_KEY);<a name="line.864"></a>
<FONT color="green">865</FONT>        }<a name="line.865"></a>
<FONT color="green">866</FONT>    <a name="line.866"></a>
<FONT color="green">867</FONT>    <a name="line.867"></a>
<FONT color="green">868</FONT>    <a name="line.868"></a>
<FONT color="green">869</FONT>        /**<a name="line.869"></a>
<FONT color="green">870</FONT>         * @see Response<a name="line.870"></a>
<FONT color="green">871</FONT>         * @return Response instead of WOResponse<a name="line.871"></a>
<FONT color="green">872</FONT>         */<a name="line.872"></a>
<FONT color="green">873</FONT>        public WOResponse createResponseInContext(WOContext context)<a name="line.873"></a>
<FONT color="green">874</FONT>        {<a name="line.874"></a>
<FONT color="green">875</FONT>            return new Response(context);<a name="line.875"></a>
<FONT color="green">876</FONT>        }<a name="line.876"></a>
<FONT color="green">877</FONT>    <a name="line.877"></a>
<FONT color="green">878</FONT>    <a name="line.878"></a>
<FONT color="green">879</FONT>    <a name="line.879"></a>
<FONT color="green">880</FONT>        /**<a name="line.880"></a>
<FONT color="green">881</FONT>         * Overidden to provide debugging hooks.<a name="line.881"></a>
<FONT color="green">882</FONT>         */<a name="line.882"></a>
<FONT color="green">883</FONT>        public WOResponse dispatchRequest(WORequest request)<a name="line.883"></a>
<FONT color="green">884</FONT>        {<a name="line.884"></a>
<FONT color="green">885</FONT>            /** require [valid_param] request != null; **/<a name="line.885"></a>
<FONT color="green">886</FONT>    <a name="line.886"></a>
<FONT color="green">887</FONT>            /*<a name="line.887"></a>
<FONT color="green">888</FONT>             * Hack for cooking parsing bug in WO 5.2<a name="line.888"></a>
<FONT color="green">889</FONT>             * WO Cookie parser actually handles empty values as long as they are not<a name="line.889"></a>
<FONT color="green">890</FONT>             * the last value in the list, because often there is no trailing  semi-colon.<a name="line.890"></a>
<FONT color="green">891</FONT>             * The easiest fix is as follows and results in the expected behavior:<a name="line.891"></a>
<FONT color="green">892</FONT>             * CookieParser: Found a null cookie value in: 'woinst=-1; wosid=;'. Will<a name="line.892"></a>
<FONT color="green">893</FONT>             * continue by setting value to the empty string.  WHEREAS, confound it,<a name="line.893"></a>
<FONT color="green">894</FONT>             * I simply could not get  WOApplication.handleMalformedCookieString()<a name="line.894"></a>
<FONT color="green">895</FONT>             * to correct the situation because you don't have access to the request<a name="line.895"></a>
<FONT color="green">896</FONT>             * object, and modifying the mutable dictionary simply had no effect.<a name="line.896"></a>
<FONT color="green">897</FONT>             * Christopher Legan, cklegan@king.net, Kiwi InterNet Group, Inc.<a name="line.897"></a>
<FONT color="green">898</FONT>             */<a name="line.898"></a>
<FONT color="green">899</FONT>            String cookieHeader = request.headerForKey(CookieHeaderKey);<a name="line.899"></a>
<FONT color="green">900</FONT>            if (cookieHeader != null &amp;&amp; ! cookieHeader.endsWith(";"))<a name="line.900"></a>
<FONT color="green">901</FONT>            {<a name="line.901"></a>
<FONT color="green">902</FONT>                request.setHeader(cookieHeader.concat(";"), CookieHeaderKey);<a name="line.902"></a>
<FONT color="green">903</FONT>            }<a name="line.903"></a>
<FONT color="green">904</FONT>    <a name="line.904"></a>
<FONT color="green">905</FONT>            WOResponse response;<a name="line.905"></a>
<FONT color="green">906</FONT>            boolean isntResourceRequest = request.uri().indexOf("/wr") == -1;        // Don't log image requests<a name="line.906"></a>
<FONT color="green">907</FONT>            if (isntResourceRequest &amp;&amp; rrLoopLogger.isInfoEnabled())<a name="line.907"></a>
<FONT color="green">908</FONT>            {<a name="line.908"></a>
<FONT color="green">909</FONT>                // Debugging code for the Request - Response loop.<a name="line.909"></a>
<FONT color="green">910</FONT>                rrLoopLogger.info("=========== Cycle Start for URI " + request.uri());<a name="line.910"></a>
<FONT color="green">911</FONT>                rrLoopLogger.debug("Request's cookies: " + request.headerForKey(CookieHeaderKey));<a name="line.911"></a>
<FONT color="green">912</FONT>                rrLoopLogger.info("          form values: " + request.formValues());<a name="line.912"></a>
<FONT color="green">913</FONT>                if (rrLoopLogger.isTraceEnabled()) rrLoopLogger.trace("Request's headers: " + request.headers());<a name="line.913"></a>
<FONT color="green">914</FONT>                NSTimestamp startTime = new NSTimestamp();<a name="line.914"></a>
<FONT color="green">915</FONT>    <a name="line.915"></a>
<FONT color="green">916</FONT>                response = super.dispatchRequest(request);<a name="line.916"></a>
<FONT color="green">917</FONT>                NSTimestamp stopTime = new NSTimestamp();<a name="line.917"></a>
<FONT color="green">918</FONT>                long milliseconds = stopTime.getTime() - startTime.getTime();<a name="line.918"></a>
<FONT color="green">919</FONT>    <a name="line.919"></a>
<FONT color="green">920</FONT>                //* Cookie and session debugging code.<a name="line.920"></a>
<FONT color="green">921</FONT>                rrLoopLogger.debug("Response cookies " + response.cookies());<a name="line.921"></a>
<FONT color="green">922</FONT>                if (rrLoopLogger.isTraceEnabled()) rrLoopLogger.trace("Response headers: " + response.headers());<a name="line.922"></a>
<FONT color="green">923</FONT>                rrLoopLogger.info("," + request.uri() + ", - elapsed time: ," + (milliseconds / 1000.0) );<a name="line.923"></a>
<FONT color="green">924</FONT>                rrLoopLogger.info("\n");<a name="line.924"></a>
<FONT color="green">925</FONT>            }<a name="line.925"></a>
<FONT color="green">926</FONT>            else<a name="line.926"></a>
<FONT color="green">927</FONT>            {<a name="line.927"></a>
<FONT color="green">928</FONT>                response = super.dispatchRequest(request);<a name="line.928"></a>
<FONT color="green">929</FONT>            }<a name="line.929"></a>
<FONT color="green">930</FONT>    <a name="line.930"></a>
<FONT color="green">931</FONT>            /*<a name="line.931"></a>
<FONT color="green">932</FONT>             * From: Gary Teter &lt;bigdog@wirehose.com&gt;<a name="line.932"></a>
<FONT color="green">933</FONT>             * Date: December 7, 2008 12:44:23 PM PST (CA)<a name="line.933"></a>
<FONT color="green">934</FONT>             * To: Development WebObjects &lt;webobjects-dev@lists.apple.com&gt;<a name="line.934"></a>
<FONT color="green">935</FONT>             * Subject: Re: [SOLVED] Baffling problem with foreign key<a name="line.935"></a>
<FONT color="green">936</FONT>             *<a name="line.936"></a>
<FONT color="green">937</FONT>             * I finally figured out what's going on, and I think it's a fundamental flaw in WebObjects. Fortunately Ralf's suggestion is a good-enough workaround:<a name="line.937"></a>
<FONT color="green">938</FONT>             *<a name="line.938"></a>
<FONT color="green">939</FONT>             *      A workaround may be to call "EOObserverCenter.notifyObserversObjectWillChange(null)" at strategic places like in Application.dispatchRequest().<a name="line.939"></a>
<FONT color="green">940</FONT>             *<a name="line.940"></a>
<FONT color="green">941</FONT>             * What's supposed to happen: You change an attribute on an eo, which calls willChange(), which calls EOObserverCenter.notifyObserversObjectWillChange(this).<a name="line.941"></a>
<FONT color="green">942</FONT>             * The observer center notes that this was the most recently observed object for this thread, and calls editingContext.objectWillChange. The ec then grabs<a name="line.942"></a>
<FONT color="green">943</FONT>             * the current snapshot of the object, and then the attribute is finally changed in the eo. Any further calls to willChange &gt;in the current thread&lt; on the<a name="line.943"></a>
<FONT color="green">944</FONT>             * eo are ignored by the EOObserverCenter. When the ec saves changes, it calls notifyObserversObjectWillChange(null) so any future changes to the eo get<a name="line.944"></a>
<FONT color="green">945</FONT>             * noticed again.<a name="line.945"></a>
<FONT color="green">946</FONT>             *<a name="line.946"></a>
<FONT color="green">947</FONT>             * How it fails: A request is handled by WorkerThread0. By the end of the request the eo has been modified but not saved, so the EOObserverCenter remembers<a name="line.947"></a>
<FONT color="green">948</FONT>             * that WorkerThread0's most recent object is that eo. Fifteen more requests are handled by WorkerThreads 1-15 in sequence. One of these requests completes<a name="line.948"></a>
<FONT color="green">949</FONT>             * the modification of the eo and calls saveChanges on the ec. At this point the ec tells the EOObserverCenter to forget about its most recent object, but<a name="line.949"></a>
<FONT color="green">950</FONT>             * it's being set to null in WorkerThread14 or whatever, not WorkerThread0.<a name="line.950"></a>
<FONT color="green">951</FONT>             *<a name="line.951"></a>
<FONT color="green">952</FONT>             * The next request will wrap around to to be handled by WorkerThread0. This request modifies an attribute on the eo, but since the EOObserverCenter still<a name="line.952"></a>
<FONT color="green">953</FONT>             *  thinks WorkerThread0 has already noticed the eo, it ignores the willChange and the ec doesn't grab a snapshot.<a name="line.953"></a>
<FONT color="green">954</FONT>             *<a name="line.954"></a>
<FONT color="green">955</FONT>             * Later in the processing of this request, a different object gets changed, willChange gets called and the ec grabs a snapshot of the second object. Then,<a name="line.955"></a>
<FONT color="green">956</FONT>             * a change gets made to the original eo, willChange gets called, and since the EOObserverCenter was paying attention to the second object, it goes ahead<a name="line.956"></a>
<FONT color="green">957</FONT>             * and notifies the ec about the first object.<a name="line.957"></a>
<FONT color="green">958</FONT>             *<a name="line.958"></a>
<FONT color="green">959</FONT>             * At this point the ec grabs a snapshot of the first object, but it's too late -- the object has already been modified, the ec didn't know about the<a name="line.959"></a>
<FONT color="green">960</FONT>             * previous change, so when saveChanges gets called the previous changes don't get saved to the database. And now your object graph no longer matches the<a name="line.960"></a>
<FONT color="green">961</FONT>             * database, and your app is borked.<a name="line.961"></a>
<FONT color="green">962</FONT>             */<a name="line.962"></a>
<FONT color="green">963</FONT>            EOObserverCenter.notifyObserversObjectWillChange(null);<a name="line.963"></a>
<FONT color="green">964</FONT>    <a name="line.964"></a>
<FONT color="green">965</FONT>            return response;<a name="line.965"></a>
<FONT color="green">966</FONT>        }<a name="line.966"></a>
<FONT color="green">967</FONT>    <a name="line.967"></a>
<FONT color="green">968</FONT>    <a name="line.968"></a>
<FONT color="green">969</FONT>    <a name="line.969"></a>
<FONT color="green">970</FONT>        /**<a name="line.970"></a>
<FONT color="green">971</FONT>         * This method returns the URL that is used to access the default page for this application.<a name="line.971"></a>
<FONT color="green">972</FONT>         * This can be used to re-enter the application without a session.<a name="line.972"></a>
<FONT color="green">973</FONT>         *<a name="line.973"></a>
<FONT color="green">974</FONT>         * @return the URL that is used to access the default page for this application. This can be used to re-enter the application without a session<a name="line.974"></a>
<FONT color="green">975</FONT>         */<a name="line.975"></a>
<FONT color="green">976</FONT>        public String frontDoorURL()<a name="line.976"></a>
<FONT color="green">977</FONT>        {<a name="line.977"></a>
<FONT color="green">978</FONT>            return properties().stringPropertyForKey("FrontDoorURL");<a name="line.978"></a>
<FONT color="green">979</FONT>        }<a name="line.979"></a>
<FONT color="green">980</FONT>    <a name="line.980"></a>
<FONT color="green">981</FONT>    <a name="line.981"></a>
<FONT color="green">982</FONT>    <a name="line.982"></a>
<FONT color="green">983</FONT>        /**<a name="line.983"></a>
<FONT color="green">984</FONT>         * Convenience method to obtain the document root path<a name="line.984"></a>
<FONT color="green">985</FONT>         *<a name="line.985"></a>
<FONT color="green">986</FONT>         * @return the path for DocumentRoot from CustomInfo.plist<a name="line.986"></a>
<FONT color="green">987</FONT>         */<a name="line.987"></a>
<FONT color="green">988</FONT>        public String documentRootPath()<a name="line.988"></a>
<FONT color="green">989</FONT>        {<a name="line.989"></a>
<FONT color="green">990</FONT>            return properties().stringPropertyForKey("DocumentRootPath");<a name="line.990"></a>
<FONT color="green">991</FONT>        }<a name="line.991"></a>
<FONT color="green">992</FONT>    <a name="line.992"></a>
<FONT color="green">993</FONT>    <a name="line.993"></a>
<FONT color="green">994</FONT>    <a name="line.994"></a>
<FONT color="green">995</FONT>        /**<a name="line.995"></a>
<FONT color="green">996</FONT>         * The name of the page to be shown when the requested page can not be shown. This method must be overridden in the application<a name="line.996"></a>
<FONT color="green">997</FONT>         * This is the default page to show for<a name="line.997"></a>
<FONT color="green">998</FONT>         * &lt;ul&gt;<a name="line.998"></a>
<FONT color="green">999</FONT>         *         &lt;li&gt; handlePageRestorationError&lt;/li&gt;<a name="line.999"></a>
<FONT color="green">1000</FONT>         *         &lt;li&gt; handleSessionCreationError&lt;/li&gt;<a name="line.1000"></a>
<FONT color="green">1001</FONT>         *         &lt;li&gt; handleSessionRestorationError&lt;/li&gt;<a name="line.1001"></a>
<FONT color="green">1002</FONT>         *         &lt;li&gt; handleException&lt;/li&gt;<a name="line.1002"></a>
<FONT color="green">1003</FONT>         * &lt;/ul&gt;<a name="line.1003"></a>
<FONT color="green">1004</FONT>         *<a name="line.1004"></a>
<FONT color="green">1005</FONT>         * @return the name of the page to display<a name="line.1005"></a>
<FONT color="green">1006</FONT>         */<a name="line.1006"></a>
<FONT color="green">1007</FONT>        public String defaultPageName()<a name="line.1007"></a>
<FONT color="green">1008</FONT>        {<a name="line.1008"></a>
<FONT color="green">1009</FONT>            return properties().stringPropertyForKey("DefaultPageName");<a name="line.1009"></a>
<FONT color="green">1010</FONT>    <a name="line.1010"></a>
<FONT color="green">1011</FONT>            /** ensure [valid_result] Result != null; [result_has_nonzero_length] Result.length() &gt; 0; **/<a name="line.1011"></a>
<FONT color="green">1012</FONT>        }<a name="line.1012"></a>
<FONT color="green">1013</FONT>    <a name="line.1013"></a>
<FONT color="green">1014</FONT>    <a name="line.1014"></a>
<FONT color="green">1015</FONT>    <a name="line.1015"></a>
<FONT color="green">1016</FONT>        /**<a name="line.1016"></a>
<FONT color="green">1017</FONT>         * The name of the page to be shown by handlePageRestorationErrorInContext().  The default is defaultPage(). Override this method to provide different functionality in your application.<a name="line.1017"></a>
<FONT color="green">1018</FONT>         *<a name="line.1018"></a>
<FONT color="green">1019</FONT>         * @return the name of the defaultPage() which will be shown next<a name="line.1019"></a>
<FONT color="green">1020</FONT>         */<a name="line.1020"></a>
<FONT color="green">1021</FONT>        public String pageRestorationErrorPageName()<a name="line.1021"></a>
<FONT color="green">1022</FONT>        {<a name="line.1022"></a>
<FONT color="green">1023</FONT>            return properties().hasPropertyForKey("PageRestorationErrorPageName") ? properties().stringPropertyForKey("PageRestorationErrorPageName") : defaultPageName();<a name="line.1023"></a>
<FONT color="green">1024</FONT>    <a name="line.1024"></a>
<FONT color="green">1025</FONT>            /** ensure [valid_result] Result != null; [result_has_nonzero_length] Result.length() &gt; 0; **/<a name="line.1025"></a>
<FONT color="green">1026</FONT>        }<a name="line.1026"></a>
<FONT color="green">1027</FONT>    <a name="line.1027"></a>
<FONT color="green">1028</FONT>    <a name="line.1028"></a>
<FONT color="green">1029</FONT>    <a name="line.1029"></a>
<FONT color="green">1030</FONT>        /**<a name="line.1030"></a>
<FONT color="green">1031</FONT>         * This method defines the response for handling backtracking beyond the page cache.<a name="line.1031"></a>
<FONT color="green">1032</FONT>         *<a name="line.1032"></a>
<FONT color="green">1033</FONT>         * @param aContext The context to use for obtaining the page<a name="line.1033"></a>
<FONT color="green">1034</FONT>         * @return the response from the next page to display<a name="line.1034"></a>
<FONT color="green">1035</FONT>         */<a name="line.1035"></a>
<FONT color="green">1036</FONT>        public WOResponse handlePageRestorationErrorInContext(WOContext aContext)<a name="line.1036"></a>
<FONT color="green">1037</FONT>        {<a name="line.1037"></a>
<FONT color="green">1038</FONT>            /** require [valid_param] aContext != null; **/<a name="line.1038"></a>
<FONT color="green">1039</FONT>    <a name="line.1039"></a>
<FONT color="green">1040</FONT>            WOComponent errorPage = pageWithName(pageRestorationErrorPageName(), aContext);<a name="line.1040"></a>
<FONT color="green">1041</FONT>            WOResponse response = null;<a name="line.1041"></a>
<FONT color="green">1042</FONT>            if (AjaxUtils.isAjaxRequest(aContext.request()))<a name="line.1042"></a>
<FONT color="green">1043</FONT>            {<a name="line.1043"></a>
<FONT color="green">1044</FONT>                AjaxUtils.redirectTo(errorPage);<a name="line.1044"></a>
<FONT color="green">1045</FONT>                response = errorPage.context().response();<a name="line.1045"></a>
<FONT color="green">1046</FONT>                aContext.session().savePage(errorPage);<a name="line.1046"></a>
<FONT color="green">1047</FONT>            }<a name="line.1047"></a>
<FONT color="green">1048</FONT>            else<a name="line.1048"></a>
<FONT color="green">1049</FONT>            {<a name="line.1049"></a>
<FONT color="green">1050</FONT>                response = errorPage.generateResponse();<a name="line.1050"></a>
<FONT color="green">1051</FONT>            }<a name="line.1051"></a>
<FONT color="green">1052</FONT>    <a name="line.1052"></a>
<FONT color="green">1053</FONT>            response.setStatus(500);<a name="line.1053"></a>
<FONT color="green">1054</FONT>            return response;<a name="line.1054"></a>
<FONT color="green">1055</FONT>    <a name="line.1055"></a>
<FONT color="green">1056</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1056"></a>
<FONT color="green">1057</FONT>        }<a name="line.1057"></a>
<FONT color="green">1058</FONT>    <a name="line.1058"></a>
<FONT color="green">1059</FONT>    <a name="line.1059"></a>
<FONT color="green">1060</FONT>    <a name="line.1060"></a>
<FONT color="green">1061</FONT>        /**<a name="line.1061"></a>
<FONT color="green">1062</FONT>         * Overridden to log out messages when cookie parsing fails.<a name="line.1062"></a>
<FONT color="green">1063</FONT>         */<a name="line.1063"></a>
<FONT color="green">1064</FONT>        public NSMutableDictionary handleMalformedCookieString(RuntimeException exception,<a name="line.1064"></a>
<FONT color="green">1065</FONT>                                                               String cookieString,<a name="line.1065"></a>
<FONT color="green">1066</FONT>                                                               NSMutableDictionary parsedCookies)<a name="line.1066"></a>
<FONT color="green">1067</FONT>        {<a name="line.1067"></a>
<FONT color="green">1068</FONT>            logger.info("Error parsing cookieString: '" + cookieString + "'");<a name="line.1068"></a>
<FONT color="green">1069</FONT>            logger.info("      exception: " + exception);<a name="line.1069"></a>
<FONT color="green">1070</FONT>    <a name="line.1070"></a>
<FONT color="green">1071</FONT>            return parsedCookies;<a name="line.1071"></a>
<FONT color="green">1072</FONT>        }<a name="line.1072"></a>
<FONT color="green">1073</FONT>    <a name="line.1073"></a>
<FONT color="green">1074</FONT>    <a name="line.1074"></a>
<FONT color="green">1075</FONT>    <a name="line.1075"></a>
<FONT color="green">1076</FONT>        /**<a name="line.1076"></a>
<FONT color="green">1077</FONT>         * Name of the page to display when an error occurred while creating a session. Override this method to provide different functionality in your application.<a name="line.1077"></a>
<FONT color="green">1078</FONT>         *<a name="line.1078"></a>
<FONT color="green">1079</FONT>         * @return the name of the defaultPage() which will be shown next<a name="line.1079"></a>
<FONT color="green">1080</FONT>         */<a name="line.1080"></a>
<FONT color="green">1081</FONT>        public String sessionCreationErrorPageName()<a name="line.1081"></a>
<FONT color="green">1082</FONT>        {<a name="line.1082"></a>
<FONT color="green">1083</FONT>            return properties().hasPropertyForKey("SessionCreationErrorPageName") ? properties().stringPropertyForKey("SessionCreationErrorPageName") : defaultPageName();<a name="line.1083"></a>
<FONT color="green">1084</FONT>    <a name="line.1084"></a>
<FONT color="green">1085</FONT>            /** ensure<a name="line.1085"></a>
<FONT color="green">1086</FONT>            [valid_result] Result != null;<a name="line.1086"></a>
<FONT color="green">1087</FONT>            [result_has_nonzero_length] Result.length() &gt; 0; **/<a name="line.1087"></a>
<FONT color="green">1088</FONT>        }<a name="line.1088"></a>
<FONT color="green">1089</FONT>    <a name="line.1089"></a>
<FONT color="green">1090</FONT>    <a name="line.1090"></a>
<FONT color="green">1091</FONT>    <a name="line.1091"></a>
<FONT color="green">1092</FONT>        /**<a name="line.1092"></a>
<FONT color="green">1093</FONT>         * This method defines the response for handling a session creation errors.<a name="line.1093"></a>
<FONT color="green">1094</FONT>         *<a name="line.1094"></a>
<FONT color="green">1095</FONT>         * @param aContext The context to use for obtaining the page<a name="line.1095"></a>
<FONT color="green">1096</FONT>         * @return the response from the next page to display<a name="line.1096"></a>
<FONT color="green">1097</FONT>         */<a name="line.1097"></a>
<FONT color="green">1098</FONT>        public WOResponse handleSessionCreationErrorInContext(WOContext aContext)<a name="line.1098"></a>
<FONT color="green">1099</FONT>        {<a name="line.1099"></a>
<FONT color="green">1100</FONT>            /** require [valid_param] aContext != null; **/<a name="line.1100"></a>
<FONT color="green">1101</FONT>    <a name="line.1101"></a>
<FONT color="green">1102</FONT>            WOComponent errorPage = pageWithName(sessionCreationErrorPageName(), aContext);<a name="line.1102"></a>
<FONT color="green">1103</FONT>            WOResponse response = null;<a name="line.1103"></a>
<FONT color="green">1104</FONT>            if (AjaxUtils.isAjaxRequest(aContext.request()))<a name="line.1104"></a>
<FONT color="green">1105</FONT>            {<a name="line.1105"></a>
<FONT color="green">1106</FONT>                AjaxUtils.redirectTo(errorPage);<a name="line.1106"></a>
<FONT color="green">1107</FONT>                response = errorPage.context().response();<a name="line.1107"></a>
<FONT color="green">1108</FONT>                aContext.session().savePage(errorPage);<a name="line.1108"></a>
<FONT color="green">1109</FONT>            }<a name="line.1109"></a>
<FONT color="green">1110</FONT>            else<a name="line.1110"></a>
<FONT color="green">1111</FONT>            {<a name="line.1111"></a>
<FONT color="green">1112</FONT>                response = errorPage.generateResponse();<a name="line.1112"></a>
<FONT color="green">1113</FONT>            }<a name="line.1113"></a>
<FONT color="green">1114</FONT>            response.setStatus(500);<a name="line.1114"></a>
<FONT color="green">1115</FONT>            return response;<a name="line.1115"></a>
<FONT color="green">1116</FONT>    <a name="line.1116"></a>
<FONT color="green">1117</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1117"></a>
<FONT color="green">1118</FONT>        }<a name="line.1118"></a>
<FONT color="green">1119</FONT>    <a name="line.1119"></a>
<FONT color="green">1120</FONT>    <a name="line.1120"></a>
<FONT color="green">1121</FONT>    <a name="line.1121"></a>
<FONT color="green">1122</FONT>        /**<a name="line.1122"></a>
<FONT color="green">1123</FONT>         * Name of the page to display when a session restoration has failed.  Override this method to provide different functionality in your application.<a name="line.1123"></a>
<FONT color="green">1124</FONT>         *<a name="line.1124"></a>
<FONT color="green">1125</FONT>         * @return the name of the page which will be shown when a session resoration has failed<a name="line.1125"></a>
<FONT color="green">1126</FONT>         */<a name="line.1126"></a>
<FONT color="green">1127</FONT>        public String sessionRestorationErrorPageName()<a name="line.1127"></a>
<FONT color="green">1128</FONT>        {<a name="line.1128"></a>
<FONT color="green">1129</FONT>            return properties().hasPropertyForKey("SessionRestorationErrorPageName") ? properties().stringPropertyForKey("SessionRestorationErrorPageName") : defaultPageName();<a name="line.1129"></a>
<FONT color="green">1130</FONT>    <a name="line.1130"></a>
<FONT color="green">1131</FONT>            /** ensure<a name="line.1131"></a>
<FONT color="green">1132</FONT>            [valid_result] Result != null;<a name="line.1132"></a>
<FONT color="green">1133</FONT>            [result_has_nonzero_length] Result.length() &gt; 0; **/<a name="line.1133"></a>
<FONT color="green">1134</FONT>        }<a name="line.1134"></a>
<FONT color="green">1135</FONT>    <a name="line.1135"></a>
<FONT color="green">1136</FONT>    <a name="line.1136"></a>
<FONT color="green">1137</FONT>    <a name="line.1137"></a>
<FONT color="green">1138</FONT>        /**<a name="line.1138"></a>
<FONT color="green">1139</FONT>         * This method defines the response for handling an error that occurred when restoring a session<a name="line.1139"></a>
<FONT color="green">1140</FONT>         *<a name="line.1140"></a>
<FONT color="green">1141</FONT>         * @param aContext The context to use when creating the response.<a name="line.1141"></a>
<FONT color="green">1142</FONT>         * @return the response<a name="line.1142"></a>
<FONT color="green">1143</FONT>         */<a name="line.1143"></a>
<FONT color="green">1144</FONT>        public WOResponse handleSessionRestorationErrorInContext(WOContext aContext)<a name="line.1144"></a>
<FONT color="green">1145</FONT>        {<a name="line.1145"></a>
<FONT color="green">1146</FONT>            /** require [valid_param] aContext != null; **/<a name="line.1146"></a>
<FONT color="green">1147</FONT>    <a name="line.1147"></a>
<FONT color="green">1148</FONT>            WOComponent errorPage = pageWithName(sessionRestorationErrorPageName(), aContext);<a name="line.1148"></a>
<FONT color="green">1149</FONT>            WOResponse response = null;<a name="line.1149"></a>
<FONT color="green">1150</FONT>            if (AjaxUtils.isAjaxRequest(aContext.request()))<a name="line.1150"></a>
<FONT color="green">1151</FONT>            {<a name="line.1151"></a>
<FONT color="green">1152</FONT>                AjaxUtils.redirectTo(errorPage);<a name="line.1152"></a>
<FONT color="green">1153</FONT>                response = errorPage.context().response();<a name="line.1153"></a>
<FONT color="green">1154</FONT>                aContext.session().savePage(errorPage);<a name="line.1154"></a>
<FONT color="green">1155</FONT>            }<a name="line.1155"></a>
<FONT color="green">1156</FONT>            else<a name="line.1156"></a>
<FONT color="green">1157</FONT>            {<a name="line.1157"></a>
<FONT color="green">1158</FONT>                response = errorPage.generateResponse();<a name="line.1158"></a>
<FONT color="green">1159</FONT>            }<a name="line.1159"></a>
<FONT color="green">1160</FONT>            response.setStatus(500);<a name="line.1160"></a>
<FONT color="green">1161</FONT>            return response;<a name="line.1161"></a>
<FONT color="green">1162</FONT>    <a name="line.1162"></a>
<FONT color="green">1163</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1163"></a>
<FONT color="green">1164</FONT>        }<a name="line.1164"></a>
<FONT color="green">1165</FONT>    <a name="line.1165"></a>
<FONT color="green">1166</FONT>    <a name="line.1166"></a>
<FONT color="green">1167</FONT>    <a name="line.1167"></a>
<FONT color="green">1168</FONT>        /**<a name="line.1168"></a>
<FONT color="green">1169</FONT>         * This method determines the page to be shown by handleExceptioninContext. The default is to return null which results in the standard WebObjects exception page. Override this method to show a custom error page.<a name="line.1169"></a>
<FONT color="green">1170</FONT>         *<a name="line.1170"></a>
<FONT color="green">1171</FONT>         * @return the default page being used for handleException.<a name="line.1171"></a>
<FONT color="green">1172</FONT>         */<a name="line.1172"></a>
<FONT color="green">1173</FONT>        public String exceptionPageName()<a name="line.1173"></a>
<FONT color="green">1174</FONT>        {<a name="line.1174"></a>
<FONT color="green">1175</FONT>            return properties().stringPropertyForKey("ExceptionPageName");<a name="line.1175"></a>
<FONT color="green">1176</FONT>        }<a name="line.1176"></a>
<FONT color="green">1177</FONT>    <a name="line.1177"></a>
<FONT color="green">1178</FONT>    <a name="line.1178"></a>
<FONT color="green">1179</FONT>    <a name="line.1179"></a>
<FONT color="green">1180</FONT>        /**<a name="line.1180"></a>
<FONT color="green">1181</FONT>         * Replaces the default WO Exception page.  The page is determined from exceptionPageName.  If you implement a customized exception page, then it must implement the ExceptionPage interface Joee: test if this works<a name="line.1181"></a>
<FONT color="green">1182</FONT>         *<a name="line.1182"></a>
<FONT color="green">1183</FONT>         * @param anException the exception to handle<a name="line.1183"></a>
<FONT color="green">1184</FONT>         * @param aContext the context<a name="line.1184"></a>
<FONT color="green">1185</FONT>         * @return the response to the exception<a name="line.1185"></a>
<FONT color="green">1186</FONT>         */<a name="line.1186"></a>
<FONT color="green">1187</FONT>        public WOResponse handleException(Exception anException, WOContext aContext)<a name="line.1187"></a>
<FONT color="green">1188</FONT>        {<a name="line.1188"></a>
<FONT color="green">1189</FONT>            /** require<a name="line.1189"></a>
<FONT color="green">1190</FONT>            [valid_anException_param] anException != null;<a name="line.1190"></a>
<FONT color="green">1191</FONT>            [valid_aContext_param] aContext != null; **/<a name="line.1191"></a>
<FONT color="green">1192</FONT>    <a name="line.1192"></a>
<FONT color="green">1193</FONT>            WOResponse aResponse = null;<a name="line.1193"></a>
<FONT color="green">1194</FONT>    <a name="line.1194"></a>
<FONT color="green">1195</FONT>            // Handle java.lang.VirtualMachineError (probably OutOfMemory) by terminating the app abruptly.<a name="line.1195"></a>
<FONT color="green">1196</FONT>            if ( (anException instanceof NSForwardException) &amp;&amp;<a name="line.1196"></a>
<FONT color="green">1197</FONT>                 (((NSForwardException) anException).originalException() instanceof VirtualMachineError) )<a name="line.1197"></a>
<FONT color="green">1198</FONT>            {<a name="line.1198"></a>
<FONT color="green">1199</FONT>                Runtime.getRuntime().exit(1);<a name="line.1199"></a>
<FONT color="green">1200</FONT>            }<a name="line.1200"></a>
<FONT color="green">1201</FONT>    <a name="line.1201"></a>
<FONT color="green">1202</FONT>            // Unwrap NSForwardException to get to the actual exception<a name="line.1202"></a>
<FONT color="green">1203</FONT>            while (anException instanceof NSForwardException)<a name="line.1203"></a>
<FONT color="green">1204</FONT>            {<a name="line.1204"></a>
<FONT color="green">1205</FONT>                Throwable t = ((NSForwardException)anException).originalException();<a name="line.1205"></a>
<FONT color="green">1206</FONT>                anException = (t instanceof Exception) ? (Exception)t : new Exception(t);<a name="line.1206"></a>
<FONT color="green">1207</FONT>            }<a name="line.1207"></a>
<FONT color="green">1208</FONT>    <a name="line.1208"></a>
<FONT color="green">1209</FONT>            try<a name="line.1209"></a>
<FONT color="green">1210</FONT>            {<a name="line.1210"></a>
<FONT color="green">1211</FONT>                if (exceptionPageName() != null)<a name="line.1211"></a>
<FONT color="green">1212</FONT>                {<a name="line.1212"></a>
<FONT color="green">1213</FONT>                    WOComponent exceptionPage = pageWithName(exceptionPageName(), aContext);<a name="line.1213"></a>
<FONT color="green">1214</FONT>    <a name="line.1214"></a>
<FONT color="green">1215</FONT>                    java.lang.Class exceptionPageInterFace = ExceptionPage.class;<a name="line.1215"></a>
<FONT color="green">1216</FONT>    <a name="line.1216"></a>
<FONT color="green">1217</FONT>                    // Make sure the exception page conforms to the ExceptionPage interface<a name="line.1217"></a>
<FONT color="green">1218</FONT>                    if (exceptionPageInterFace.isAssignableFrom(exceptionPage.getClass()))<a name="line.1218"></a>
<FONT color="green">1219</FONT>                    {<a name="line.1219"></a>
<FONT color="green">1220</FONT>                        NSMutableDictionary extendedUserInfo = new NSMutableDictionary();<a name="line.1220"></a>
<FONT color="green">1221</FONT>    <a name="line.1221"></a>
<FONT color="green">1222</FONT>                        if (aContext.component() != null)<a name="line.1222"></a>
<FONT color="green">1223</FONT>                        {<a name="line.1223"></a>
<FONT color="green">1224</FONT>                            extendedUserInfo.setObjectForKey(aContext.component().name(), "Component-Name");<a name="line.1224"></a>
<FONT color="green">1225</FONT>                        }<a name="line.1225"></a>
<FONT color="green">1226</FONT>                        if (aContext.page() != null)<a name="line.1226"></a>
<FONT color="green">1227</FONT>                        {<a name="line.1227"></a>
<FONT color="green">1228</FONT>                            extendedUserInfo.setObjectForKey(aContext.page().name(), "Page-Name");<a name="line.1228"></a>
<FONT color="green">1229</FONT>                        }<a name="line.1229"></a>
<FONT color="green">1230</FONT>                        if (aContext.request() != null)<a name="line.1230"></a>
<FONT color="green">1231</FONT>                        {<a name="line.1231"></a>
<FONT color="green">1232</FONT>                            extendedUserInfo.setObjectForKey(aContext.request(), "Request");<a name="line.1232"></a>
<FONT color="green">1233</FONT>                        }<a name="line.1233"></a>
<FONT color="green">1234</FONT>                        ((ExceptionPage) exceptionPage).reportException(anException, extendedUserInfo, aContext);<a name="line.1234"></a>
<FONT color="green">1235</FONT>                    }<a name="line.1235"></a>
<FONT color="green">1236</FONT>    <a name="line.1236"></a>
<FONT color="green">1237</FONT>                    if (AjaxUtils.isAjaxRequest(aContext.request()))<a name="line.1237"></a>
<FONT color="green">1238</FONT>                    {<a name="line.1238"></a>
<FONT color="green">1239</FONT>                        AjaxUtils.redirectTo(exceptionPage);<a name="line.1239"></a>
<FONT color="green">1240</FONT>                        aResponse = exceptionPage.context().response();<a name="line.1240"></a>
<FONT color="green">1241</FONT>                        aContext.session().savePage(exceptionPage);<a name="line.1241"></a>
<FONT color="green">1242</FONT>                    }<a name="line.1242"></a>
<FONT color="green">1243</FONT>                    else<a name="line.1243"></a>
<FONT color="green">1244</FONT>                    {<a name="line.1244"></a>
<FONT color="green">1245</FONT>                        aResponse = exceptionPage.generateResponse();<a name="line.1245"></a>
<FONT color="green">1246</FONT>                    }<a name="line.1246"></a>
<FONT color="green">1247</FONT>                }<a name="line.1247"></a>
<FONT color="green">1248</FONT>                else<a name="line.1248"></a>
<FONT color="green">1249</FONT>                {<a name="line.1249"></a>
<FONT color="green">1250</FONT>                    aResponse = super.handleException(anException, aContext);<a name="line.1250"></a>
<FONT color="green">1251</FONT>                }<a name="line.1251"></a>
<FONT color="green">1252</FONT>            }<a name="line.1252"></a>
<FONT color="green">1253</FONT>            catch (Exception e)<a name="line.1253"></a>
<FONT color="green">1254</FONT>            {<a name="line.1254"></a>
<FONT color="green">1255</FONT>                aResponse =  super.handleException(e, aContext);<a name="line.1255"></a>
<FONT color="green">1256</FONT>            }<a name="line.1256"></a>
<FONT color="green">1257</FONT>    <a name="line.1257"></a>
<FONT color="green">1258</FONT>            aResponse.setStatus(500);<a name="line.1258"></a>
<FONT color="green">1259</FONT>            return aResponse;<a name="line.1259"></a>
<FONT color="green">1260</FONT>    <a name="line.1260"></a>
<FONT color="green">1261</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1261"></a>
<FONT color="green">1262</FONT>        }<a name="line.1262"></a>
<FONT color="green">1263</FONT>    <a name="line.1263"></a>
<FONT color="green">1264</FONT>    <a name="line.1264"></a>
<FONT color="green">1265</FONT>    <a name="line.1265"></a>
<FONT color="green">1266</FONT>        /**<a name="line.1266"></a>
<FONT color="green">1267</FONT>         * Overridden to log messages when session refusing is turned on and off.<a name="line.1267"></a>
<FONT color="green">1268</FONT>         *<a name="line.1268"></a>
<FONT color="green">1269</FONT>         * @param shouldRefuse - true if the application should create new sessions, false otherwise<a name="line.1269"></a>
<FONT color="green">1270</FONT>         */<a name="line.1270"></a>
<FONT color="green">1271</FONT>        public void refuseNewSessions(boolean shouldRefuse)<a name="line.1271"></a>
<FONT color="green">1272</FONT>        {<a name="line.1272"></a>
<FONT color="green">1273</FONT>            logger.info("Changing refuseNewSessions to " + shouldRefuse);<a name="line.1273"></a>
<FONT color="green">1274</FONT>            logger.info("Active sessions: " +  activeSessionsCount());<a name="line.1274"></a>
<FONT color="green">1275</FONT>    <a name="line.1275"></a>
<FONT color="green">1276</FONT>            super.refuseNewSessions(shouldRefuse);<a name="line.1276"></a>
<FONT color="green">1277</FONT>        }<a name="line.1277"></a>
<FONT color="green">1278</FONT>    <a name="line.1278"></a>
<FONT color="green">1279</FONT>    <a name="line.1279"></a>
<FONT color="green">1280</FONT>    <a name="line.1280"></a>
<FONT color="green">1281</FONT>        /**<a name="line.1281"></a>
<FONT color="green">1282</FONT>         * Diagnostic messages only.<a name="line.1282"></a>
<FONT color="green">1283</FONT>         */<a name="line.1283"></a>
<FONT color="green">1284</FONT>        public void terminate()<a name="line.1284"></a>
<FONT color="green">1285</FONT>        {<a name="line.1285"></a>
<FONT color="green">1286</FONT>            super.terminate();<a name="line.1286"></a>
<FONT color="green">1287</FONT>            logger.info("**** Application shut down initiated.");<a name="line.1287"></a>
<FONT color="green">1288</FONT>        }<a name="line.1288"></a>
<FONT color="green">1289</FONT>    <a name="line.1289"></a>
<FONT color="green">1290</FONT>    <a name="line.1290"></a>
<FONT color="green">1291</FONT>    <a name="line.1291"></a>
<FONT color="green">1292</FONT>        /**<a name="line.1292"></a>
<FONT color="green">1293</FONT>         * Exposes protected method.<a name="line.1293"></a>
<FONT color="green">1294</FONT>         *<a name="line.1294"></a>
<FONT color="green">1295</FONT>         * @see com.webobjects.appserver.WOApplication#_terminateFromMonitor()<a name="line.1295"></a>
<FONT color="green">1296</FONT>         */<a name="line.1296"></a>
<FONT color="green">1297</FONT>        public void _terminateFromMonitor()<a name="line.1297"></a>
<FONT color="green">1298</FONT>        {<a name="line.1298"></a>
<FONT color="green">1299</FONT>            super._terminateFromMonitor();<a name="line.1299"></a>
<FONT color="green">1300</FONT>        }<a name="line.1300"></a>
<FONT color="green">1301</FONT>    <a name="line.1301"></a>
<FONT color="green">1302</FONT>    <a name="line.1302"></a>
<FONT color="green">1303</FONT>    <a name="line.1303"></a>
<FONT color="green">1304</FONT>        /**<a name="line.1304"></a>
<FONT color="green">1305</FONT>         * Returns the name of the page (can be used for any WOComponent) mapped to the passed name according to pageMap(), or just returns aPageName if there is no mapping for this page.  The page map is created by the application constructor which reads the file name from the configuration file.<a name="line.1305"></a>
<FONT color="green">1306</FONT>         *<a name="line.1306"></a>
<FONT color="green">1307</FONT>         * @param aPageName the name of the page to return a mapped name for<a name="line.1307"></a>
<FONT color="green">1308</FONT>         * @return the name of the WO page mapped to the passed name according to pageMap(), or aPageName if there is no mapping for this page<a name="line.1308"></a>
<FONT color="green">1309</FONT>         */<a name="line.1309"></a>
<FONT color="green">1310</FONT>        public String pageNameMappedToName(String aPageName)<a name="line.1310"></a>
<FONT color="green">1311</FONT>        {<a name="line.1311"></a>
<FONT color="green">1312</FONT>            /** require [valid_param] aPageName != null; [page_map_not_null] pageMap() != null; **/<a name="line.1312"></a>
<FONT color="green">1313</FONT>    <a name="line.1313"></a>
<FONT color="green">1314</FONT>            String mappedPageForPage = aPageName;<a name="line.1314"></a>
<FONT color="green">1315</FONT>    <a name="line.1315"></a>
<FONT color="green">1316</FONT>            if (pageMap().objectForKey(aPageName) != null)<a name="line.1316"></a>
<FONT color="green">1317</FONT>            {<a name="line.1317"></a>
<FONT color="green">1318</FONT>                mappedPageForPage = (String)pageMap().objectForKey(aPageName);<a name="line.1318"></a>
<FONT color="green">1319</FONT>                logger.info("Mapped page " + aPageName + " to " + mappedPageForPage);<a name="line.1319"></a>
<FONT color="green">1320</FONT>            }<a name="line.1320"></a>
<FONT color="green">1321</FONT>    <a name="line.1321"></a>
<FONT color="green">1322</FONT>            return mappedPageForPage;<a name="line.1322"></a>
<FONT color="green">1323</FONT>    <a name="line.1323"></a>
<FONT color="green">1324</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1324"></a>
<FONT color="green">1325</FONT>        }<a name="line.1325"></a>
<FONT color="green">1326</FONT>    <a name="line.1326"></a>
<FONT color="green">1327</FONT>    <a name="line.1327"></a>
<FONT color="green">1328</FONT>    <a name="line.1328"></a>
<FONT color="green">1329</FONT>        /**<a name="line.1329"></a>
<FONT color="green">1330</FONT>         * &lt;p&gt;Overridden to&lt;/p&gt;<a name="line.1330"></a>
<FONT color="green">1331</FONT>         * &lt;ul&gt;<a name="line.1331"></a>
<FONT color="green">1332</FONT>         * &lt;li&gt;Disable component access&lt;/li&gt;<a name="line.1332"></a>
<FONT color="green">1333</FONT>         * &lt;li&gt;Replace null aName with &lt;code&gt;defaultPageName()&lt;/code&gt;&lt;/li&gt;<a name="line.1333"></a>
<FONT color="green">1334</FONT>         * &lt;li&gt;Call pageNameMappedToName(String) to check for a replacement for aName&lt;/li&gt;<a name="line.1334"></a>
<FONT color="green">1335</FONT>         * &lt;li&gt;Call securePageForPageWithName(String, WOContext) check user permissions and enforce secure (SSL) access.&lt;/li&gt;<a name="line.1335"></a>
<FONT color="green">1336</FONT>         * &lt;/ul&gt;<a name="line.1336"></a>
<FONT color="green">1337</FONT>         *<a name="line.1337"></a>
<FONT color="green">1338</FONT>         * @param aName the name of the page to return<a name="line.1338"></a>
<FONT color="green">1339</FONT>         * @param aContext the context to obtain the page with<a name="line.1339"></a>
<FONT color="green">1340</FONT>         * @return appropriate page based on the requested page name in the given context<a name="line.1340"></a>
<FONT color="green">1341</FONT>         */<a name="line.1341"></a>
<FONT color="green">1342</FONT>        public com.webobjects.appserver.WOComponent pageWithName(String aName, WOContext aContext)<a name="line.1342"></a>
<FONT color="green">1343</FONT>        {<a name="line.1343"></a>
<FONT color="green">1344</FONT>            /** require [valid_aContext_param] aContext != null; **/<a name="line.1344"></a>
<FONT color="green">1345</FONT>    <a name="line.1345"></a>
<FONT color="green">1346</FONT>            // Disable component access<a name="line.1346"></a>
<FONT color="green">1347</FONT>            if ((aContext.senderID() == null) &amp;&amp;  (componentRequestHandlerKey().equals(aContext.request().requestHandlerKey())))<a name="line.1347"></a>
<FONT color="green">1348</FONT>            {<a name="line.1348"></a>
<FONT color="green">1349</FONT>                aName = defaultPageName();<a name="line.1349"></a>
<FONT color="green">1350</FONT>            }<a name="line.1350"></a>
<FONT color="green">1351</FONT>    <a name="line.1351"></a>
<FONT color="green">1352</FONT>            // In some cases, aName is null and WebObjects attempts to display a page named Main, which often<a name="line.1352"></a>
<FONT color="green">1353</FONT>            // does not exist (e.g. for URLs like http://localhost/cgi-bin/WebObjects.exe/Appname.woa/wo.)<a name="line.1353"></a>
<FONT color="green">1354</FONT>            // This check traps this and uses defaultPageName() in place of "Main".<a name="line.1354"></a>
<FONT color="green">1355</FONT>            if (aName == null)<a name="line.1355"></a>
<FONT color="green">1356</FONT>            {<a name="line.1356"></a>
<FONT color="green">1357</FONT>                aName = defaultPageName();<a name="line.1357"></a>
<FONT color="green">1358</FONT>            }<a name="line.1358"></a>
<FONT color="green">1359</FONT>    <a name="line.1359"></a>
<FONT color="green">1360</FONT>            // Map to canonical name if we have a page map<a name="line.1360"></a>
<FONT color="green">1361</FONT>            if (hasPageMap())<a name="line.1361"></a>
<FONT color="green">1362</FONT>            {<a name="line.1362"></a>
<FONT color="green">1363</FONT>                aName = pageNameMappedToName(aName);<a name="line.1363"></a>
<FONT color="green">1364</FONT>            }<a name="line.1364"></a>
<FONT color="green">1365</FONT>    <a name="line.1365"></a>
<FONT color="green">1366</FONT>            WOComponent newPage = securePageForPageWithName(aName, aContext);<a name="line.1366"></a>
<FONT color="green">1367</FONT>            if (newPage == null)<a name="line.1367"></a>
<FONT color="green">1368</FONT>            {<a name="line.1368"></a>
<FONT color="green">1369</FONT>                newPage = super.pageWithName(aName, aContext);<a name="line.1369"></a>
<FONT color="green">1370</FONT>            }<a name="line.1370"></a>
<FONT color="green">1371</FONT>    <a name="line.1371"></a>
<FONT color="green">1372</FONT>            return newPage;<a name="line.1372"></a>
<FONT color="green">1373</FONT>    <a name="line.1373"></a>
<FONT color="green">1374</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1374"></a>
<FONT color="green">1375</FONT>        }<a name="line.1375"></a>
<FONT color="green">1376</FONT>    <a name="line.1376"></a>
<FONT color="green">1377</FONT>    <a name="line.1377"></a>
<FONT color="green">1378</FONT>    <a name="line.1378"></a>
<FONT color="green">1379</FONT>        /**<a name="line.1379"></a>
<FONT color="green">1380</FONT>         * &lt;p&gt;Overridden to check user permissions and enforce secure (SSL) access. For example, a redirect is performed to switch to a https URI if needed.  Also, if the user lacks permissions for the requested page, a login page is shown instead.&lt;/p&gt;<a name="line.1380"></a>
<FONT color="green">1381</FONT>         * &lt;p&gt;In order to make use of this method, pages must implement some of these methods:&lt;/p&gt; &lt;ul&gt;<a name="line.1381"></a>
<FONT color="green">1382</FONT>         * &lt;li&gt; &lt;code&gt;public boolean needsSecureConnection()&lt;/code&gt; - return &lt;code&gt;true&lt;/code&gt; if the page should only be accessible via SSL. &lt;/li&gt;<a name="line.1382"></a>
<FONT color="green">1383</FONT>         * &lt;li&gt; &lt;code&gt;public boolean permitsAccess(WOContext aContext)&lt;/code&gt; - return &lt;code&gt;true&lt;/code&gt; if the current user (typically found in aContext.session().user()) is allowed to access this page.  The method can use any logic it wants to determine if access is granted.  If access is denied (false is returned), &lt;code&gt;pageWithName&lt;/code&gt; will return the page named in &lt;code&gt;loginPageName&lt;/code&gt; instead.<a name="line.1383"></a>
<FONT color="green">1384</FONT>         * &lt;li&gt; &lt;code&gt;public String loginPageName()&lt;/code&gt; - the name of the page to show if &lt;code&gt;permitsAccess&lt;/code&gt; returns &lt;code&gt;false&lt;/code&gt;.&lt;/li&gt;. If &lt;code&gt;permitsAccess&lt;/code&gt; is implemented then this method must also be implemented.&lt;/ul&gt;<a name="line.1384"></a>
<FONT color="green">1385</FONT>         * &lt;p&gt; With this scheme, if permitsAccess, loginPageName, and setNextPageName are all implemented, then users can bookmark pages that are usually behind a login screen with a URI like this: https://domain/cgi-bin/WebObjects/AppName.woa/wo/SecurePageName.wo.  If they are already logged in, they will be taken to the requested page.  If they are not logged in they will be shown a login page and then taken to the requested page after successfully logging on.&lt;/p&gt;<a name="line.1385"></a>
<FONT color="green">1386</FONT>         * &lt;p&gt; NOTE: when using this authentication, pages should ensure that they do not create instances of pages to which the user does not have access as pageWithName may return a different page than requested.  If methods are then called on the returned page, an exception may be raised.&lt;/p&gt;<a name="line.1386"></a>
<FONT color="green">1387</FONT>         * &lt;p&gt; If the page identified by &lt;code&gt;loginPageName&lt;/code&gt; has implemented a  &lt;code&gt;setNextPageName(String aString)&lt;/code&gt; method, then the originally requested page will be set up as the next page to display after logging on.&lt;/p&gt;<a name="line.1387"></a>
<FONT color="green">1388</FONT>         * &lt;p&gt;This method can be overidden to just return null if this functionality is not desired.&lt;/p&gt;<a name="line.1388"></a>
<FONT color="green">1389</FONT>         * @param aName the name of the page to return<a name="line.1389"></a>
<FONT color="green">1390</FONT>         * @param aContext the context to obtain the page with<a name="line.1390"></a>
<FONT color="green">1391</FONT>         * @return &lt;code&gt;null&lt;/code&gt; if page named aName is OK to return as is, the requested page in the given context or an instance of the loginPage as specified in &lt;code&gt;loginPageNamed&lt;/code&gt;<a name="line.1391"></a>
<FONT color="green">1392</FONT>         */<a name="line.1392"></a>
<FONT color="green">1393</FONT>        public com.webobjects.appserver.WOComponent securePageForPageWithName(String aName, WOContext aContext)<a name="line.1393"></a>
<FONT color="green">1394</FONT>        {<a name="line.1394"></a>
<FONT color="green">1395</FONT>            /** require [valid_name] aName != null;  [valid_Context] aContext != null; **/<a name="line.1395"></a>
<FONT color="green">1396</FONT>    <a name="line.1396"></a>
<FONT color="green">1397</FONT>              // Use WebObject's way of finding a class when you don't have the package qualified name.  _NSUtilities so this is subject to change.<a name="line.1397"></a>
<FONT color="green">1398</FONT>            java.lang.Class classForPage = _NSUtilities.classWithName(aName);<a name="line.1398"></a>
<FONT color="green">1399</FONT>            if (classForPage == null)<a name="line.1399"></a>
<FONT color="green">1400</FONT>            {<a name="line.1400"></a>
<FONT color="green">1401</FONT>                throw new RuntimeException("Page " + aName + " does not exist!");<a name="line.1401"></a>
<FONT color="green">1402</FONT>            }<a name="line.1402"></a>
<FONT color="green">1403</FONT>    <a name="line.1403"></a>
<FONT color="green">1404</FONT>            Method permitsAccessMethod = null;<a name="line.1404"></a>
<FONT color="green">1405</FONT>            try<a name="line.1405"></a>
<FONT color="green">1406</FONT>            {<a name="line.1406"></a>
<FONT color="green">1407</FONT>                permitsAccessMethod = classForPage.getMethod("permitsAccess", new java.lang.Class[] {WOContext.class});<a name="line.1407"></a>
<FONT color="green">1408</FONT>            }<a name="line.1408"></a>
<FONT color="green">1409</FONT>            catch (NoSuchMethodException e) { }<a name="line.1409"></a>
<FONT color="green">1410</FONT>    <a name="line.1410"></a>
<FONT color="green">1411</FONT>            Method loginPageNameMethod = null;<a name="line.1411"></a>
<FONT color="green">1412</FONT>            try<a name="line.1412"></a>
<FONT color="green">1413</FONT>            {<a name="line.1413"></a>
<FONT color="green">1414</FONT>                loginPageNameMethod = classForPage.getMethod("loginPageName", new java.lang.Class[] {});<a name="line.1414"></a>
<FONT color="green">1415</FONT>            }<a name="line.1415"></a>
<FONT color="green">1416</FONT>            catch (NoSuchMethodException e) { }<a name="line.1416"></a>
<FONT color="green">1417</FONT>    <a name="line.1417"></a>
<FONT color="green">1418</FONT>            if ((permitsAccessMethod != null) &amp;&amp; (loginPageNameMethod == null))<a name="line.1418"></a>
<FONT color="green">1419</FONT>            {<a name="line.1419"></a>
<FONT color="green">1420</FONT>                throw new java.lang.RuntimeException("If you implement permitsAccess() you must also implement loginPageName()");<a name="line.1420"></a>
<FONT color="green">1421</FONT>            }<a name="line.1421"></a>
<FONT color="green">1422</FONT>    <a name="line.1422"></a>
<FONT color="green">1423</FONT>            Method needsSecureConnectionMethod = null;<a name="line.1423"></a>
<FONT color="green">1424</FONT>            boolean isSecurePage = false;<a name="line.1424"></a>
<FONT color="green">1425</FONT>            try<a name="line.1425"></a>
<FONT color="green">1426</FONT>            {<a name="line.1426"></a>
<FONT color="green">1427</FONT>                needsSecureConnectionMethod = classForPage.getMethod("needsSecureConnection", new java.lang.Class[] {});<a name="line.1427"></a>
<FONT color="green">1428</FONT>                try<a name="line.1428"></a>
<FONT color="green">1429</FONT>                {<a name="line.1429"></a>
<FONT color="green">1430</FONT>                    // Invoke is not capable of returning a primative type, it is always wrapped in its associated class (Boolean, Integer, etc)<a name="line.1430"></a>
<FONT color="green">1431</FONT>                    java.lang.Boolean isSecurePageAsBoolean = (java.lang.Boolean) needsSecureConnectionMethod.invoke(null, new Object[] {});<a name="line.1431"></a>
<FONT color="green">1432</FONT>                    isSecurePage = isSecurePageAsBoolean.booleanValue();<a name="line.1432"></a>
<FONT color="green">1433</FONT>                }<a name="line.1433"></a>
<FONT color="green">1434</FONT>                catch(Exception e)<a name="line.1434"></a>
<FONT color="green">1435</FONT>                {<a name="line.1435"></a>
<FONT color="green">1436</FONT>                    throw new java.lang.RuntimeException("An exception (" + e + ") occurred while trying to invoke needsSecureConnection on the " + aName + " page");<a name="line.1436"></a>
<FONT color="green">1437</FONT>                }<a name="line.1437"></a>
<FONT color="green">1438</FONT>    <a name="line.1438"></a>
<FONT color="green">1439</FONT>            }<a name="line.1439"></a>
<FONT color="green">1440</FONT>            catch (NoSuchMethodException e)<a name="line.1440"></a>
<FONT color="green">1441</FONT>            {<a name="line.1441"></a>
<FONT color="green">1442</FONT>            }<a name="line.1442"></a>
<FONT color="green">1443</FONT>    <a name="line.1443"></a>
<FONT color="green">1444</FONT>            boolean doesUserHavePermission = true;<a name="line.1444"></a>
<FONT color="green">1445</FONT>            if (permitsAccessMethod != null)<a name="line.1445"></a>
<FONT color="green">1446</FONT>            {<a name="line.1446"></a>
<FONT color="green">1447</FONT>                try<a name="line.1447"></a>
<FONT color="green">1448</FONT>                {<a name="line.1448"></a>
<FONT color="green">1449</FONT>                    java.lang.Boolean doesUserHavePermissionAsBoolean = (java.lang.Boolean)permitsAccessMethod.invoke(null, new Object[] {aContext});<a name="line.1449"></a>
<FONT color="green">1450</FONT>                    doesUserHavePermission = doesUserHavePermissionAsBoolean.booleanValue();<a name="line.1450"></a>
<FONT color="green">1451</FONT>                }<a name="line.1451"></a>
<FONT color="green">1452</FONT>                catch (Exception e)<a name="line.1452"></a>
<FONT color="green">1453</FONT>                {<a name="line.1453"></a>
<FONT color="green">1454</FONT>                    throw new RuntimeException("An exception (" + e + ") occurred while trying to invoke permitsAccess on the " + aName + " page");<a name="line.1454"></a>
<FONT color="green">1455</FONT>                }<a name="line.1455"></a>
<FONT color="green">1456</FONT>            }<a name="line.1456"></a>
<FONT color="green">1457</FONT>    <a name="line.1457"></a>
<FONT color="green">1458</FONT>            // Determine if the page is not using SSL<a name="line.1458"></a>
<FONT color="green">1459</FONT>            boolean isNotUsingSSL = ( ! RequestUtilities.isHTTPSRequest(aContext.request()));<a name="line.1459"></a>
<FONT color="green">1460</FONT>            WOComponent newPage = null;<a name="line.1460"></a>
<FONT color="green">1461</FONT>    <a name="line.1461"></a>
<FONT color="green">1462</FONT>            if (isSecurePage &amp;&amp; isNotUsingSSL)<a name="line.1462"></a>
<FONT color="green">1463</FONT>            {<a name="line.1463"></a>
<FONT color="green">1464</FONT>                String redirectURL = "https://" + RequestUtilities.hostNameFromRequest(aContext.request()) + aContext.request().uri();<a name="line.1464"></a>
<FONT color="green">1465</FONT>                WORedirect redirectPage = (WORedirect) super.pageWithName("WORedirect", aContext);<a name="line.1465"></a>
<FONT color="green">1466</FONT>                redirectPage.setUrl(redirectURL);<a name="line.1466"></a>
<FONT color="green">1467</FONT>    <a name="line.1467"></a>
<FONT color="green">1468</FONT>                newPage = redirectPage;<a name="line.1468"></a>
<FONT color="green">1469</FONT>            }<a name="line.1469"></a>
<FONT color="green">1470</FONT>            else if ( ! doesUserHavePermission)<a name="line.1470"></a>
<FONT color="green">1471</FONT>            {<a name="line.1471"></a>
<FONT color="green">1472</FONT>                // We are in the correct http/https mode, but the user does not have permission for this page.  Show the login page, and optionally set the requested page as the login followup page.<a name="line.1472"></a>
<FONT color="green">1473</FONT>                String loginPageName;<a name="line.1473"></a>
<FONT color="green">1474</FONT>                try<a name="line.1474"></a>
<FONT color="green">1475</FONT>                {<a name="line.1475"></a>
<FONT color="green">1476</FONT>                    loginPageName = (String) loginPageNameMethod.invoke(null, new Object[] {});<a name="line.1476"></a>
<FONT color="green">1477</FONT>                }<a name="line.1477"></a>
<FONT color="green">1478</FONT>                catch (Exception e)<a name="line.1478"></a>
<FONT color="green">1479</FONT>                {<a name="line.1479"></a>
<FONT color="green">1480</FONT>                    throw new RuntimeException("An exception (" + e + ") occurred while trying to invoke loginPageName on the " + aName + " page");<a name="line.1480"></a>
<FONT color="green">1481</FONT>                }<a name="line.1481"></a>
<FONT color="green">1482</FONT>    <a name="line.1482"></a>
<FONT color="green">1483</FONT>                newPage = this.pageWithName(loginPageName, aContext);<a name="line.1483"></a>
<FONT color="green">1484</FONT>            }<a name="line.1484"></a>
<FONT color="green">1485</FONT>    <a name="line.1485"></a>
<FONT color="green">1486</FONT>            return newPage;<a name="line.1486"></a>
<FONT color="green">1487</FONT>        }<a name="line.1487"></a>
<FONT color="green">1488</FONT>    <a name="line.1488"></a>
<FONT color="green">1489</FONT>    <a name="line.1489"></a>
<FONT color="green">1490</FONT>    <a name="line.1490"></a>
<FONT color="green">1491</FONT>        /**<a name="line.1491"></a>
<FONT color="green">1492</FONT>         * Returns an instance of the dynamic element requested, or of another dynamic element if one has been mapped to this name.  This allows one component to be substituted for another at runtime.  This was done to support customization of SiteMaker on a page by page basis.&lt;br&gt;&lt;br&gt;<a name="line.1492"></a>
<FONT color="green">1493</FONT>         *<a name="line.1493"></a>
<FONT color="green">1494</FONT>         * &lt;b&gt;Bug Alert&lt;/b&gt;: This only works for sub-classes of WODynamicElement.  It does not work for WOComponent sub-classes, nor is pageWithName called for WOComponent sub-classes.  To get WOComponent sub-classes to work with this use them in a WOSwitchComponent like this:&lt;br&gt;<a name="line.1494"></a>
<FONT color="green">1495</FONT>         * &lt;code&gt;<a name="line.1495"></a>
<FONT color="green">1496</FONT>         *     SMUserInstructions: WOSwitchComponent {&lt;br&gt;<a name="line.1496"></a>
<FONT color="green">1497</FONT>         *         WOComponentName = "SMUserInstructions";&lt;br&gt;<a name="line.1497"></a>
<FONT color="green">1498</FONT>         *     }&lt;br&gt;<a name="line.1498"></a>
<FONT color="green">1499</FONT>         * &lt;/code&gt;<a name="line.1499"></a>
<FONT color="green">1500</FONT>         *<a name="line.1500"></a>
<FONT color="green">1501</FONT>         * @param aName the name of the dynamic element to return<a name="line.1501"></a>
<FONT color="green">1502</FONT>         * @param someAssociations a dictionary of associations<a name="line.1502"></a>
<FONT color="green">1503</FONT>         * @param anElement a template of elements<a name="line.1503"></a>
<FONT color="green">1504</FONT>         * @param aLanguageArray NSArray containing the language preferences specified by the browser<a name="line.1504"></a>
<FONT color="green">1505</FONT>         * @return an instance of the page requested, or of another page if one has been mapped to this name<a name="line.1505"></a>
<FONT color="green">1506</FONT>         */<a name="line.1506"></a>
<FONT color="green">1507</FONT>        public WOElement dynamicElementWithName(String aName,<a name="line.1507"></a>
<FONT color="green">1508</FONT>                                                NSDictionary someAssociations,<a name="line.1508"></a>
<FONT color="green">1509</FONT>                                                WOElement anElement,<a name="line.1509"></a>
<FONT color="green">1510</FONT>                                                NSArray aLanguageArray)<a name="line.1510"></a>
<FONT color="green">1511</FONT>        {<a name="line.1511"></a>
<FONT color="green">1512</FONT>            /** require [valid_aName_param] aName != null; **/<a name="line.1512"></a>
<FONT color="green">1513</FONT>    <a name="line.1513"></a>
<FONT color="green">1514</FONT>            if (hasPageMap())<a name="line.1514"></a>
<FONT color="green">1515</FONT>            {<a name="line.1515"></a>
<FONT color="green">1516</FONT>                aName = pageNameMappedToName(aName);<a name="line.1516"></a>
<FONT color="green">1517</FONT>            }<a name="line.1517"></a>
<FONT color="green">1518</FONT>            return super.dynamicElementWithName(aName,<a name="line.1518"></a>
<FONT color="green">1519</FONT>                                                someAssociations,<a name="line.1519"></a>
<FONT color="green">1520</FONT>                                                anElement,<a name="line.1520"></a>
<FONT color="green">1521</FONT>                                                aLanguageArray);<a name="line.1521"></a>
<FONT color="green">1522</FONT>    <a name="line.1522"></a>
<FONT color="green">1523</FONT>            /** ensure [result_not_null] Result != null; **/<a name="line.1523"></a>
<FONT color="green">1524</FONT>        }<a name="line.1524"></a>
<FONT color="green">1525</FONT>    <a name="line.1525"></a>
<FONT color="green">1526</FONT>    <a name="line.1526"></a>
<FONT color="green">1527</FONT>    <a name="line.1527"></a>
<FONT color="green">1528</FONT>        /**<a name="line.1528"></a>
<FONT color="green">1529</FONT>         * @return the class of EOEditingContext that the application should use<a name="line.1529"></a>
<FONT color="green">1530</FONT>         */<a name="line.1530"></a>
<FONT color="green">1531</FONT>        public Class editingContextClass()<a name="line.1531"></a>
<FONT color="green">1532</FONT>        {<a name="line.1532"></a>
<FONT color="green">1533</FONT>            if (editingContextClass == null)<a name="line.1533"></a>
<FONT color="green">1534</FONT>            {<a name="line.1534"></a>
<FONT color="green">1535</FONT>                String ecClassNamePropertyKey;<a name="line.1535"></a>
<FONT color="green">1536</FONT>                if (appProperties().booleanPropertyForKey(DebugEditingContextLockingPropertyKey))<a name="line.1536"></a>
<FONT color="green">1537</FONT>                {<a name="line.1537"></a>
<FONT color="green">1538</FONT>                    ecClassNamePropertyKey = DebuggingEditingContextClassNamePropertyKey;<a name="line.1538"></a>
<FONT color="green">1539</FONT>                }<a name="line.1539"></a>
<FONT color="green">1540</FONT>                else<a name="line.1540"></a>
<FONT color="green">1541</FONT>                {<a name="line.1541"></a>
<FONT color="green">1542</FONT>                    ecClassNamePropertyKey = EditingContextClassNamePropertyKey;<a name="line.1542"></a>
<FONT color="green">1543</FONT>                }<a name="line.1543"></a>
<FONT color="green">1544</FONT>    <a name="line.1544"></a>
<FONT color="green">1545</FONT>                String ecClassName =<a name="line.1545"></a>
<FONT color="green">1546</FONT>                    appProperties().stringPropertyForKey(ecClassNamePropertyKey);<a name="line.1546"></a>
<FONT color="green">1547</FONT>    <a name="line.1547"></a>
<FONT color="green">1548</FONT>                try<a name="line.1548"></a>
<FONT color="green">1549</FONT>                {<a name="line.1549"></a>
<FONT color="green">1550</FONT>                    editingContextClass = Class.forName(ecClassName);<a name="line.1550"></a>
<FONT color="green">1551</FONT>                    if ( ! EOEditingContext.class.isAssignableFrom(editingContextClass))<a name="line.1551"></a>
<FONT color="green">1552</FONT>                    {<a name="line.1552"></a>
<FONT color="green">1553</FONT>                        throw new Error(<a name="line.1553"></a>
<FONT color="green">1554</FONT>                            "The class defined by the property "<a name="line.1554"></a>
<FONT color="green">1555</FONT>                                + ecClassNamePropertyKey<a name="line.1555"></a>
<FONT color="green">1556</FONT>                                + " (\""<a name="line.1556"></a>
<FONT color="green">1557</FONT>                                + ecClassName<a name="line.1557"></a>
<FONT color="green">1558</FONT>                                + "\") did not resolve to a subclass of EOEditingContext.");<a name="line.1558"></a>
<FONT color="green">1559</FONT>                    }<a name="line.1559"></a>
<FONT color="green">1560</FONT>                }<a name="line.1560"></a>
<FONT color="green">1561</FONT>                catch (ClassNotFoundException e)<a name="line.1561"></a>
<FONT color="green">1562</FONT>                {<a name="line.1562"></a>
<FONT color="green">1563</FONT>                    throw new Error(<a name="line.1563"></a>
<FONT color="green">1564</FONT>                        "The class defined by the property "<a name="line.1564"></a>
<FONT color="green">1565</FONT>                            + ecClassNamePropertyKey<a name="line.1565"></a>
<FONT color="green">1566</FONT>                            + " (\""<a name="line.1566"></a>
<FONT color="green">1567</FONT>                            + ecClassName<a name="line.1567"></a>
<FONT color="green">1568</FONT>                            + "\") was not found.  Please ensure that it is fully qualified.");<a name="line.1568"></a>
<FONT color="green">1569</FONT>                }<a name="line.1569"></a>
<FONT color="green">1570</FONT>            }<a name="line.1570"></a>
<FONT color="green">1571</FONT>    <a name="line.1571"></a>
<FONT color="green">1572</FONT>            return editingContextClass;<a name="line.1572"></a>
<FONT color="green">1573</FONT>            /** ensure [valid_result] Result != null;   **/<a name="line.1573"></a>
<FONT color="green">1574</FONT>        }<a name="line.1574"></a>
<FONT color="green">1575</FONT>    <a name="line.1575"></a>
<FONT color="green">1576</FONT>    <a name="line.1576"></a>
<FONT color="green">1577</FONT>    <a name="line.1577"></a>
<FONT color="green">1578</FONT>        /**<a name="line.1578"></a>
<FONT color="green">1579</FONT>         * Returns a new instance of the class of EOEditingContext that the application should use.  The<a name="line.1579"></a>
<FONT color="green">1580</FONT>         * returned instance is &lt;b&gt;not&lt;/b&gt; locked.<a name="line.1580"></a>
<FONT color="green">1581</FONT>         *<a name="line.1581"></a>
<FONT color="green">1582</FONT>         * @return a new instance of the class of EOEditingContext that the application should use<a name="line.1582"></a>
<FONT color="green">1583</FONT>         */<a name="line.1583"></a>
<FONT color="green">1584</FONT>        public EOEditingContext newEditingContext()<a name="line.1584"></a>
<FONT color="green">1585</FONT>        {<a name="line.1585"></a>
<FONT color="green">1586</FONT>            try<a name="line.1586"></a>
<FONT color="green">1587</FONT>            {<a name="line.1587"></a>
<FONT color="green">1588</FONT>                return (EOEditingContext)editingContextClass().newInstance();<a name="line.1588"></a>
<FONT color="green">1589</FONT>            }<a name="line.1589"></a>
<FONT color="green">1590</FONT>            catch (Exception e)<a name="line.1590"></a>
<FONT color="green">1591</FONT>            {<a name="line.1591"></a>
<FONT color="green">1592</FONT>                throw new net.global_village.foundation.ExceptionConverter(e);<a name="line.1592"></a>
<FONT color="green">1593</FONT>            }<a name="line.1593"></a>
<FONT color="green">1594</FONT>            /** ensure [valid_result] Result != null;<a name="line.1594"></a>
<FONT color="green">1595</FONT>                       [correct_class] editingContextClass().isInstance(Result); **/<a name="line.1595"></a>
<FONT color="green">1596</FONT>        }<a name="line.1596"></a>
<FONT color="green">1597</FONT>    <a name="line.1597"></a>
<FONT color="green">1598</FONT>    <a name="line.1598"></a>
<FONT color="green">1599</FONT>        /**<a name="line.1599"></a>
<FONT color="green">1600</FONT>         * Returns a new instance of the class of EOEditingContext that the application should use.  The<a name="line.1600"></a>
<FONT color="green">1601</FONT>         * returned instance is &lt;b&gt;not&lt;/b&gt; locked.<a name="line.1601"></a>
<FONT color="green">1602</FONT>         *<a name="line.1602"></a>
<FONT color="green">1603</FONT>         * @param parent the parent of this editing context<a name="line.1603"></a>
<FONT color="green">1604</FONT>         * @return a new instance of the class of EOEditingContext that the application should use<a name="line.1604"></a>
<FONT color="green">1605</FONT>         */<a name="line.1605"></a>
<FONT color="green">1606</FONT>        public EOEditingContext newEditingContext(EOObjectStore parent)<a name="line.1606"></a>
<FONT color="green">1607</FONT>        {<a name="line.1607"></a>
<FONT color="green">1608</FONT>            /** require parent != null; **/<a name="line.1608"></a>
<FONT color="green">1609</FONT>    <a name="line.1609"></a>
<FONT color="green">1610</FONT>            try<a name="line.1610"></a>
<FONT color="green">1611</FONT>            {<a name="line.1611"></a>
<FONT color="green">1612</FONT>                Constructor ecConstructor = editingContextClass().getConstructor(new Class[] {EOObjectStore.class});<a name="line.1612"></a>
<FONT color="green">1613</FONT>                return (EOEditingContext)ecConstructor.newInstance(new Object[] {parent});<a name="line.1613"></a>
<FONT color="green">1614</FONT>            }<a name="line.1614"></a>
<FONT color="green">1615</FONT>            catch (Exception e)<a name="line.1615"></a>
<FONT color="green">1616</FONT>            {<a name="line.1616"></a>
<FONT color="green">1617</FONT>                throw new net.global_village.foundation.ExceptionConverter(e);<a name="line.1617"></a>
<FONT color="green">1618</FONT>            }<a name="line.1618"></a>
<FONT color="green">1619</FONT>    <a name="line.1619"></a>
<FONT color="green">1620</FONT>            /** ensure [valid_result] Result != null;<a name="line.1620"></a>
<FONT color="green">1621</FONT>                       [correct_class] editingContextClass().isInstance(Result); **/<a name="line.1621"></a>
<FONT color="green">1622</FONT>        }<a name="line.1622"></a>
<FONT color="green">1623</FONT>    <a name="line.1623"></a>
<FONT color="green">1624</FONT>    <a name="line.1624"></a>
<FONT color="green">1625</FONT>    <a name="line.1625"></a>
<FONT color="green">1626</FONT>        /**<a name="line.1626"></a>
<FONT color="green">1627</FONT>         * Avoid a potential bug that causes session deadlock if WOSession.sleep() throws.<a name="line.1627"></a>
<FONT color="green">1628</FONT>         */<a name="line.1628"></a>
<FONT color="green">1629</FONT>        public void saveSessionForContext(WOContext wocontext)<a name="line.1629"></a>
<FONT color="green">1630</FONT>        {<a name="line.1630"></a>
<FONT color="green">1631</FONT>            try<a name="line.1631"></a>
<FONT color="green">1632</FONT>            {<a name="line.1632"></a>
<FONT color="green">1633</FONT>                super.saveSessionForContext(wocontext);<a name="line.1633"></a>
<FONT color="green">1634</FONT>            }<a name="line.1634"></a>
<FONT color="green">1635</FONT>            catch (Throwable t)<a name="line.1635"></a>
<FONT color="green">1636</FONT>            {<a name="line.1636"></a>
<FONT color="green">1637</FONT>                sessionStore().checkInSessionForContext(wocontext);<a name="line.1637"></a>
<FONT color="green">1638</FONT>            }<a name="line.1638"></a>
<FONT color="green">1639</FONT>        }<a name="line.1639"></a>
<FONT color="green">1640</FONT>    <a name="line.1640"></a>
<FONT color="green">1641</FONT>    <a name="line.1641"></a>
<FONT color="green">1642</FONT>    <a name="line.1642"></a>
<FONT color="green">1643</FONT>        /**<a name="line.1643"></a>
<FONT color="green">1644</FONT>         * Returns the currency formatter using the &lt;code&gt;CustomInfo.plist&lt;/code&gt;<a name="line.1644"></a>
<FONT color="green">1645</FONT>         *<a name="line.1645"></a>
<FONT color="green">1646</FONT>         * @return the currency formatter<a name="line.1646"></a>
<FONT color="green">1647</FONT>         */<a name="line.1647"></a>
<FONT color="green">1648</FONT>        public NSNumberFormatter currencyFormatter()<a name="line.1648"></a>
<FONT color="green">1649</FONT>        {<a name="line.1649"></a>
<FONT color="green">1650</FONT>            return properties().numberFormatterForKey("CurrencyFormatter");<a name="line.1650"></a>
<FONT color="green">1651</FONT>    <a name="line.1651"></a>
<FONT color="green">1652</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1652"></a>
<FONT color="green">1653</FONT>        }<a name="line.1653"></a>
<FONT color="green">1654</FONT>    <a name="line.1654"></a>
<FONT color="green">1655</FONT>    <a name="line.1655"></a>
<FONT color="green">1656</FONT>    <a name="line.1656"></a>
<FONT color="green">1657</FONT>        /**<a name="line.1657"></a>
<FONT color="green">1658</FONT>         * Returns the date formatter using the &lt;code&gt;CustomInfo.plist&lt;/code&gt;.<a name="line.1658"></a>
<FONT color="green">1659</FONT>         *<a name="line.1659"></a>
<FONT color="green">1660</FONT>         * @return the date formatter<a name="line.1660"></a>
<FONT color="green">1661</FONT>         */<a name="line.1661"></a>
<FONT color="green">1662</FONT>        public NSTimestampFormatter dateFormatter()<a name="line.1662"></a>
<FONT color="green">1663</FONT>        {<a name="line.1663"></a>
<FONT color="green">1664</FONT>            return properties().timestampFormatterForKey("DateFormatter");<a name="line.1664"></a>
<FONT color="green">1665</FONT>    <a name="line.1665"></a>
<FONT color="green">1666</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1666"></a>
<FONT color="green">1667</FONT>    <a name="line.1667"></a>
<FONT color="green">1668</FONT>        }<a name="line.1668"></a>
<FONT color="green">1669</FONT>    <a name="line.1669"></a>
<FONT color="green">1670</FONT>    <a name="line.1670"></a>
<FONT color="green">1671</FONT>    <a name="line.1671"></a>
<FONT color="green">1672</FONT>        /**<a name="line.1672"></a>
<FONT color="green">1673</FONT>         * Returns the time formatter using the &lt;code&gt;CustomInfo.plist&lt;/code&gt;.<a name="line.1673"></a>
<FONT color="green">1674</FONT>         *<a name="line.1674"></a>
<FONT color="green">1675</FONT>         * @return the time formatter<a name="line.1675"></a>
<FONT color="green">1676</FONT>         */<a name="line.1676"></a>
<FONT color="green">1677</FONT>        public NSTimestampFormatter timeFormatter()<a name="line.1677"></a>
<FONT color="green">1678</FONT>        {<a name="line.1678"></a>
<FONT color="green">1679</FONT>            return properties().timestampFormatterForKey("TimeFormatter");<a name="line.1679"></a>
<FONT color="green">1680</FONT>    <a name="line.1680"></a>
<FONT color="green">1681</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1681"></a>
<FONT color="green">1682</FONT>        }<a name="line.1682"></a>
<FONT color="green">1683</FONT>    <a name="line.1683"></a>
<FONT color="green">1684</FONT>    <a name="line.1684"></a>
<FONT color="green">1685</FONT>    <a name="line.1685"></a>
<FONT color="green">1686</FONT>        /**<a name="line.1686"></a>
<FONT color="green">1687</FONT>         * Returns the date and time formatter using the &lt;code&gt;CustomInfo.plist&lt;/code&gt;.<a name="line.1687"></a>
<FONT color="green">1688</FONT>         *<a name="line.1688"></a>
<FONT color="green">1689</FONT>         * @return the time formatter<a name="line.1689"></a>
<FONT color="green">1690</FONT>         */<a name="line.1690"></a>
<FONT color="green">1691</FONT>        public NSTimestampFormatter dateTimeFormatter()<a name="line.1691"></a>
<FONT color="green">1692</FONT>        {<a name="line.1692"></a>
<FONT color="green">1693</FONT>            return properties().timestampFormatterForKey("DateTimeFormatter");<a name="line.1693"></a>
<FONT color="green">1694</FONT>    <a name="line.1694"></a>
<FONT color="green">1695</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1695"></a>
<FONT color="green">1696</FONT>        }<a name="line.1696"></a>
<FONT color="green">1697</FONT>    <a name="line.1697"></a>
<FONT color="green">1698</FONT>    <a name="line.1698"></a>
<FONT color="green">1699</FONT>    <a name="line.1699"></a>
<FONT color="green">1700</FONT>        /**<a name="line.1700"></a>
<FONT color="green">1701</FONT>         * Returns the integer formatter using the &lt;code&gt;CustomInfo.plist&lt;/code&gt;<a name="line.1701"></a>
<FONT color="green">1702</FONT>         *<a name="line.1702"></a>
<FONT color="green">1703</FONT>         * @return the integer formatter<a name="line.1703"></a>
<FONT color="green">1704</FONT>         */<a name="line.1704"></a>
<FONT color="green">1705</FONT>        public NSNumberFormatter integerFormatter()<a name="line.1705"></a>
<FONT color="green">1706</FONT>        {<a name="line.1706"></a>
<FONT color="green">1707</FONT>            NSNumberFormatter nf = properties().numberFormatterForKey("IntegerFormatter");<a name="line.1707"></a>
<FONT color="green">1708</FONT>            nf.setAllowsFloats(false);<a name="line.1708"></a>
<FONT color="green">1709</FONT>            return nf;<a name="line.1709"></a>
<FONT color="green">1710</FONT>    <a name="line.1710"></a>
<FONT color="green">1711</FONT>            /** ensure<a name="line.1711"></a>
<FONT color="green">1712</FONT>            [valid_result] Result != null;<a name="line.1712"></a>
<FONT color="green">1713</FONT>            [does_not_allow_floats] ! Result.allowsFloats(); **/<a name="line.1713"></a>
<FONT color="green">1714</FONT>        }<a name="line.1714"></a>
<FONT color="green">1715</FONT>    <a name="line.1715"></a>
<FONT color="green">1716</FONT>    <a name="line.1716"></a>
<FONT color="green">1717</FONT>    <a name="line.1717"></a>
<FONT color="green">1718</FONT>        /**<a name="line.1718"></a>
<FONT color="green">1719</FONT>         * Returns the number formatter using the &lt;code&gt;CustomInfo.plist&lt;/code&gt;<a name="line.1719"></a>
<FONT color="green">1720</FONT>         *<a name="line.1720"></a>
<FONT color="green">1721</FONT>         * @return the number formatter<a name="line.1721"></a>
<FONT color="green">1722</FONT>         */<a name="line.1722"></a>
<FONT color="green">1723</FONT>        public NSNumberFormatter numberFormatter()<a name="line.1723"></a>
<FONT color="green">1724</FONT>        {<a name="line.1724"></a>
<FONT color="green">1725</FONT>            return properties().numberFormatterForKey("NumberFormatter");<a name="line.1725"></a>
<FONT color="green">1726</FONT>    <a name="line.1726"></a>
<FONT color="green">1727</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1727"></a>
<FONT color="green">1728</FONT>        }<a name="line.1728"></a>
<FONT color="green">1729</FONT>    <a name="line.1729"></a>
<FONT color="green">1730</FONT>    <a name="line.1730"></a>
<FONT color="green">1731</FONT>    <a name="line.1731"></a>
<FONT color="green">1732</FONT>        /**<a name="line.1732"></a>
<FONT color="green">1733</FONT>         * Returns the list of property keys that are required to be in the properties list to ensure that the application configuration information is complete and reasonable.<a name="line.1733"></a>
<FONT color="green">1734</FONT>         *<a name="line.1734"></a>
<FONT color="green">1735</FONT>         * @return the mutable array of required property keys<a name="line.1735"></a>
<FONT color="green">1736</FONT>         */<a name="line.1736"></a>
<FONT color="green">1737</FONT>        protected NSMutableArray requiredProperties()<a name="line.1737"></a>
<FONT color="green">1738</FONT>        {<a name="line.1738"></a>
<FONT color="green">1739</FONT>            return requiredProperties;<a name="line.1739"></a>
<FONT color="green">1740</FONT>    <a name="line.1740"></a>
<FONT color="green">1741</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1741"></a>
<FONT color="green">1742</FONT>        }<a name="line.1742"></a>
<FONT color="green">1743</FONT>    <a name="line.1743"></a>
<FONT color="green">1744</FONT>    <a name="line.1744"></a>
<FONT color="green">1745</FONT>    <a name="line.1745"></a>
<FONT color="green">1746</FONT>        /**<a name="line.1746"></a>
<FONT color="green">1747</FONT>         * Returns the properies object containing the application configuration so that KVC can access this making bindings easier to write.<a name="line.1747"></a>
<FONT color="green">1748</FONT>         *<a name="line.1748"></a>
<FONT color="green">1749</FONT>         * @return the properies object containing the application configuration.<a name="line.1749"></a>
<FONT color="green">1750</FONT>         */<a name="line.1750"></a>
<FONT color="green">1751</FONT>        public ApplicationProperties properties()<a name="line.1751"></a>
<FONT color="green">1752</FONT>        {<a name="line.1752"></a>
<FONT color="green">1753</FONT>            return properties;<a name="line.1753"></a>
<FONT color="green">1754</FONT>    <a name="line.1754"></a>
<FONT color="green">1755</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.1755"></a>
<FONT color="green">1756</FONT>        }<a name="line.1756"></a>
<FONT color="green">1757</FONT>    <a name="line.1757"></a>
<FONT color="green">1758</FONT>    <a name="line.1758"></a>
<FONT color="green">1759</FONT>    <a name="line.1759"></a>
<FONT color="green">1760</FONT>        /**<a name="line.1760"></a>
<FONT color="green">1761</FONT>         * Optional name of a framework to take configuration information from.  This can be used with<a name="line.1761"></a>
<FONT color="green">1762</FONT>         * NSBundle and WOResourceManager.  If null (the default), there is no configuration framework.<a name="line.1762"></a>
<FONT color="green">1763</FONT>         *<a name="line.1763"></a>
<FONT color="green">1764</FONT>         * @return null or the name of the framework to take configuration information from<a name="line.1764"></a>
<FONT color="green">1765</FONT>         */<a name="line.1765"></a>
<FONT color="green">1766</FONT>        public String configurationFrameworkName()<a name="line.1766"></a>
<FONT color="green">1767</FONT>        {<a name="line.1767"></a>
<FONT color="green">1768</FONT>            return null;<a name="line.1768"></a>
<FONT color="green">1769</FONT>        }<a name="line.1769"></a>
<FONT color="green">1770</FONT>    <a name="line.1770"></a>
<FONT color="green">1771</FONT>    <a name="line.1771"></a>
<FONT color="green">1772</FONT>        public NSDictionary pageMap()<a name="line.1772"></a>
<FONT color="green">1773</FONT>        {<a name="line.1773"></a>
<FONT color="green">1774</FONT>            return pageMap;<a name="line.1774"></a>
<FONT color="green">1775</FONT>        }<a name="line.1775"></a>
<FONT color="green">1776</FONT>    <a name="line.1776"></a>
<FONT color="green">1777</FONT>    <a name="line.1777"></a>
<FONT color="green">1778</FONT>        public boolean hasPageMap()<a name="line.1778"></a>
<FONT color="green">1779</FONT>        {<a name="line.1779"></a>
<FONT color="green">1780</FONT>            return pageMap() != null;<a name="line.1780"></a>
<FONT color="green">1781</FONT>        }<a name="line.1781"></a>
<FONT color="green">1782</FONT>    <a name="line.1782"></a>
<FONT color="green">1783</FONT>    <a name="line.1783"></a>
<FONT color="green">1784</FONT>    <a name="line.1784"></a>
<FONT color="green">1785</FONT>        /**<a name="line.1785"></a>
<FONT color="green">1786</FONT>         * For Click to Open support and generally useful.<a name="line.1786"></a>
<FONT color="green">1787</FONT>         *<a name="line.1787"></a>
<FONT color="green">1788</FONT>         * @see "README in WOLips framework from Project Wonder"<a name="line.1788"></a>
<FONT color="green">1789</FONT>         * @see &lt;a href="http://wiki.objectstyle.org/confluence/display/WOL/Click+to+Open"&gt;Click to Open Wiki page&lt;/a&gt;<a name="line.1789"></a>
<FONT color="green">1790</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the app is in development mode<a name="line.1790"></a>
<FONT color="green">1791</FONT>         */<a name="line.1791"></a>
<FONT color="green">1792</FONT>        public boolean developmentMode()<a name="line.1792"></a>
<FONT color="green">1793</FONT>        {<a name="line.1793"></a>
<FONT color="green">1794</FONT>            if (isDevelopmentMode == null)<a name="line.1794"></a>
<FONT color="green">1795</FONT>            {<a name="line.1795"></a>
<FONT color="green">1796</FONT>                isDevelopmentMode = properties().hasPropertyForKey("DevelopmentMode") ? new GVCBoolean(properties().booleanPropertyForKey("DevelopmentMode")) : GVCBoolean.falseBoolean();<a name="line.1796"></a>
<FONT color="green">1797</FONT>            }<a name="line.1797"></a>
<FONT color="green">1798</FONT>    <a name="line.1798"></a>
<FONT color="green">1799</FONT>            return isDevelopmentMode.booleanValue();<a name="line.1799"></a>
<FONT color="green">1800</FONT>        }<a name="line.1800"></a>
<FONT color="green">1801</FONT>    <a name="line.1801"></a>
<FONT color="green">1802</FONT>    <a name="line.1802"></a>
<FONT color="green">1803</FONT>    <a name="line.1803"></a>
<FONT color="green">1804</FONT>        /**<a name="line.1804"></a>
<FONT color="green">1805</FONT>         * Returns ERXMigrator instance to use for migration.  The default is an instance of the inner class<a name="line.1805"></a>
<FONT color="green">1806</FONT>         * Migrator.<a name="line.1806"></a>
<FONT color="green">1807</FONT>         *<a name="line.1807"></a>
<FONT color="green">1808</FONT>         * @return ERXMigrator instance to use for migration<a name="line.1808"></a>
<FONT color="green">1809</FONT>         */<a name="line.1809"></a>
<FONT color="green">1810</FONT>        protected ERXMigrator migrator()<a name="line.1810"></a>
<FONT color="green">1811</FONT>        {<a name="line.1811"></a>
<FONT color="green">1812</FONT>            return new Migrator();<a name="line.1812"></a>
<FONT color="green">1813</FONT>        }<a name="line.1813"></a>
<FONT color="green">1814</FONT>    <a name="line.1814"></a>
<FONT color="green">1815</FONT>    <a name="line.1815"></a>
<FONT color="green">1816</FONT>    <a name="line.1816"></a>
<FONT color="green">1817</FONT>        /**<a name="line.1817"></a>
<FONT color="green">1818</FONT>         * ERXMigrator subclass that sets the lock owner automatically and uses the enclosing classes<a name="line.1818"></a>
<FONT color="green">1819</FONT>         * newEditingContext() method to create the editing contexts to use for migration.<a name="line.1819"></a>
<FONT color="green">1820</FONT>         */<a name="line.1820"></a>
<FONT color="green">1821</FONT>        class Migrator extends ERXMigrator<a name="line.1821"></a>
<FONT color="green">1822</FONT>        {<a name="line.1822"></a>
<FONT color="green">1823</FONT>    <a name="line.1823"></a>
<FONT color="green">1824</FONT>            /**<a name="line.1824"></a>
<FONT color="green">1825</FONT>             * Constructs an ERXMigrator with appname-portNumber as the lock owner.<a name="line.1825"></a>
<FONT color="green">1826</FONT>             */<a name="line.1826"></a>
<FONT color="green">1827</FONT>            public Migrator()<a name="line.1827"></a>
<FONT color="green">1828</FONT>            {<a name="line.1828"></a>
<FONT color="green">1829</FONT>                super(name() + "-" + host() + ":" + port());<a name="line.1829"></a>
<FONT color="green">1830</FONT>                NSLog.out.appendln("Created Migrator for " + name() + "-" + host() + ":" + port());<a name="line.1830"></a>
<FONT color="green">1831</FONT>            }<a name="line.1831"></a>
<FONT color="green">1832</FONT>    <a name="line.1832"></a>
<FONT color="green">1833</FONT>    <a name="line.1833"></a>
<FONT color="green">1834</FONT>    <a name="line.1834"></a>
<FONT color="green">1835</FONT>            /**<a name="line.1835"></a>
<FONT color="green">1836</FONT>             * @return WOApplication.this.newEditingContext()<a name="line.1836"></a>
<FONT color="green">1837</FONT>             */<a name="line.1837"></a>
<FONT color="green">1838</FONT>            protected EOEditingContext newEditingContext() {<a name="line.1838"></a>
<FONT color="green">1839</FONT>                return WOApplication.this.newEditingContext();<a name="line.1839"></a>
<FONT color="green">1840</FONT>            }<a name="line.1840"></a>
<FONT color="green">1841</FONT>    <a name="line.1841"></a>
<FONT color="green">1842</FONT>        }<a name="line.1842"></a>
<FONT color="green">1843</FONT>    <a name="line.1843"></a>
<FONT color="green">1844</FONT>    <a name="line.1844"></a>
<FONT color="green">1845</FONT>        // Blatant ripoff of code added to ERXApplication until we start subclassing that for real<a name="line.1845"></a>
<FONT color="green">1846</FONT>        // This is for ClickToDebug<a name="line.1846"></a>
<FONT color="green">1847</FONT>        protected void _debugValueForDeclarationNamed(WOComponent component, String verb, String aDeclarationName, String aDeclarationType, String aBindingName, String anAssociationDescription, Object aValue) {<a name="line.1847"></a>
<FONT color="green">1848</FONT>            if (aValue instanceof String) {<a name="line.1848"></a>
<FONT color="green">1849</FONT>                StringBuffer stringbuffer = new StringBuffer(((String) aValue).length() + 2);<a name="line.1849"></a>
<FONT color="green">1850</FONT>                stringbuffer.append('"');<a name="line.1850"></a>
<FONT color="green">1851</FONT>                stringbuffer.append(aValue);<a name="line.1851"></a>
<FONT color="green">1852</FONT>                stringbuffer.append('"');<a name="line.1852"></a>
<FONT color="green">1853</FONT>                aValue = stringbuffer;<a name="line.1853"></a>
<FONT color="green">1854</FONT>            }<a name="line.1854"></a>
<FONT color="green">1855</FONT>            if (aDeclarationName.startsWith("_")) {<a name="line.1855"></a>
<FONT color="green">1856</FONT>                aDeclarationName = "[inline]";<a name="line.1856"></a>
<FONT color="green">1857</FONT>            }<a name="line.1857"></a>
<FONT color="green">1858</FONT>    <a name="line.1858"></a>
<FONT color="green">1859</FONT>            StringBuffer sb = new StringBuffer();<a name="line.1859"></a>
<FONT color="green">1860</FONT>    <a name="line.1860"></a>
<FONT color="green">1861</FONT>            //NSArray&lt;WOComponent&gt; componentPath = ERXWOContext._componentPath(ERXWOContext.currentContext());<a name="line.1861"></a>
<FONT color="green">1862</FONT>            //componentPath.lastObject()<a name="line.1862"></a>
<FONT color="green">1863</FONT>            //WOComponent lastComponent = ERXWOContext.currentContext().component();<a name="line.1863"></a>
<FONT color="green">1864</FONT>            String lastComponentName = component.name().replaceFirst(".*\\.", "");<a name="line.1864"></a>
<FONT color="green">1865</FONT>            sb.append(lastComponentName);<a name="line.1865"></a>
<FONT color="green">1866</FONT>    <a name="line.1866"></a>
<FONT color="green">1867</FONT>            sb.append(verb);<a name="line.1867"></a>
<FONT color="green">1868</FONT>    <a name="line.1868"></a>
<FONT color="green">1869</FONT>            if (!aDeclarationName.startsWith("_")) {<a name="line.1869"></a>
<FONT color="green">1870</FONT>                sb.append(aDeclarationName);<a name="line.1870"></a>
<FONT color="green">1871</FONT>                sb.append(":");<a name="line.1871"></a>
<FONT color="green">1872</FONT>            }<a name="line.1872"></a>
<FONT color="green">1873</FONT>            sb.append(aDeclarationType);<a name="line.1873"></a>
<FONT color="green">1874</FONT>    <a name="line.1874"></a>
<FONT color="green">1875</FONT>            sb.append(" { ");<a name="line.1875"></a>
<FONT color="green">1876</FONT>            sb.append(aBindingName);<a name="line.1876"></a>
<FONT color="green">1877</FONT>            sb.append("=");<a name="line.1877"></a>
<FONT color="green">1878</FONT>    <a name="line.1878"></a>
<FONT color="green">1879</FONT>            String valueStr = aValue != null ? aValue.toString() : "null";<a name="line.1879"></a>
<FONT color="green">1880</FONT>            if (anAssociationDescription.startsWith("class ")) {<a name="line.1880"></a>
<FONT color="green">1881</FONT>                sb.append(valueStr);<a name="line.1881"></a>
<FONT color="green">1882</FONT>                sb.append("; }");<a name="line.1882"></a>
<FONT color="green">1883</FONT>            }<a name="line.1883"></a>
<FONT color="green">1884</FONT>            else {<a name="line.1884"></a>
<FONT color="green">1885</FONT>                sb.append(anAssociationDescription);<a name="line.1885"></a>
<FONT color="green">1886</FONT>                sb.append("; } value ");<a name="line.1886"></a>
<FONT color="green">1887</FONT>                sb.append(valueStr);<a name="line.1887"></a>
<FONT color="green">1888</FONT>            }<a name="line.1888"></a>
<FONT color="green">1889</FONT>    <a name="line.1889"></a>
<FONT color="green">1890</FONT>            logger.info(sb.toString());<a name="line.1890"></a>
<FONT color="green">1891</FONT>        }<a name="line.1891"></a>
<FONT color="green">1892</FONT>    <a name="line.1892"></a>
<FONT color="green">1893</FONT>        /**<a name="line.1893"></a>
<FONT color="green">1894</FONT>         * The set of component names that have binding debug enabled<a name="line.1894"></a>
<FONT color="green">1895</FONT>         */<a name="line.1895"></a>
<FONT color="green">1896</FONT>        private NSMutableSet _debugComponents = new NSMutableSet();<a name="line.1896"></a>
<FONT color="green">1897</FONT>    <a name="line.1897"></a>
<FONT color="green">1898</FONT>        /**<a name="line.1898"></a>
<FONT color="green">1899</FONT>         * Little bit better binding debug output than the original.<a name="line.1899"></a>
<FONT color="green">1900</FONT>         */<a name="line.1900"></a>
<FONT color="green">1901</FONT>        public void logTakeValueForDeclarationNamed(String aDeclarationName, String aDeclarationType, String aBindingName, String anAssociationDescription, Object aValue) {<a name="line.1901"></a>
<FONT color="green">1902</FONT>            WOComponent component = ERXWOContext.currentContext().component();<a name="line.1902"></a>
<FONT color="green">1903</FONT>            if (component.parent() != null) {<a name="line.1903"></a>
<FONT color="green">1904</FONT>                component = component.parent();<a name="line.1904"></a>
<FONT color="green">1905</FONT>            }<a name="line.1905"></a>
<FONT color="green">1906</FONT>            _debugValueForDeclarationNamed(component, " ==&gt; ", aDeclarationName, aDeclarationType, aBindingName, anAssociationDescription, aValue);<a name="line.1906"></a>
<FONT color="green">1907</FONT>        }<a name="line.1907"></a>
<FONT color="green">1908</FONT>    <a name="line.1908"></a>
<FONT color="green">1909</FONT>        /**<a name="line.1909"></a>
<FONT color="green">1910</FONT>         * Little bit better binding debug output than the original.<a name="line.1910"></a>
<FONT color="green">1911</FONT>         */<a name="line.1911"></a>
<FONT color="green">1912</FONT>        public void logSetValueForDeclarationNamed(String aDeclarationName, String aDeclarationType, String aBindingName, String anAssociationDescription, Object aValue) {<a name="line.1912"></a>
<FONT color="green">1913</FONT>            WOComponent component = ERXWOContext.currentContext().component();<a name="line.1913"></a>
<FONT color="green">1914</FONT>            if (component.parent() != null) {<a name="line.1914"></a>
<FONT color="green">1915</FONT>                component = component.parent();<a name="line.1915"></a>
<FONT color="green">1916</FONT>            }<a name="line.1916"></a>
<FONT color="green">1917</FONT>            _debugValueForDeclarationNamed(component, " &lt;== ", aDeclarationName, aDeclarationType, aBindingName, anAssociationDescription, aValue);<a name="line.1917"></a>
<FONT color="green">1918</FONT>        }<a name="line.1918"></a>
<FONT color="green">1919</FONT>    <a name="line.1919"></a>
<FONT color="green">1920</FONT>        /**<a name="line.1920"></a>
<FONT color="green">1921</FONT>         * Turns on/off binding debugging for the given component.  Binding debugging requires using the WOOgnl<a name="line.1921"></a>
<FONT color="green">1922</FONT>         * template parser and setting ognl.debugSupport=true.<a name="line.1922"></a>
<FONT color="green">1923</FONT>         *<a name="line.1923"></a>
<FONT color="green">1924</FONT>         * @param debugEnabled whether or not to enable debugging<a name="line.1924"></a>
<FONT color="green">1925</FONT>         * @param componentName the component name to enable debugging for<a name="line.1925"></a>
<FONT color="green">1926</FONT>         */<a name="line.1926"></a>
<FONT color="green">1927</FONT>        public void setDebugEnabledForComponent(boolean debugEnabled, String componentName) {<a name="line.1927"></a>
<FONT color="green">1928</FONT>            if (debugEnabled) {<a name="line.1928"></a>
<FONT color="green">1929</FONT>                _debugComponents.addObject(componentName);<a name="line.1929"></a>
<FONT color="green">1930</FONT>            }<a name="line.1930"></a>
<FONT color="green">1931</FONT>            else {<a name="line.1931"></a>
<FONT color="green">1932</FONT>                _debugComponents.removeObject(componentName);<a name="line.1932"></a>
<FONT color="green">1933</FONT>            }<a name="line.1933"></a>
<FONT color="green">1934</FONT>        }<a name="line.1934"></a>
<FONT color="green">1935</FONT>    <a name="line.1935"></a>
<FONT color="green">1936</FONT>        /**<a name="line.1936"></a>
<FONT color="green">1937</FONT>         * Returns whether or not binding debugging is enabled for the given component<a name="line.1937"></a>
<FONT color="green">1938</FONT>         *<a name="line.1938"></a>
<FONT color="green">1939</FONT>         * @param componentName the component name<a name="line.1939"></a>
<FONT color="green">1940</FONT>         * @return whether or not binding debugging is enabled for the given componen<a name="line.1940"></a>
<FONT color="green">1941</FONT>         */<a name="line.1941"></a>
<FONT color="green">1942</FONT>        public boolean debugEnabledForComponent(String componentName) {<a name="line.1942"></a>
<FONT color="green">1943</FONT>            return _debugComponents.containsObject(componentName);<a name="line.1943"></a>
<FONT color="green">1944</FONT>        }<a name="line.1944"></a>
<FONT color="green">1945</FONT>    <a name="line.1945"></a>
<FONT color="green">1946</FONT>        /**<a name="line.1946"></a>
<FONT color="green">1947</FONT>         * Turns off binding debugging for all components.<a name="line.1947"></a>
<FONT color="green">1948</FONT>         */<a name="line.1948"></a>
<FONT color="green">1949</FONT>        public void clearDebugEnabledForAllComponents() {<a name="line.1949"></a>
<FONT color="green">1950</FONT>            _debugComponents.removeAllObjects();<a name="line.1950"></a>
<FONT color="green">1951</FONT>        }<a name="line.1951"></a>
<FONT color="green">1952</FONT>    <a name="line.1952"></a>
<FONT color="green">1953</FONT>    }<a name="line.1953"></a>




























































</PRE>
</BODY>
</HTML>
