<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    package net.global_village.woextensions;<a name="line.1"></a>
<FONT color="green">002</FONT>    <a name="line.2"></a>
<FONT color="green">003</FONT>    import java.util.*;<a name="line.3"></a>
<FONT color="green">004</FONT>    <a name="line.4"></a>
<FONT color="green">005</FONT>    import com.webobjects.appserver.*;<a name="line.5"></a>
<FONT color="green">006</FONT>    import com.webobjects.appserver._private.*;<a name="line.6"></a>
<FONT color="green">007</FONT>    import com.webobjects.foundation.*;<a name="line.7"></a>
<FONT color="green">008</FONT>    <a name="line.8"></a>
<FONT color="green">009</FONT>    import net.global_village.foundation.*;<a name="line.9"></a>
<FONT color="green">010</FONT>    <a name="line.10"></a>
<FONT color="green">011</FONT>    <a name="line.11"></a>
<FONT color="green">012</FONT>    /**<a name="line.12"></a>
<FONT color="green">013</FONT>     * RequestUtilities provides easy access to information contained in a WORequest.  Browser detection (via JavaScript) is detailed at &lt;a href="http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html"&gt;this site&lt;/a&gt; is useful as it contains an extensive list of browser versions and how they are detected.  Since we are primarily concerned with CSS &lt;A HREF="http://www.webreview.com/style/css1/charts/mastergrid.shtml"&gt;this link&lt;/a&gt; lists the major browser changes that effected CSS.  The details of the User-Agent header are listed   &lt;A HREF="http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#user-agent"&gt;here&lt;/A&gt;<a name="line.13"></a>
<FONT color="green">014</FONT>     *<a name="line.14"></a>
<FONT color="green">015</FONT>     * @author Copyright (c) 2001-2005  Global Village Consulting, Inc.  All rights reserved.<a name="line.15"></a>
<FONT color="green">016</FONT>     * This software is published under the terms of the Educational Community License (ECL) version 1.0,<a name="line.16"></a>
<FONT color="green">017</FONT>     * a copy of which has been included with this distribution in the LICENSE.TXT file.<a name="line.17"></a>
<FONT color="green">018</FONT>     * @version $Revision: 16$<a name="line.18"></a>
<FONT color="green">019</FONT>     */<a name="line.19"></a>
<FONT color="green">020</FONT>    public class RequestUtilities extends Object<a name="line.20"></a>
<FONT color="green">021</FONT>    {<a name="line.21"></a>
<FONT color="green">022</FONT>        // note all UserAgents and OS strings are in lower case where mixed case is the actual contained in the header<a name="line.22"></a>
<FONT color="green">023</FONT>        public static final String operaUserAgent = "opera";<a name="line.23"></a>
<FONT color="green">024</FONT>        public static final String ieUserAgent = "msie";<a name="line.24"></a>
<FONT color="green">025</FONT>        public static final String mozillaUserAgent = "mozilla";<a name="line.25"></a>
<FONT color="green">026</FONT>        public static final String geckoBasedUserAgent = "gecko";<a name="line.26"></a>
<FONT color="green">027</FONT>        public static final String safariUserAgent = "safari";<a name="line.27"></a>
<FONT color="green">028</FONT>        public static final String firefoxUserAgent = "firefox";<a name="line.28"></a>
<FONT color="green">029</FONT>    <a name="line.29"></a>
<FONT color="green">030</FONT>        public static final String netscapeVersionString = "netscape";<a name="line.30"></a>
<FONT color="green">031</FONT>    <a name="line.31"></a>
<FONT color="green">032</FONT>        public static final String macOSIdentifierString = "mac";<a name="line.32"></a>
<FONT color="green">033</FONT>        public static final String windowsIdentifierString = "win";  // we are treating all windows versions alike currently<a name="line.33"></a>
<FONT color="green">034</FONT>    <a name="line.34"></a>
<FONT color="green">035</FONT>        public static final String defaultKey = "default";<a name="line.35"></a>
<FONT color="green">036</FONT>    <a name="line.36"></a>
<FONT color="green">037</FONT>        public static final String userAgentNameKeyPathPrefix = "RequestUtilities.browsers.";<a name="line.37"></a>
<FONT color="green">038</FONT>        public static final String userOSKeyPathPrefix = "RequestUtilities.operatingSystems.";<a name="line.38"></a>
<FONT color="green">039</FONT>        public static String userAgentKey = "User-Agent";<a name="line.39"></a>
<FONT color="green">040</FONT>    <a name="line.40"></a>
<FONT color="green">041</FONT>    <a name="line.41"></a>
<FONT color="green">042</FONT>        protected static NSDictionary countriesISO3166;<a name="line.42"></a>
<FONT color="green">043</FONT>        protected static NSDictionary languagesISO639;<a name="line.43"></a>
<FONT color="green">044</FONT>        protected static String defaultLanguageISOCode = "en";<a name="line.44"></a>
<FONT color="green">045</FONT>    <a name="line.45"></a>
<FONT color="green">046</FONT>    <a name="line.46"></a>
<FONT color="green">047</FONT>        /**<a name="line.47"></a>
<FONT color="green">048</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is from &lt;code&gt;Opera&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.48"></a>
<FONT color="green">049</FONT>         *<a name="line.49"></a>
<FONT color="green">050</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.50"></a>
<FONT color="green">051</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is &lt;code&gt;Opera&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.51"></a>
<FONT color="green">052</FONT>         */<a name="line.52"></a>
<FONT color="green">053</FONT>        public static boolean isUserAgentOpera(WORequest request)<a name="line.53"></a>
<FONT color="green">054</FONT>        {<a name="line.54"></a>
<FONT color="green">055</FONT>            /** require [valid_param] request != null; **/<a name="line.55"></a>
<FONT color="green">056</FONT>    <a name="line.56"></a>
<FONT color="green">057</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.57"></a>
<FONT color="green">058</FONT>            return (userAgent.indexOf(RequestUtilities.operaUserAgent) != -1);<a name="line.58"></a>
<FONT color="green">059</FONT>        }<a name="line.59"></a>
<FONT color="green">060</FONT>    <a name="line.60"></a>
<FONT color="green">061</FONT>    <a name="line.61"></a>
<FONT color="green">062</FONT>    <a name="line.62"></a>
<FONT color="green">063</FONT>        /**<a name="line.63"></a>
<FONT color="green">064</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is from &lt;code&gt;Internet Explorer&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.64"></a>
<FONT color="green">065</FONT>         *<a name="line.65"></a>
<FONT color="green">066</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.66"></a>
<FONT color="green">067</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is from &lt;code&gt;Internet Explorer&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise<a name="line.67"></a>
<FONT color="green">068</FONT>         */<a name="line.68"></a>
<FONT color="green">069</FONT>        public static boolean isUserAgentInternetExplorer(WORequest request)<a name="line.69"></a>
<FONT color="green">070</FONT>        {<a name="line.70"></a>
<FONT color="green">071</FONT>            /** require [valid_param] request != null; **/<a name="line.71"></a>
<FONT color="green">072</FONT>    <a name="line.72"></a>
<FONT color="green">073</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.73"></a>
<FONT color="green">074</FONT>            return (userAgent.indexOf(RequestUtilities.ieUserAgent) != -1);<a name="line.74"></a>
<FONT color="green">075</FONT>        }<a name="line.75"></a>
<FONT color="green">076</FONT>    <a name="line.76"></a>
<FONT color="green">077</FONT>    <a name="line.77"></a>
<FONT color="green">078</FONT>    <a name="line.78"></a>
<FONT color="green">079</FONT>        /**<a name="line.79"></a>
<FONT color="green">080</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is from &lt;code&gt;Netscape&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.80"></a>
<FONT color="green">081</FONT>         *<a name="line.81"></a>
<FONT color="green">082</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.82"></a>
<FONT color="green">083</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is from &lt;code&gt;Netscape&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise<a name="line.83"></a>
<FONT color="green">084</FONT>         */<a name="line.84"></a>
<FONT color="green">085</FONT>        public static boolean isUserAgentNetscape(WORequest request)<a name="line.85"></a>
<FONT color="green">086</FONT>        {<a name="line.86"></a>
<FONT color="green">087</FONT>            /** require [valid_param] request != null; **/<a name="line.87"></a>
<FONT color="green">088</FONT>    <a name="line.88"></a>
<FONT color="green">089</FONT>            // All netscapes are based on Mozilla but perhaps not all of them contain "netscape" in their user-agent string, in fact most old ones do not, so the best we can do is check ie and other specific browser tests before this one.<a name="line.89"></a>
<FONT color="green">090</FONT>            return RequestUtilities.isUserAgentMozillaCompatible(request);<a name="line.90"></a>
<FONT color="green">091</FONT>        }<a name="line.91"></a>
<FONT color="green">092</FONT>    <a name="line.92"></a>
<FONT color="green">093</FONT>    <a name="line.93"></a>
<FONT color="green">094</FONT>    <a name="line.94"></a>
<FONT color="green">095</FONT>        /**<a name="line.95"></a>
<FONT color="green">096</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the user agent mentions mozilla, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.96"></a>
<FONT color="green">097</FONT>         *<a name="line.97"></a>
<FONT color="green">098</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.98"></a>
<FONT color="green">099</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the user agent mentions mozilla, &lt;code&gt;false&lt;/code&gt; otherwise<a name="line.99"></a>
<FONT color="green">100</FONT>         */<a name="line.100"></a>
<FONT color="green">101</FONT>        public static boolean isUserAgentMozillaCompatible(WORequest request)<a name="line.101"></a>
<FONT color="green">102</FONT>        {<a name="line.102"></a>
<FONT color="green">103</FONT>            /** require [valid_param] request != null; **/<a name="line.103"></a>
<FONT color="green">104</FONT>    <a name="line.104"></a>
<FONT color="green">105</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.105"></a>
<FONT color="green">106</FONT>            return (userAgent.indexOf(RequestUtilities.mozillaUserAgent) != -1);<a name="line.106"></a>
<FONT color="green">107</FONT>        }<a name="line.107"></a>
<FONT color="green">108</FONT>    <a name="line.108"></a>
<FONT color="green">109</FONT>    <a name="line.109"></a>
<FONT color="green">110</FONT>    <a name="line.110"></a>
<FONT color="green">111</FONT>        public static boolean isUserAgentSafari(WORequest request)<a name="line.111"></a>
<FONT color="green">112</FONT>        {<a name="line.112"></a>
<FONT color="green">113</FONT>            /** require [valid_param] request != null; **/<a name="line.113"></a>
<FONT color="green">114</FONT>    <a name="line.114"></a>
<FONT color="green">115</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.115"></a>
<FONT color="green">116</FONT>            return ((userAgent.indexOf(RequestUtilities.safariUserAgent) != -1) &amp;&amp; isUserOSMac(request));<a name="line.116"></a>
<FONT color="green">117</FONT>        }<a name="line.117"></a>
<FONT color="green">118</FONT>    <a name="line.118"></a>
<FONT color="green">119</FONT>    <a name="line.119"></a>
<FONT color="green">120</FONT>    <a name="line.120"></a>
<FONT color="green">121</FONT>        public static boolean isUserAgentFirefox(WORequest request)<a name="line.121"></a>
<FONT color="green">122</FONT>        {<a name="line.122"></a>
<FONT color="green">123</FONT>            /** require [valid_param] request != null; **/<a name="line.123"></a>
<FONT color="green">124</FONT>    <a name="line.124"></a>
<FONT color="green">125</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.125"></a>
<FONT color="green">126</FONT>            return (userAgent.indexOf(RequestUtilities.firefoxUserAgent) != -1);<a name="line.126"></a>
<FONT color="green">127</FONT>        }<a name="line.127"></a>
<FONT color="green">128</FONT>    <a name="line.128"></a>
<FONT color="green">129</FONT>    <a name="line.129"></a>
<FONT color="green">130</FONT>    <a name="line.130"></a>
<FONT color="green">131</FONT>        /**<a name="line.131"></a>
<FONT color="green">132</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument contains Gecko but not the safariUserAgent as<a name="line.132"></a>
<FONT color="green">133</FONT>         initially Safari was billing itself as "like Gecko" but it does not use Gecko at all.<a name="line.133"></a>
<FONT color="green">134</FONT>         *<a name="line.134"></a>
<FONT color="green">135</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.135"></a>
<FONT color="green">136</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument contains Gecko else returns false<a name="line.136"></a>
<FONT color="green">137</FONT>         */<a name="line.137"></a>
<FONT color="green">138</FONT>        public static boolean isUserAgentUsingGecko(WORequest request)<a name="line.138"></a>
<FONT color="green">139</FONT>        {<a name="line.139"></a>
<FONT color="green">140</FONT>            /** require [valid_param] request != null; **/<a name="line.140"></a>
<FONT color="green">141</FONT>            boolean result = false;<a name="line.141"></a>
<FONT color="green">142</FONT>    <a name="line.142"></a>
<FONT color="green">143</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.143"></a>
<FONT color="green">144</FONT>    <a name="line.144"></a>
<FONT color="green">145</FONT>            if (userAgent.indexOf(RequestUtilities.geckoBasedUserAgent) != -1)<a name="line.145"></a>
<FONT color="green">146</FONT>            {<a name="line.146"></a>
<FONT color="green">147</FONT>                if (userAgent.indexOf(RequestUtilities.safariUserAgent) == -1)<a name="line.147"></a>
<FONT color="green">148</FONT>                {<a name="line.148"></a>
<FONT color="green">149</FONT>                    // This omits safari which uses KHTML to render pages and not Gecko,  user agents have been known to change, Safari's original user-agent string included the phrase "like Gecko" to get past browser detection code thus the extra test.<a name="line.149"></a>
<FONT color="green">150</FONT>                    result = true;<a name="line.150"></a>
<FONT color="green">151</FONT>                }<a name="line.151"></a>
<FONT color="green">152</FONT>            }<a name="line.152"></a>
<FONT color="green">153</FONT>    <a name="line.153"></a>
<FONT color="green">154</FONT>            return result;<a name="line.154"></a>
<FONT color="green">155</FONT>        }<a name="line.155"></a>
<FONT color="green">156</FONT>    <a name="line.156"></a>
<FONT color="green">157</FONT>    <a name="line.157"></a>
<FONT color="green">158</FONT>    <a name="line.158"></a>
<FONT color="green">159</FONT>    <a name="line.159"></a>
<FONT color="green">160</FONT>        /**<a name="line.160"></a>
<FONT color="green">161</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the user OS from the request argument from &lt;code&gt;Windows&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.161"></a>
<FONT color="green">162</FONT>         *<a name="line.162"></a>
<FONT color="green">163</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.163"></a>
<FONT color="green">164</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is from &lt;code&gt;Windows&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise<a name="line.164"></a>
<FONT color="green">165</FONT>         */<a name="line.165"></a>
<FONT color="green">166</FONT>        public static boolean isUserOSWindows(WORequest request)<a name="line.166"></a>
<FONT color="green">167</FONT>        {<a name="line.167"></a>
<FONT color="green">168</FONT>            /** require [valid_param] request != null; **/<a name="line.168"></a>
<FONT color="green">169</FONT>    <a name="line.169"></a>
<FONT color="green">170</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.170"></a>
<FONT color="green">171</FONT>            return (userAgent.indexOf(RequestUtilities.windowsIdentifierString) != -1);<a name="line.171"></a>
<FONT color="green">172</FONT>        }<a name="line.172"></a>
<FONT color="green">173</FONT>    <a name="line.173"></a>
<FONT color="green">174</FONT>    <a name="line.174"></a>
<FONT color="green">175</FONT>    <a name="line.175"></a>
<FONT color="green">176</FONT>        /**<a name="line.176"></a>
<FONT color="green">177</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the user OS from the request argument from &lt;code&gt;Mac&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.177"></a>
<FONT color="green">178</FONT>         *<a name="line.178"></a>
<FONT color="green">179</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.179"></a>
<FONT color="green">180</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the user agent from the request argument is from &lt;code&gt;Mac&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt; otherwise<a name="line.180"></a>
<FONT color="green">181</FONT>         */<a name="line.181"></a>
<FONT color="green">182</FONT>        public static boolean isUserOSMac(WORequest request)<a name="line.182"></a>
<FONT color="green">183</FONT>        {<a name="line.183"></a>
<FONT color="green">184</FONT>            /** require [valid_param] request != null; **/<a name="line.184"></a>
<FONT color="green">185</FONT>    <a name="line.185"></a>
<FONT color="green">186</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.186"></a>
<FONT color="green">187</FONT>            return (userAgent.indexOf(RequestUtilities.macOSIdentifierString) != -1);<a name="line.187"></a>
<FONT color="green">188</FONT>        }<a name="line.188"></a>
<FONT color="green">189</FONT>    <a name="line.189"></a>
<FONT color="green">190</FONT>    <a name="line.190"></a>
<FONT color="green">191</FONT>    <a name="line.191"></a>
<FONT color="green">192</FONT>       /**<a name="line.192"></a>
<FONT color="green">193</FONT>         * Returns the human readable user agent name that corresponds to the &lt;code&gt;userAgentName&lt;code&gt; argument from this framework's &lt;code&gt;CustomInfo.plist&lt;/code&gt;<a name="line.193"></a>
<FONT color="green">194</FONT>         *<a name="line.194"></a>
<FONT color="green">195</FONT>         * @param userAgentName the key to look for<a name="line.195"></a>
<FONT color="green">196</FONT>         * @return the human readable user agent name that corresponds to the &lt;code&gt;userAgentName&lt;code&gt; argument from this framework's &lt;code&gt;CustomInfo.plist&lt;/code&gt;<a name="line.196"></a>
<FONT color="green">197</FONT>         */<a name="line.197"></a>
<FONT color="green">198</FONT>        public static String humanReadableUserAgentNameFor(String userAgentName)<a name="line.198"></a>
<FONT color="green">199</FONT>        {<a name="line.199"></a>
<FONT color="green">200</FONT>            /** require<a name="line.200"></a>
<FONT color="green">201</FONT>            [valid_param] userAgentName != null;<a name="line.201"></a>
<FONT color="green">202</FONT>            [default_value_exists] DefaultValueRetrieval.defaultValueExists(net.global_village.foundation.ClassAdditions.unsafeClassForName("net.global_village.woextensions.RequestUtilities"), userAgentNameKeyPathPrefix + userAgentName); **/<a name="line.202"></a>
<FONT color="green">203</FONT>    <a name="line.203"></a>
<FONT color="green">204</FONT>            return DefaultValueRetrieval.defaultString(RequestUtilities.class, userAgentNameKeyPathPrefix + userAgentName);<a name="line.204"></a>
<FONT color="green">205</FONT>        }<a name="line.205"></a>
<FONT color="green">206</FONT>    <a name="line.206"></a>
<FONT color="green">207</FONT>    <a name="line.207"></a>
<FONT color="green">208</FONT>    <a name="line.208"></a>
<FONT color="green">209</FONT>        /**<a name="line.209"></a>
<FONT color="green">210</FONT>         * Returns the human readable user OS name that corresponds to the &lt;code&gt;userOSName&lt;code&gt; argument from this framework's &lt;code&gt;CustomInfo.plist&lt;/code&gt;<a name="line.210"></a>
<FONT color="green">211</FONT>         *<a name="line.211"></a>
<FONT color="green">212</FONT>         * @param userOSName the key to look for<a name="line.212"></a>
<FONT color="green">213</FONT>         * @return the human readable OS name that corresponds to the &lt;code&gt;userOSName&lt;code&gt; argument from this framework's &lt;code&gt;CustomInfo.plist&lt;/code&gt;<a name="line.213"></a>
<FONT color="green">214</FONT>         */<a name="line.214"></a>
<FONT color="green">215</FONT>        public static String humanReadableUserOSNameFor(String userOSName)<a name="line.215"></a>
<FONT color="green">216</FONT>        {<a name="line.216"></a>
<FONT color="green">217</FONT>            /** require<a name="line.217"></a>
<FONT color="green">218</FONT>            [valid_param] userOSName != null;<a name="line.218"></a>
<FONT color="green">219</FONT>            [default_value_exists] DefaultValueRetrieval.defaultValueExists(net.global_village.foundation.ClassAdditions.unsafeClassForName("net.global_village.woextensions.RequestUtilities"), userOSKeyPathPrefix + userOSName); **/<a name="line.219"></a>
<FONT color="green">220</FONT>    <a name="line.220"></a>
<FONT color="green">221</FONT>            return DefaultValueRetrieval.defaultString(RequestUtilities.class, userOSKeyPathPrefix + userOSName);<a name="line.221"></a>
<FONT color="green">222</FONT>        }<a name="line.222"></a>
<FONT color="green">223</FONT>    <a name="line.223"></a>
<FONT color="green">224</FONT>    <a name="line.224"></a>
<FONT color="green">225</FONT>    <a name="line.225"></a>
<FONT color="green">226</FONT>    <a name="line.226"></a>
<FONT color="green">227</FONT>    <a name="line.227"></a>
<FONT color="green">228</FONT>        /**<a name="line.228"></a>
<FONT color="green">229</FONT>         * Returns the user agent (browser) from the passed in request.  This is the full User Agent (in all lower case).  userAgentNameFromRequest() returns a simplified and more readable version of the User Agent.<a name="line.229"></a>
<FONT color="green">230</FONT>         *<a name="line.230"></a>
<FONT color="green">231</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.231"></a>
<FONT color="green">232</FONT>         * @return user agent/browser name in original form.<a name="line.232"></a>
<FONT color="green">233</FONT>         */<a name="line.233"></a>
<FONT color="green">234</FONT>        public static String userAgentFromRequest(WORequest request)<a name="line.234"></a>
<FONT color="green">235</FONT>        {<a name="line.235"></a>
<FONT color="green">236</FONT>            /** require [valid_param] request != null; **/<a name="line.236"></a>
<FONT color="green">237</FONT>    <a name="line.237"></a>
<FONT color="green">238</FONT>            String userAgent  = request.headerForKey(RequestUtilities.userAgentKey);<a name="line.238"></a>
<FONT color="green">239</FONT>    <a name="line.239"></a>
<FONT color="green">240</FONT>            if (userAgent == null)<a name="line.240"></a>
<FONT color="green">241</FONT>            {<a name="line.241"></a>
<FONT color="green">242</FONT>                userAgent = RequestUtilities.defaultKey;<a name="line.242"></a>
<FONT color="green">243</FONT>            }<a name="line.243"></a>
<FONT color="green">244</FONT>            else<a name="line.244"></a>
<FONT color="green">245</FONT>            {<a name="line.245"></a>
<FONT color="green">246</FONT>                userAgent = userAgent.toLowerCase();<a name="line.246"></a>
<FONT color="green">247</FONT>            }<a name="line.247"></a>
<FONT color="green">248</FONT>    <a name="line.248"></a>
<FONT color="green">249</FONT>            return userAgent;<a name="line.249"></a>
<FONT color="green">250</FONT>    <a name="line.250"></a>
<FONT color="green">251</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.251"></a>
<FONT color="green">252</FONT>        }<a name="line.252"></a>
<FONT color="green">253</FONT>    <a name="line.253"></a>
<FONT color="green">254</FONT>    <a name="line.254"></a>
<FONT color="green">255</FONT>    <a name="line.255"></a>
<FONT color="green">256</FONT>        /**<a name="line.256"></a>
<FONT color="green">257</FONT>         * Returns the user agent (browser) from the passed in request.  The returned value is retrieved from the &lt;code&gt;CustomInfo.plist&lt;/code&gt; to be more human readable than what is contained in the HTTP request.<a name="line.257"></a>
<FONT color="green">258</FONT>         *<a name="line.258"></a>
<FONT color="green">259</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.259"></a>
<FONT color="green">260</FONT>         * @return user agent/browser name.<a name="line.260"></a>
<FONT color="green">261</FONT>         */<a name="line.261"></a>
<FONT color="green">262</FONT>        public static String userAgentNameFromRequest(WORequest request)<a name="line.262"></a>
<FONT color="green">263</FONT>        {<a name="line.263"></a>
<FONT color="green">264</FONT>            /** require [valid_param] request != null; **/<a name="line.264"></a>
<FONT color="green">265</FONT>    <a name="line.265"></a>
<FONT color="green">266</FONT>            String userAgentName;<a name="line.266"></a>
<FONT color="green">267</FONT>    <a name="line.267"></a>
<FONT color="green">268</FONT>            if (RequestUtilities.isUserAgentOpera(request))<a name="line.268"></a>
<FONT color="green">269</FONT>            {<a name="line.269"></a>
<FONT color="green">270</FONT>                userAgentName = RequestUtilities.humanReadableUserAgentNameFor(RequestUtilities.operaUserAgent);<a name="line.270"></a>
<FONT color="green">271</FONT>            }<a name="line.271"></a>
<FONT color="green">272</FONT>            else if (RequestUtilities.isUserAgentSafari(request))<a name="line.272"></a>
<FONT color="green">273</FONT>            {<a name="line.273"></a>
<FONT color="green">274</FONT>                userAgentName = RequestUtilities.humanReadableUserAgentNameFor(RequestUtilities.safariUserAgent);<a name="line.274"></a>
<FONT color="green">275</FONT>            }<a name="line.275"></a>
<FONT color="green">276</FONT>            else if (RequestUtilities.isUserAgentFirefox(request))<a name="line.276"></a>
<FONT color="green">277</FONT>            {<a name="line.277"></a>
<FONT color="green">278</FONT>                userAgentName = RequestUtilities.humanReadableUserAgentNameFor(RequestUtilities.firefoxUserAgent);<a name="line.278"></a>
<FONT color="green">279</FONT>            }<a name="line.279"></a>
<FONT color="green">280</FONT>            else if (RequestUtilities.isUserAgentInternetExplorer(request))<a name="line.280"></a>
<FONT color="green">281</FONT>            {<a name="line.281"></a>
<FONT color="green">282</FONT>                userAgentName = RequestUtilities.humanReadableUserAgentNameFor(RequestUtilities.ieUserAgent);<a name="line.282"></a>
<FONT color="green">283</FONT>            }<a name="line.283"></a>
<FONT color="green">284</FONT>            else if (RequestUtilities.isUserAgentMozillaCompatible(request))<a name="line.284"></a>
<FONT color="green">285</FONT>            {<a name="line.285"></a>
<FONT color="green">286</FONT>                // This is a mozilla based browser that is neither ie nor Opera so we're assuming it is Netscape<a name="line.286"></a>
<FONT color="green">287</FONT>                userAgentName = RequestUtilities.humanReadableUserAgentNameFor(RequestUtilities.mozillaUserAgent);<a name="line.287"></a>
<FONT color="green">288</FONT>            }<a name="line.288"></a>
<FONT color="green">289</FONT>            else // Not IE nor Opera nor even based on Mozilla (Netscape) so return default<a name="line.289"></a>
<FONT color="green">290</FONT>            {<a name="line.290"></a>
<FONT color="green">291</FONT>                userAgentName = RequestUtilities.humanReadableUserAgentNameFor(RequestUtilities.defaultKey);<a name="line.291"></a>
<FONT color="green">292</FONT>            }<a name="line.292"></a>
<FONT color="green">293</FONT>    <a name="line.293"></a>
<FONT color="green">294</FONT>            return userAgentName;<a name="line.294"></a>
<FONT color="green">295</FONT>    <a name="line.295"></a>
<FONT color="green">296</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.296"></a>
<FONT color="green">297</FONT>        }<a name="line.297"></a>
<FONT color="green">298</FONT>    <a name="line.298"></a>
<FONT color="green">299</FONT>    <a name="line.299"></a>
<FONT color="green">300</FONT>    <a name="line.300"></a>
<FONT color="green">301</FONT>        /**<a name="line.301"></a>
<FONT color="green">302</FONT>         * Returns the user OS from the passed in request.  Currently we only recognize Macintosh and Widows lumping all other OS'es into the default category.  The returned value is retrieved from the &lt;code&gt;CustomInfo.plist&lt;/code&gt; to be more human readable than what is contained in the HTTP request.<a name="line.302"></a>
<FONT color="green">303</FONT>         *<a name="line.303"></a>
<FONT color="green">304</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.304"></a>
<FONT color="green">305</FONT>         * @return OS name.<a name="line.305"></a>
<FONT color="green">306</FONT>         */<a name="line.306"></a>
<FONT color="green">307</FONT>        public static String userOSFromRequest(WORequest request)<a name="line.307"></a>
<FONT color="green">308</FONT>        {<a name="line.308"></a>
<FONT color="green">309</FONT>            /** require [valid_param] request != null; **/<a name="line.309"></a>
<FONT color="green">310</FONT>    <a name="line.310"></a>
<FONT color="green">311</FONT>            String userOS;<a name="line.311"></a>
<FONT color="green">312</FONT>    <a name="line.312"></a>
<FONT color="green">313</FONT>            if (RequestUtilities.isUserOSWindows(request))<a name="line.313"></a>
<FONT color="green">314</FONT>            {<a name="line.314"></a>
<FONT color="green">315</FONT>                userOS = RequestUtilities.humanReadableUserOSNameFor(RequestUtilities.windowsIdentifierString);<a name="line.315"></a>
<FONT color="green">316</FONT>            }<a name="line.316"></a>
<FONT color="green">317</FONT>            else if (RequestUtilities.isUserOSMac(request))<a name="line.317"></a>
<FONT color="green">318</FONT>            {<a name="line.318"></a>
<FONT color="green">319</FONT>                userOS = RequestUtilities.humanReadableUserOSNameFor(RequestUtilities.macOSIdentifierString);<a name="line.319"></a>
<FONT color="green">320</FONT>            }<a name="line.320"></a>
<FONT color="green">321</FONT>            else // Use the default value<a name="line.321"></a>
<FONT color="green">322</FONT>            {<a name="line.322"></a>
<FONT color="green">323</FONT>                userOS = RequestUtilities.humanReadableUserOSNameFor(RequestUtilities.defaultKey);<a name="line.323"></a>
<FONT color="green">324</FONT>            }<a name="line.324"></a>
<FONT color="green">325</FONT>    <a name="line.325"></a>
<FONT color="green">326</FONT>            return userOS;<a name="line.326"></a>
<FONT color="green">327</FONT>    <a name="line.327"></a>
<FONT color="green">328</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.328"></a>
<FONT color="green">329</FONT>        }<a name="line.329"></a>
<FONT color="green">330</FONT>    <a name="line.330"></a>
<FONT color="green">331</FONT>    <a name="line.331"></a>
<FONT color="green">332</FONT>    <a name="line.332"></a>
<FONT color="green">333</FONT>        /**<a name="line.333"></a>
<FONT color="green">334</FONT>         * Returns the user agent version number (browser version number) from the passed in request.  The major version number is the number(s) before the decimal point.  (Currently it will not handle greater then single digit version numbers correctly)  Although RFC 1945 specifies a standard it proved necessary to have slightly different code for each browser.  Currently we determine if the userAgent is IE, Netscape, Opera, or other then return a version number as appropriate. &lt;code&gt;null&lt;/code&gt; is a valid version number.  If more exact versions are required another method will be written which this method could then be modified to call removing all numbers after the decimal point.<a name="line.334"></a>
<FONT color="green">335</FONT>         *<a name="line.335"></a>
<FONT color="green">336</FONT>         * @param request the &lt;code&gt;WORequest&lt;/code&gt; where the result will be taken from<a name="line.336"></a>
<FONT color="green">337</FONT>         * @return user agent/browser major version.<a name="line.337"></a>
<FONT color="green">338</FONT>         */<a name="line.338"></a>
<FONT color="green">339</FONT>        public static String userAgentMajorVersionNumberFromRequest(WORequest request)<a name="line.339"></a>
<FONT color="green">340</FONT>        {<a name="line.340"></a>
<FONT color="green">341</FONT>            /** require [valid_param] request != null; **/<a name="line.341"></a>
<FONT color="green">342</FONT>    <a name="line.342"></a>
<FONT color="green">343</FONT>            String majorVersionNumber = null;<a name="line.343"></a>
<FONT color="green">344</FONT>            char possibleVersionNumber = 'a';  // needs default non digit value<a name="line.344"></a>
<FONT color="green">345</FONT>            String userAgent = RequestUtilities.userAgentFromRequest(request);<a name="line.345"></a>
<FONT color="green">346</FONT>    <a name="line.346"></a>
<FONT color="green">347</FONT>            try<a name="line.347"></a>
<FONT color="green">348</FONT>            {<a name="line.348"></a>
<FONT color="green">349</FONT>                if (RequestUtilities.isUserAgentOpera(request))<a name="line.349"></a>
<FONT color="green">350</FONT>                {<a name="line.350"></a>
<FONT color="green">351</FONT>                    int index = userAgent.indexOf(operaUserAgent);<a name="line.351"></a>
<FONT color="green">352</FONT>                    possibleVersionNumber = userAgent.charAt( index + operaUserAgent.length() + 1);<a name="line.352"></a>
<FONT color="green">353</FONT>                }<a name="line.353"></a>
<FONT color="green">354</FONT>                else if (RequestUtilities.isUserAgentInternetExplorer(request))<a name="line.354"></a>
<FONT color="green">355</FONT>                {<a name="line.355"></a>
<FONT color="green">356</FONT>                    int index = userAgent.indexOf(ieUserAgent);<a name="line.356"></a>
<FONT color="green">357</FONT>    <a name="line.357"></a>
<FONT color="green">358</FONT>                    // version number is after ieUserAgent and a space.<a name="line.358"></a>
<FONT color="green">359</FONT>                    possibleVersionNumber = userAgent.charAt( index + RequestUtilities.ieUserAgent.length() + 1);<a name="line.359"></a>
<FONT color="green">360</FONT>                }<a name="line.360"></a>
<FONT color="green">361</FONT>                else if (RequestUtilities.isUserAgentMozillaCompatible(request))<a name="line.361"></a>
<FONT color="green">362</FONT>                {<a name="line.362"></a>
<FONT color="green">363</FONT>                    // This user-agent includes the phrase "mozilla" and is neither opera nor ie.<a name="line.363"></a>
<FONT color="green">364</FONT>                    int index = userAgent.indexOf(netscapeVersionString);<a name="line.364"></a>
<FONT color="green">365</FONT>                    int userAgentLength = userAgent.length();<a name="line.365"></a>
<FONT color="green">366</FONT>    <a name="line.366"></a>
<FONT color="green">367</FONT>                    if (index != -1)<a name="line.367"></a>
<FONT color="green">368</FONT>                    {<a name="line.368"></a>
<FONT color="green">369</FONT>                        if (RequestUtilities.isUserAgentUsingGecko(request))<a name="line.369"></a>
<FONT color="green">370</FONT>                        {<a name="line.370"></a>
<FONT color="green">371</FONT>                            // Gecko based Netscape so major version number should be six plus<a name="line.371"></a>
<FONT color="green">372</FONT>                            if (userAgentLength &gt; ( index + netscapeVersionString.length() + 1))<a name="line.372"></a>
<FONT color="green">373</FONT>                            {<a name="line.373"></a>
<FONT color="green">374</FONT>                                possibleVersionNumber = userAgent.charAt( index + netscapeVersionString.length() + 1);<a name="line.374"></a>
<FONT color="green">375</FONT>                            }<a name="line.375"></a>
<FONT color="green">376</FONT>                        }<a name="line.376"></a>
<FONT color="green">377</FONT>                        else<a name="line.377"></a>
<FONT color="green">378</FONT>                        {<a name="line.378"></a>
<FONT color="green">379</FONT>                            // original Netscape detection logic 1-4.7<a name="line.379"></a>
<FONT color="green">380</FONT>                            if (userAgentLength &gt; ( index + netscapeVersionString.length()))<a name="line.380"></a>
<FONT color="green">381</FONT>                            {<a name="line.381"></a>
<FONT color="green">382</FONT>                                possibleVersionNumber = userAgent.charAt( index + netscapeVersionString.length());<a name="line.382"></a>
<FONT color="green">383</FONT>                            }<a name="line.383"></a>
<FONT color="green">384</FONT>                        }<a name="line.384"></a>
<FONT color="green">385</FONT>                    }<a name="line.385"></a>
<FONT color="green">386</FONT>                    else<a name="line.386"></a>
<FONT color="green">387</FONT>                    {<a name="line.387"></a>
<FONT color="green">388</FONT>                        // special case for Netscape 4.8<a name="line.388"></a>
<FONT color="green">389</FONT>                        // this also is true for any mozilla compatiable browsers which do not have "netscape" in it's user-agent<a name="line.389"></a>
<FONT color="green">390</FONT>                        // recalculate index based on mozilla user-agent and return mozilla version number<a name="line.390"></a>
<FONT color="green">391</FONT>                        index = userAgent.indexOf(mozillaUserAgent);<a name="line.391"></a>
<FONT color="green">392</FONT>                        if (userAgentLength &gt; ( index + mozillaUserAgent.length() + 1))<a name="line.392"></a>
<FONT color="green">393</FONT>                        {<a name="line.393"></a>
<FONT color="green">394</FONT>                            possibleVersionNumber = userAgent.charAt( index + mozillaUserAgent.length() + 1);<a name="line.394"></a>
<FONT color="green">395</FONT>                        }<a name="line.395"></a>
<FONT color="green">396</FONT>                    }<a name="line.396"></a>
<FONT color="green">397</FONT>                }<a name="line.397"></a>
<FONT color="green">398</FONT>            }<a name="line.398"></a>
<FONT color="green">399</FONT>            // Non-standard user agent names like "MSIE" may cause an exception<a name="line.399"></a>
<FONT color="green">400</FONT>            catch (RuntimeException e)<a name="line.400"></a>
<FONT color="green">401</FONT>            {<a name="line.401"></a>
<FONT color="green">402</FONT>                NSLog.err.appendln("Could not get major version from " + userAgent);<a name="line.402"></a>
<FONT color="green">403</FONT>                NSLog.err.appendln(e);<a name="line.403"></a>
<FONT color="green">404</FONT>            }<a name="line.404"></a>
<FONT color="green">405</FONT>    <a name="line.405"></a>
<FONT color="green">406</FONT>            // now check that we've found a valid possible version number<a name="line.406"></a>
<FONT color="green">407</FONT>            if (Character.isDigit(possibleVersionNumber))<a name="line.407"></a>
<FONT color="green">408</FONT>            {<a name="line.408"></a>
<FONT color="green">409</FONT>                Character versionNumber = new Character(possibleVersionNumber);<a name="line.409"></a>
<FONT color="green">410</FONT>                majorVersionNumber = versionNumber.toString();<a name="line.410"></a>
<FONT color="green">411</FONT>            }<a name="line.411"></a>
<FONT color="green">412</FONT>    <a name="line.412"></a>
<FONT color="green">413</FONT>            return majorVersionNumber;<a name="line.413"></a>
<FONT color="green">414</FONT>        }<a name="line.414"></a>
<FONT color="green">415</FONT>    <a name="line.415"></a>
<FONT color="green">416</FONT>    <a name="line.416"></a>
<FONT color="green">417</FONT>    <a name="line.417"></a>
<FONT color="green">418</FONT>        /**<a name="line.418"></a>
<FONT color="green">419</FONT>         * Returns &lt;code&gt;true&lt;/code&gt; if the request was made via https/SSL, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.419"></a>
<FONT color="green">420</FONT>         *<a name="line.420"></a>
<FONT color="green">421</FONT>         * @param request the WORequest to check for HTTPS state<a name="line.421"></a>
<FONT color="green">422</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if the request was made via https/SSL, &lt;code&gt;false&lt;/code&gt; otherwise.<a name="line.422"></a>
<FONT color="green">423</FONT>         */<a name="line.423"></a>
<FONT color="green">424</FONT>        static public boolean isHTTPSRequest(WORequest request)<a name="line.424"></a>
<FONT color="green">425</FONT>        {<a name="line.425"></a>
<FONT color="green">426</FONT>            boolean isHTTPSRequest = false;<a name="line.426"></a>
<FONT color="green">427</FONT>    <a name="line.427"></a>
<FONT color="green">428</FONT>            // Depending on the adaptor the incoming port can be found in one of two places.<a name="line.428"></a>
<FONT color="green">429</FONT>            String serverPort = request.headerForKey("SERVER_PORT");<a name="line.429"></a>
<FONT color="green">430</FONT>            if (serverPort == null)<a name="line.430"></a>
<FONT color="green">431</FONT>            {<a name="line.431"></a>
<FONT color="green">432</FONT>                serverPort = request.headerForKey("x-webobjects-server-port");<a name="line.432"></a>
<FONT color="green">433</FONT>            }<a name="line.433"></a>
<FONT color="green">434</FONT>    <a name="line.434"></a>
<FONT color="green">435</FONT>            // Apache and some other web servers use this to indicate HTTPS mode.<a name="line.435"></a>
<FONT color="green">436</FONT>            String httpsMode = request.headerForKey("https");<a name="line.436"></a>
<FONT color="green">437</FONT>    <a name="line.437"></a>
<FONT color="green">438</FONT>            // If either the https header is 'on' or the server port is 443 then we consider this to be an HTTP request.<a name="line.438"></a>
<FONT color="green">439</FONT>            isHTTPSRequest = ( ((httpsMode != null) &amp;&amp; httpsMode.equalsIgnoreCase("on")) ||<a name="line.439"></a>
<FONT color="green">440</FONT>                               ((serverPort != null) &amp;&amp; serverPort.equals("443")) );<a name="line.440"></a>
<FONT color="green">441</FONT>    <a name="line.441"></a>
<FONT color="green">442</FONT>            return isHTTPSRequest;<a name="line.442"></a>
<FONT color="green">443</FONT>        }<a name="line.443"></a>
<FONT color="green">444</FONT>    <a name="line.444"></a>
<FONT color="green">445</FONT>    <a name="line.445"></a>
<FONT color="green">446</FONT>    <a name="line.446"></a>
<FONT color="green">447</FONT>        /**<a name="line.447"></a>
<FONT color="green">448</FONT>         * Returns the host name (the domain name) used in this request.  This may not match the one specified in the cgiAdaptorURL if there are aliases for the web server.<a name="line.448"></a>
<FONT color="green">449</FONT>         *<a name="line.449"></a>
<FONT color="green">450</FONT>         * @param request the request to get the hostname from<a name="line.450"></a>
<FONT color="green">451</FONT>         * @return the host name (the domain name) used in this request.<a name="line.451"></a>
<FONT color="green">452</FONT>         */<a name="line.452"></a>
<FONT color="green">453</FONT>        static public String hostNameFromRequest(WORequest request)<a name="line.453"></a>
<FONT color="green">454</FONT>        {<a name="line.454"></a>
<FONT color="green">455</FONT>            /** require [valid_param] request != null; **/<a name="line.455"></a>
<FONT color="green">456</FONT>    <a name="line.456"></a>
<FONT color="green">457</FONT>            // First try the WebObjects one<a name="line.457"></a>
<FONT color="green">458</FONT>            String hostName = request.headerForKey("x-webobjects-server-name");<a name="line.458"></a>
<FONT color="green">459</FONT>    <a name="line.459"></a>
<FONT color="green">460</FONT>            // If that is not there, try the standard one used by the cgi-bin adaptor.<a name="line.460"></a>
<FONT color="green">461</FONT>            if (hostName == null)<a name="line.461"></a>
<FONT color="green">462</FONT>            {<a name="line.462"></a>
<FONT color="green">463</FONT>                hostName = request.headerForKey("Host");<a name="line.463"></a>
<FONT color="green">464</FONT>            }<a name="line.464"></a>
<FONT color="green">465</FONT>    <a name="line.465"></a>
<FONT color="green">466</FONT>            // If that is not there, try the one used by the mod_webobjects adaptor<a name="line.466"></a>
<FONT color="green">467</FONT>            if (hostName == null)<a name="line.467"></a>
<FONT color="green">468</FONT>            {<a name="line.468"></a>
<FONT color="green">469</FONT>                hostName = request.headerForKey("http_host");<a name="line.469"></a>
<FONT color="green">470</FONT>            }<a name="line.470"></a>
<FONT color="green">471</FONT>    <a name="line.471"></a>
<FONT color="green">472</FONT>            // Add more options here (e.g. for IIS, NSAPI, etc.), if neccessary...<a name="line.472"></a>
<FONT color="green">473</FONT>    <a name="line.473"></a>
<FONT color="green">474</FONT>            return hostName;<a name="line.474"></a>
<FONT color="green">475</FONT>    <a name="line.475"></a>
<FONT color="green">476</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.476"></a>
<FONT color="green">477</FONT>         }<a name="line.477"></a>
<FONT color="green">478</FONT>    <a name="line.478"></a>
<FONT color="green">479</FONT>    <a name="line.479"></a>
<FONT color="green">480</FONT>    <a name="line.480"></a>
<FONT color="green">481</FONT>        /**<a name="line.481"></a>
<FONT color="green">482</FONT>         * Returns the original (i.e. unaltered by rewrite rules etc.) URL sent to the webserver that<a name="line.482"></a>
<FONT color="green">483</FONT>         * triggered this request.  This is useful when redirecting, for example to the login page and<a name="line.483"></a>
<FONT color="green">484</FONT>         * back.  Form values are included.  The scheme and domain name are not included.<a name="line.484"></a>
<FONT color="green">485</FONT>         *<a name="line.485"></a>
<FONT color="green">486</FONT>         * @param request WORequest to take form values from<a name="line.486"></a>
<FONT color="green">487</FONT>         * @return the original (i.e. unaltered by rewrite rules etc.) URL sent to the webserver that<a name="line.487"></a>
<FONT color="green">488</FONT>         * triggered this request<a name="line.488"></a>
<FONT color="green">489</FONT>         */<a name="line.489"></a>
<FONT color="green">490</FONT>        public static String originalURLFromRequest(WORequest request)<a name="line.490"></a>
<FONT color="green">491</FONT>        {<a name="line.491"></a>
<FONT color="green">492</FONT>            /** require [request_not_null] request != null; **/<a name="line.492"></a>
<FONT color="green">493</FONT>    <a name="line.493"></a>
<FONT color="green">494</FONT>            // Note: this method keeps breaking.  It seems that different versions of Apache do different<a name="line.494"></a>
<FONT color="green">495</FONT>            // things.  Some do not send script_url, others send it with the form values stripped off,<a name="line.495"></a>
<FONT color="green">496</FONT>            // others send it intact.  Some versions have the form values on the end of request_uri,<a name="line.496"></a>
<FONT color="green">497</FONT>            // others do not.  WTF?!!?<a name="line.497"></a>
<FONT color="green">498</FONT>            String originalURLFromRequest = request.headerForKey("request_uri");<a name="line.498"></a>
<FONT color="green">499</FONT>    <a name="line.499"></a>
<FONT color="green">500</FONT>            if (originalURLFromRequest == null)<a name="line.500"></a>
<FONT color="green">501</FONT>            {<a name="line.501"></a>
<FONT color="green">502</FONT>                // In WO 5.2.2 some requests result in null formValues().  Handle this to avoid exceptions<a name="line.502"></a>
<FONT color="green">503</FONT>                boolean hasFormValues = (request.formValues() != null) &amp;&amp; (request.formValues().count() &gt; 0);<a name="line.503"></a>
<FONT color="green">504</FONT>    <a name="line.504"></a>
<FONT color="green">505</FONT>                originalURLFromRequest = request.headerForKey("script_url");<a name="line.505"></a>
<FONT color="green">506</FONT>    <a name="line.506"></a>
<FONT color="green">507</FONT>                if (originalURLFromRequest == null)<a name="line.507"></a>
<FONT color="green">508</FONT>                {<a name="line.508"></a>
<FONT color="green">509</FONT>                    throw new RuntimeException("Can't determine original URL from request headers.  Is mod_rewrite properly configured?");<a name="line.509"></a>
<FONT color="green">510</FONT>                }<a name="line.510"></a>
<FONT color="green">511</FONT>    <a name="line.511"></a>
<FONT color="green">512</FONT>                // Last gasp hammer to kill a fly attempt to ensure that form values get passed.<a name="line.512"></a>
<FONT color="green">513</FONT>                if ((originalURLFromRequest.indexOf("?") == -1) &amp;&amp; hasFormValues)<a name="line.513"></a>
<FONT color="green">514</FONT>                {<a name="line.514"></a>
<FONT color="green">515</FONT>                    NSMutableDictionary cleanedFormValues = new NSMutableDictionary(request.formValues());<a name="line.515"></a>
<FONT color="green">516</FONT>                    cleanedFormValues.removeObjectsForKeys(NSArray.EmptyArray);  // Future expansion<a name="line.516"></a>
<FONT color="green">517</FONT>    <a name="line.517"></a>
<FONT color="green">518</FONT>                    if (cleanedFormValues.count() &gt; 0)<a name="line.518"></a>
<FONT color="green">519</FONT>                    {<a name="line.519"></a>
<FONT color="green">520</FONT>                        originalURLFromRequest += "?" + NSDictionaryAdditions.urlEncodedDictionary(cleanedFormValues);<a name="line.520"></a>
<FONT color="green">521</FONT>                    }<a name="line.521"></a>
<FONT color="green">522</FONT>                }<a name="line.522"></a>
<FONT color="green">523</FONT>            }<a name="line.523"></a>
<FONT color="green">524</FONT>    <a name="line.524"></a>
<FONT color="green">525</FONT>            return originalURLFromRequest;<a name="line.525"></a>
<FONT color="green">526</FONT>    <a name="line.526"></a>
<FONT color="green">527</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.527"></a>
<FONT color="green">528</FONT>        }<a name="line.528"></a>
<FONT color="green">529</FONT>    <a name="line.529"></a>
<FONT color="green">530</FONT>    <a name="line.530"></a>
<FONT color="green">531</FONT>    <a name="line.531"></a>
<FONT color="green">532</FONT>        /**<a name="line.532"></a>
<FONT color="green">533</FONT>         * Returns a URL encoded version of the form values from this request.  The form values are first<a name="line.533"></a>
<FONT color="green">534</FONT>         * translated into the form key1=value1&amp;key2=value2 etc, and then this is url encoded into<a name="line.534"></a>
<FONT color="green">535</FONT>         * x-www-form-urlencoded format.  This is intended to be used when the form values are to be<a name="line.535"></a>
<FONT color="green">536</FONT>         * passed as a form value themself (i.e. when using a URL with form values as a form value).<a name="line.536"></a>
<FONT color="green">537</FONT>         * See java.net.URLEncoder for more information.<a name="line.537"></a>
<FONT color="green">538</FONT>         *<a name="line.538"></a>
<FONT color="green">539</FONT>         *<a name="line.539"></a>
<FONT color="green">540</FONT>         * @param request WORequest to take form values from<a name="line.540"></a>
<FONT color="green">541</FONT>         * @return URL encoded version of the form values from this request<a name="line.541"></a>
<FONT color="green">542</FONT>         */<a name="line.542"></a>
<FONT color="green">543</FONT>        static public String urlEncodedFormValues(WORequest request)<a name="line.543"></a>
<FONT color="green">544</FONT>        {<a name="line.544"></a>
<FONT color="green">545</FONT>            /** require [request_not_null] request != null; **/<a name="line.545"></a>
<FONT color="green">546</FONT>    <a name="line.546"></a>
<FONT color="green">547</FONT>            StringBuffer formValues = new StringBuffer(1024);<a name="line.547"></a>
<FONT color="green">548</FONT>            Enumeration keyEnumerator = request.formValueKeys().objectEnumerator();<a name="line.548"></a>
<FONT color="green">549</FONT>            while (keyEnumerator.hasMoreElements())<a name="line.549"></a>
<FONT color="green">550</FONT>            {<a name="line.550"></a>
<FONT color="green">551</FONT>                // Add on the connector if this is not the first form value.<a name="line.551"></a>
<FONT color="green">552</FONT>                if (formValues.length() != 0)<a name="line.552"></a>
<FONT color="green">553</FONT>                {<a name="line.553"></a>
<FONT color="green">554</FONT>                    formValues.append("&amp;");<a name="line.554"></a>
<FONT color="green">555</FONT>                }<a name="line.555"></a>
<FONT color="green">556</FONT>    <a name="line.556"></a>
<FONT color="green">557</FONT>                String aKey = (String)keyEnumerator.nextElement();<a name="line.557"></a>
<FONT color="green">558</FONT>                Object anObject = request.formValuesForKey(aKey).objectAtIndex(0);  // Fails for multiple values<a name="line.558"></a>
<FONT color="green">559</FONT>    <a name="line.559"></a>
<FONT color="green">560</FONT>                formValues.append(aKey);<a name="line.560"></a>
<FONT color="green">561</FONT>                formValues.append("=");<a name="line.561"></a>
<FONT color="green">562</FONT>                formValues.append(anObject.toString());<a name="line.562"></a>
<FONT color="green">563</FONT>            }<a name="line.563"></a>
<FONT color="green">564</FONT>    <a name="line.564"></a>
<FONT color="green">565</FONT>            return WOURLEncoder.encode(formValues.toString(), "UTF-8");<a name="line.565"></a>
<FONT color="green">566</FONT>    <a name="line.566"></a>
<FONT color="green">567</FONT>            /** ensure [result_not_null] Result != null; **/<a name="line.567"></a>
<FONT color="green">568</FONT>        }<a name="line.568"></a>
<FONT color="green">569</FONT>    <a name="line.569"></a>
<FONT color="green">570</FONT>    <a name="line.570"></a>
<FONT color="green">571</FONT>    <a name="line.571"></a>
<FONT color="green">572</FONT>        /**<a name="line.572"></a>
<FONT color="green">573</FONT>         * Returns the form value associated with the key after all trailing slashes and white space have been stripped off.<a name="line.573"></a>
<FONT color="green">574</FONT>         *<a name="line.574"></a>
<FONT color="green">575</FONT>         * @param aRequest WORequest to take form value from<a name="line.575"></a>
<FONT color="green">576</FONT>         * @param aKey key identifying form value<a name="line.576"></a>
<FONT color="green">577</FONT>         * @return the form value associated with the key after all trailing slashes and white space have been stripped off.<a name="line.577"></a>
<FONT color="green">578</FONT>         */<a name="line.578"></a>
<FONT color="green">579</FONT>        static public Object cleanedFormValueForKey(WORequest aRequest, String aKey)<a name="line.579"></a>
<FONT color="green">580</FONT>        {<a name="line.580"></a>
<FONT color="green">581</FONT>            /** require<a name="line.581"></a>
<FONT color="green">582</FONT>            [a_key_not_null] aKey != null;<a name="line.582"></a>
<FONT color="green">583</FONT>            [a_request_not_null] aRequest != null; **/<a name="line.583"></a>
<FONT color="green">584</FONT>    <a name="line.584"></a>
<FONT color="green">585</FONT>            Object formValue = aRequest.formValueForKey(aKey);<a name="line.585"></a>
<FONT color="green">586</FONT>    <a name="line.586"></a>
<FONT color="green">587</FONT>            if ((formValue != null) &amp;&amp; String.class.isInstance(formValue))<a name="line.587"></a>
<FONT color="green">588</FONT>            {<a name="line.588"></a>
<FONT color="green">589</FONT>                String stringValue = ((String) formValue).trim();<a name="line.589"></a>
<FONT color="green">590</FONT>    <a name="line.590"></a>
<FONT color="green">591</FONT>                while (stringValue.endsWith("/"))<a name="line.591"></a>
<FONT color="green">592</FONT>                {<a name="line.592"></a>
<FONT color="green">593</FONT>                    stringValue = stringValue.substring(0, stringValue.length() - 1);<a name="line.593"></a>
<FONT color="green">594</FONT>                }<a name="line.594"></a>
<FONT color="green">595</FONT>                formValue = stringValue;<a name="line.595"></a>
<FONT color="green">596</FONT>            }<a name="line.596"></a>
<FONT color="green">597</FONT>    <a name="line.597"></a>
<FONT color="green">598</FONT>            return formValue;<a name="line.598"></a>
<FONT color="green">599</FONT>        }<a name="line.599"></a>
<FONT color="green">600</FONT>    <a name="line.600"></a>
<FONT color="green">601</FONT>    <a name="line.601"></a>
<FONT color="green">602</FONT>        /**<a name="line.602"></a>
<FONT color="green">603</FONT>         * Returns the browser languages from the accept-language header ordered, and translated into<a name="line.603"></a>
<FONT color="green">604</FONT>         * longer names.  See humanReadableNameForISOName for how this translation is done.<a name="line.604"></a>
<FONT color="green">605</FONT>         * Unlike the WORequest method of this name, country names are included.  This<a name="line.605"></a>
<FONT color="green">606</FONT>         * allows the basic localization to handle different dialects. The defaultLanguage() is included<a name="line.606"></a>
<FONT color="green">607</FONT>         * at the end if not specified in the request.  This ensures that the user at least seems something<a name="line.607"></a>
<FONT color="green">608</FONT>         * intelligible (assuming it is defined in the default language).<a name="line.608"></a>
<FONT color="green">609</FONT>         *<a name="line.609"></a>
<FONT color="green">610</FONT>         * @param request the request to get the accept-language header from<a name="line.610"></a>
<FONT color="green">611</FONT>         * @return browser languages from the accept-language header orderd, and translated into longer names<a name="line.611"></a>
<FONT color="green">612</FONT>         */<a name="line.612"></a>
<FONT color="green">613</FONT>        static public NSArray browserLanguages(WORequest request)<a name="line.613"></a>
<FONT color="green">614</FONT>        {<a name="line.614"></a>
<FONT color="green">615</FONT>            /** require [valid_param] request != null; **/<a name="line.615"></a>
<FONT color="green">616</FONT>    <a name="line.616"></a>
<FONT color="green">617</FONT>            NSArray orderedLanguages = orderedLanguagesFromHeader(rawBrowserLanguages(request));<a name="line.617"></a>
<FONT color="green">618</FONT>            NSMutableArray languages = new NSMutableArray(orderedLanguages.count());<a name="line.618"></a>
<FONT color="green">619</FONT>            for (int i = 0;  i &lt; orderedLanguages.count(); i++)<a name="line.619"></a>
<FONT color="green">620</FONT>            {<a name="line.620"></a>
<FONT color="green">621</FONT>                languages.addObject(humanReadableNameForISOName((String)orderedLanguages.objectAtIndex(i)));<a name="line.621"></a>
<FONT color="green">622</FONT>            }<a name="line.622"></a>
<FONT color="green">623</FONT>    <a name="line.623"></a>
<FONT color="green">624</FONT>            if ( ! languages.contains(defaultLanguage()))<a name="line.624"></a>
<FONT color="green">625</FONT>            {<a name="line.625"></a>
<FONT color="green">626</FONT>                languages.addObject(defaultLanguage());<a name="line.626"></a>
<FONT color="green">627</FONT>            }<a name="line.627"></a>
<FONT color="green">628</FONT>    <a name="line.628"></a>
<FONT color="green">629</FONT>            return languages;<a name="line.629"></a>
<FONT color="green">630</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.630"></a>
<FONT color="green">631</FONT>        }<a name="line.631"></a>
<FONT color="green">632</FONT>    <a name="line.632"></a>
<FONT color="green">633</FONT>    <a name="line.633"></a>
<FONT color="green">634</FONT>    <a name="line.634"></a>
<FONT color="green">635</FONT>        /**<a name="line.635"></a>
<FONT color="green">636</FONT>         * Returns the raw accept-language header sent in this request. If the header can't be found,<a name="line.636"></a>
<FONT color="green">637</FONT>         * returns defaultLanguageISOCode() as the default.<a name="line.637"></a>
<FONT color="green">638</FONT>         *<a name="line.638"></a>
<FONT color="green">639</FONT>         * @param request the request to get the accept-language header from<a name="line.639"></a>
<FONT color="green">640</FONT>         * @return the accept-language header sent in this request.<a name="line.640"></a>
<FONT color="green">641</FONT>         */<a name="line.641"></a>
<FONT color="green">642</FONT>        static public String rawBrowserLanguages(WORequest request)<a name="line.642"></a>
<FONT color="green">643</FONT>        {<a name="line.643"></a>
<FONT color="green">644</FONT>            /** require [valid_param] request != null; **/<a name="line.644"></a>
<FONT color="green">645</FONT>    <a name="line.645"></a>
<FONT color="green">646</FONT>            String header = request.headerForKey("accept-language");<a name="line.646"></a>
<FONT color="green">647</FONT>    <a name="line.647"></a>
<FONT color="green">648</FONT>            if (header == null)<a name="line.648"></a>
<FONT color="green">649</FONT>            {<a name="line.649"></a>
<FONT color="green">650</FONT>                header = request.headerForKey("Accept-Language");<a name="line.650"></a>
<FONT color="green">651</FONT>            }<a name="line.651"></a>
<FONT color="green">652</FONT>    <a name="line.652"></a>
<FONT color="green">653</FONT>            if (header == null)<a name="line.653"></a>
<FONT color="green">654</FONT>            {<a name="line.654"></a>
<FONT color="green">655</FONT>                header = request.headerForKey("HTTP_ACCEPT_LANGUAGE");<a name="line.655"></a>
<FONT color="green">656</FONT>            }<a name="line.656"></a>
<FONT color="green">657</FONT>    <a name="line.657"></a>
<FONT color="green">658</FONT>            if (header == null)<a name="line.658"></a>
<FONT color="green">659</FONT>            {<a name="line.659"></a>
<FONT color="green">660</FONT>                header = defaultLanguageISOCode();<a name="line.660"></a>
<FONT color="green">661</FONT>            }<a name="line.661"></a>
<FONT color="green">662</FONT>    <a name="line.662"></a>
<FONT color="green">663</FONT>            return header;<a name="line.663"></a>
<FONT color="green">664</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.664"></a>
<FONT color="green">665</FONT>        }<a name="line.665"></a>
<FONT color="green">666</FONT>    <a name="line.666"></a>
<FONT color="green">667</FONT>    <a name="line.667"></a>
<FONT color="green">668</FONT>    <a name="line.668"></a>
<FONT color="green">669</FONT>        /**<a name="line.669"></a>
<FONT color="green">670</FONT>         * Returns the raw languages from the passed accept-language header, ordered by their<a name="line.670"></a>
<FONT color="green">671</FONT>         * descending q values (explicit or implied).<a name="line.671"></a>
<FONT color="green">672</FONT>         *<a name="line.672"></a>
<FONT color="green">673</FONT>         * @param header the accept-language header to get the languages and weighting order from<a name="line.673"></a>
<FONT color="green">674</FONT>         * @return the raw languages ordered by their descending q values<a name="line.674"></a>
<FONT color="green">675</FONT>         */<a name="line.675"></a>
<FONT color="green">676</FONT>        static public NSArray orderedLanguagesFromHeader(String header)<a name="line.676"></a>
<FONT color="green">677</FONT>        {<a name="line.677"></a>
<FONT color="green">678</FONT>            /** require [valid_param] header != null; **/<a name="line.678"></a>
<FONT color="green">679</FONT>    <a name="line.679"></a>
<FONT color="green">680</FONT>            final Double maximum = new Double(1.0);<a name="line.680"></a>
<FONT color="green">681</FONT>            NSArray rawLanguages = NSArray.componentsSeparatedByString(header, ",");<a name="line.681"></a>
<FONT color="green">682</FONT>            NSMutableDictionary weightedLanguages = new NSMutableDictionary(rawLanguages.count());<a name="line.682"></a>
<FONT color="green">683</FONT>            for (int i = 0; i &lt; rawLanguages.count(); i++)<a name="line.683"></a>
<FONT color="green">684</FONT>            {<a name="line.684"></a>
<FONT color="green">685</FONT>                String language = ((String)rawLanguages.objectAtIndex(i)).trim();<a name="line.685"></a>
<FONT color="green">686</FONT>                String languageCode = language;<a name="line.686"></a>
<FONT color="green">687</FONT>                Double weight = maximum;<a name="line.687"></a>
<FONT color="green">688</FONT>    <a name="line.688"></a>
<FONT color="green">689</FONT>                // Extract explicit weighting<a name="line.689"></a>
<FONT color="green">690</FONT>                if (language.indexOf(";") &gt; -1)<a name="line.690"></a>
<FONT color="green">691</FONT>                {<a name="line.691"></a>
<FONT color="green">692</FONT>                    languageCode = language.substring(0, language.indexOf(";")).trim();<a name="line.692"></a>
<FONT color="green">693</FONT>                    weight = Double.valueOf(language.substring(language.indexOf("=") + 1));<a name="line.693"></a>
<FONT color="green">694</FONT>                }<a name="line.694"></a>
<FONT color="green">695</FONT>    <a name="line.695"></a>
<FONT color="green">696</FONT>                weightedLanguages.setObjectForKey(languageCode, weight);<a name="line.696"></a>
<FONT color="green">697</FONT>            }<a name="line.697"></a>
<FONT color="green">698</FONT>    <a name="line.698"></a>
<FONT color="green">699</FONT>            NSArray sortedWeights = NSArrayAdditions.sortedArrayUsingComparator(weightedLanguages.allKeys(), NSComparator.DescendingNumberComparator);<a name="line.699"></a>
<FONT color="green">700</FONT>            return weightedLanguages.objectsForKeys(sortedWeights, defaultLanguageISOCode());<a name="line.700"></a>
<FONT color="green">701</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.701"></a>
<FONT color="green">702</FONT>        }<a name="line.702"></a>
<FONT color="green">703</FONT>    <a name="line.703"></a>
<FONT color="green">704</FONT>    <a name="line.704"></a>
<FONT color="green">705</FONT>    <a name="line.705"></a>
<FONT color="green">706</FONT>        /**<a name="line.706"></a>
<FONT color="green">707</FONT>         * Returns the human readable name (in English) for the passed ISO language  and country name.<a name="line.707"></a>
<FONT color="green">708</FONT>         * The format is language-country, e.g. English-Canada.  The country is optional. If no language<a name="line.708"></a>
<FONT color="green">709</FONT>         * is recognized, English is returned.  The codes are translated into names using the dictionaries<a name="line.709"></a>
<FONT color="green">710</FONT>         * from languagesISO639() and countriesISO3166().<a name="line.710"></a>
<FONT color="green">711</FONT>         *<a name="line.711"></a>
<FONT color="green">712</FONT>         * @param isoName the ISO language / country pair from the accept-language header<a name="line.712"></a>
<FONT color="green">713</FONT>         * @return the human readable name for the passed ISO language  and country name<a name="line.713"></a>
<FONT color="green">714</FONT>         */<a name="line.714"></a>
<FONT color="green">715</FONT>        static public String humanReadableNameForISOName(String isoName)<a name="line.715"></a>
<FONT color="green">716</FONT>        {<a name="line.716"></a>
<FONT color="green">717</FONT>            /** require [valid_param] isoName != null; **/<a name="line.717"></a>
<FONT color="green">718</FONT>    <a name="line.718"></a>
<FONT color="green">719</FONT>            String humanLanguage = null;<a name="line.719"></a>
<FONT color="green">720</FONT>            String humanCountry = null;<a name="line.720"></a>
<FONT color="green">721</FONT>            if (isoName.indexOf("-") == -1)<a name="line.721"></a>
<FONT color="green">722</FONT>            {<a name="line.722"></a>
<FONT color="green">723</FONT>                humanLanguage = (String) languagesISO639().objectForKey(isoName.toLowerCase());<a name="line.723"></a>
<FONT color="green">724</FONT>            }<a name="line.724"></a>
<FONT color="green">725</FONT>            else<a name="line.725"></a>
<FONT color="green">726</FONT>            {<a name="line.726"></a>
<FONT color="green">727</FONT>                humanLanguage = (String) languagesISO639().objectForKey(isoName.substring(0, isoName.indexOf("-")).trim().toLowerCase());<a name="line.727"></a>
<FONT color="green">728</FONT>                humanCountry = (String) countriesISO3166().objectForKey(isoName.substring(isoName.indexOf("-") + 1).trim().toUpperCase());<a name="line.728"></a>
<FONT color="green">729</FONT>            }<a name="line.729"></a>
<FONT color="green">730</FONT>    <a name="line.730"></a>
<FONT color="green">731</FONT>           StringBuffer humanReadableName = new StringBuffer();<a name="line.731"></a>
<FONT color="green">732</FONT>            if (humanLanguage == null)<a name="line.732"></a>
<FONT color="green">733</FONT>            {<a name="line.733"></a>
<FONT color="green">734</FONT>                humanReadableName.append(defaultLanguage());<a name="line.734"></a>
<FONT color="green">735</FONT>            }<a name="line.735"></a>
<FONT color="green">736</FONT>            else<a name="line.736"></a>
<FONT color="green">737</FONT>            {<a name="line.737"></a>
<FONT color="green">738</FONT>                humanReadableName.append(humanLanguage);<a name="line.738"></a>
<FONT color="green">739</FONT>                if (humanCountry != null)<a name="line.739"></a>
<FONT color="green">740</FONT>                {<a name="line.740"></a>
<FONT color="green">741</FONT>                    humanReadableName.append("-");<a name="line.741"></a>
<FONT color="green">742</FONT>                    humanReadableName.append(humanCountry);<a name="line.742"></a>
<FONT color="green">743</FONT>                }<a name="line.743"></a>
<FONT color="green">744</FONT>            }<a name="line.744"></a>
<FONT color="green">745</FONT>    <a name="line.745"></a>
<FONT color="green">746</FONT>            return humanReadableName.toString();<a name="line.746"></a>
<FONT color="green">747</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.747"></a>
<FONT color="green">748</FONT>        }<a name="line.748"></a>
<FONT color="green">749</FONT>    <a name="line.749"></a>
<FONT color="green">750</FONT>    <a name="line.750"></a>
<FONT color="green">751</FONT>    <a name="line.751"></a>
<FONT color="green">752</FONT>        /**<a name="line.752"></a>
<FONT color="green">753</FONT>         * Returns a dictionary of counties keyed on ISO 3166 country code.  The entries in<a name="line.753"></a>
<FONT color="green">754</FONT>         * the dictionary are taken from the CountriesISO3166.plist resource in this framework.<a name="line.754"></a>
<FONT color="green">755</FONT>         * These values are intended for use with localization, but may also be used for other purposes.<a name="line.755"></a>
<FONT color="green">756</FONT>         *<a name="line.756"></a>
<FONT color="green">757</FONT>         * @return dictionary of counties keyed on ISO 3166 country code<a name="line.757"></a>
<FONT color="green">758</FONT>         */<a name="line.758"></a>
<FONT color="green">759</FONT>        public static NSDictionary countriesISO3166()<a name="line.759"></a>
<FONT color="green">760</FONT>        {<a name="line.760"></a>
<FONT color="green">761</FONT>            if (countriesISO3166 == null)<a name="line.761"></a>
<FONT color="green">762</FONT>            {<a name="line.762"></a>
<FONT color="green">763</FONT>                String dictionaryString = ResourceManagerAdditions.stringFromResource("CountriesISO3166.plist", "GVCWOExtensions");<a name="line.763"></a>
<FONT color="green">764</FONT>    <a name="line.764"></a>
<FONT color="green">765</FONT>                if (dictionaryString == null)<a name="line.765"></a>
<FONT color="green">766</FONT>                {<a name="line.766"></a>
<FONT color="green">767</FONT>                    throw new RuntimeException("Failed to load resource CountriesISO3166.plist from GVCWOExtensions framework.");<a name="line.767"></a>
<FONT color="green">768</FONT>                }<a name="line.768"></a>
<FONT color="green">769</FONT>    <a name="line.769"></a>
<FONT color="green">770</FONT>                countriesISO3166 = NSPropertyListSerialization.dictionaryForString(dictionaryString);<a name="line.770"></a>
<FONT color="green">771</FONT>            }<a name="line.771"></a>
<FONT color="green">772</FONT>    <a name="line.772"></a>
<FONT color="green">773</FONT>            return countriesISO3166;<a name="line.773"></a>
<FONT color="green">774</FONT>            /** ensure [valid_result] (Result != null) &amp;&amp; (Result.count() &gt; 0);   **/<a name="line.774"></a>
<FONT color="green">775</FONT>        }<a name="line.775"></a>
<FONT color="green">776</FONT>    <a name="line.776"></a>
<FONT color="green">777</FONT>    <a name="line.777"></a>
<FONT color="green">778</FONT>    <a name="line.778"></a>
<FONT color="green">779</FONT>        /**<a name="line.779"></a>
<FONT color="green">780</FONT>         * Returns a dictionary of languages keyed on ISO 639 language code.  The entries in<a name="line.780"></a>
<FONT color="green">781</FONT>         * the dictionary are taken from the LanguagesISO639.plist resource in this framework.<a name="line.781"></a>
<FONT color="green">782</FONT>         * These values are intended for use with localization, but may also be used for other purposes.<a name="line.782"></a>
<FONT color="green">783</FONT>         *<a name="line.783"></a>
<FONT color="green">784</FONT>         * @return dictionary of languages keyed on ISO 639 country code<a name="line.784"></a>
<FONT color="green">785</FONT>         */<a name="line.785"></a>
<FONT color="green">786</FONT>        public static NSDictionary languagesISO639()<a name="line.786"></a>
<FONT color="green">787</FONT>        {<a name="line.787"></a>
<FONT color="green">788</FONT>            if (languagesISO639 == null)<a name="line.788"></a>
<FONT color="green">789</FONT>            {<a name="line.789"></a>
<FONT color="green">790</FONT>                String dictionaryString = ResourceManagerAdditions.stringFromResource("LanguagesISO639.plist", "GVCWOExtensions");<a name="line.790"></a>
<FONT color="green">791</FONT>    <a name="line.791"></a>
<FONT color="green">792</FONT>                if (dictionaryString == null)<a name="line.792"></a>
<FONT color="green">793</FONT>                {<a name="line.793"></a>
<FONT color="green">794</FONT>                    throw new RuntimeException("Failed to load resource LanguagesISO639.plist from GVCWOExtensions framework.");<a name="line.794"></a>
<FONT color="green">795</FONT>                }<a name="line.795"></a>
<FONT color="green">796</FONT>    <a name="line.796"></a>
<FONT color="green">797</FONT>                languagesISO639 = NSPropertyListSerialization.dictionaryForString(dictionaryString);<a name="line.797"></a>
<FONT color="green">798</FONT>            }<a name="line.798"></a>
<FONT color="green">799</FONT>    <a name="line.799"></a>
<FONT color="green">800</FONT>            return languagesISO639;<a name="line.800"></a>
<FONT color="green">801</FONT>            /** ensure [valid_result] (Result != null) &amp;&amp; (Result.count() &gt; 0);   **/<a name="line.801"></a>
<FONT color="green">802</FONT>        }<a name="line.802"></a>
<FONT color="green">803</FONT>    <a name="line.803"></a>
<FONT color="green">804</FONT>    <a name="line.804"></a>
<FONT color="green">805</FONT>    <a name="line.805"></a>
<FONT color="green">806</FONT>        /**<a name="line.806"></a>
<FONT color="green">807</FONT>         * The default language is used if the browser does not supply one or if none of the languages<a name="line.807"></a>
<FONT color="green">808</FONT>         * requested by the browser are available.<a name="line.808"></a>
<FONT color="green">809</FONT>         *<a name="line.809"></a>
<FONT color="green">810</FONT>         * @return the ISO 639 code for the default language<a name="line.810"></a>
<FONT color="green">811</FONT>         */<a name="line.811"></a>
<FONT color="green">812</FONT>        public static String defaultLanguageISOCode()<a name="line.812"></a>
<FONT color="green">813</FONT>        {<a name="line.813"></a>
<FONT color="green">814</FONT>            return defaultLanguageISOCode;<a name="line.814"></a>
<FONT color="green">815</FONT>            /** ensure [valid_result] (Result != null) &amp;&amp; (languagesISO639().objectForKey(Result) != null);   **/<a name="line.815"></a>
<FONT color="green">816</FONT>    <a name="line.816"></a>
<FONT color="green">817</FONT>        }<a name="line.817"></a>
<FONT color="green">818</FONT>    <a name="line.818"></a>
<FONT color="green">819</FONT>    <a name="line.819"></a>
<FONT color="green">820</FONT>    <a name="line.820"></a>
<FONT color="green">821</FONT>        /**<a name="line.821"></a>
<FONT color="green">822</FONT>         * The default language is used if the browser does not supply one or if none of the languages<a name="line.822"></a>
<FONT color="green">823</FONT>         * requested by the browser are available.<a name="line.823"></a>
<FONT color="green">824</FONT>         *<a name="line.824"></a>
<FONT color="green">825</FONT>         * @return the human recognizable name for the default language<a name="line.825"></a>
<FONT color="green">826</FONT>         */<a name="line.826"></a>
<FONT color="green">827</FONT>        public static String defaultLanguage()<a name="line.827"></a>
<FONT color="green">828</FONT>        {<a name="line.828"></a>
<FONT color="green">829</FONT>            return (String)languagesISO639().objectForKey(defaultLanguageISOCode());<a name="line.829"></a>
<FONT color="green">830</FONT>            /** ensure [valid_result] Result != null;  **/<a name="line.830"></a>
<FONT color="green">831</FONT>        }<a name="line.831"></a>
<FONT color="green">832</FONT>    <a name="line.832"></a>
<FONT color="green">833</FONT>    <a name="line.833"></a>
<FONT color="green">834</FONT>    <a name="line.834"></a>
<FONT color="green">835</FONT>        /**<a name="line.835"></a>
<FONT color="green">836</FONT>         * The default language is used if the browser does not supply one or if none of the languages<a name="line.836"></a>
<FONT color="green">837</FONT>         * requested by the browser are available.<a name="line.837"></a>
<FONT color="green">838</FONT>         *<a name="line.838"></a>
<FONT color="green">839</FONT>         * @param code the ISO 639 code for the language to use as the default<a name="line.839"></a>
<FONT color="green">840</FONT>         */<a name="line.840"></a>
<FONT color="green">841</FONT>        public void setDefaultLanguageISOCode(String code)<a name="line.841"></a>
<FONT color="green">842</FONT>        {<a name="line.842"></a>
<FONT color="green">843</FONT>            /** require [valid_code](code != null) &amp;&amp; (languagesISO639().objectForKey(code) != null);  **/<a name="line.843"></a>
<FONT color="green">844</FONT>            defaultLanguageISOCode = code;<a name="line.844"></a>
<FONT color="green">845</FONT>            /** ensure [language_set] (defaultLanguageISOCode() != null) &amp;&amp; (defaultLanguageISOCode().equals(code));  **/<a name="line.845"></a>
<FONT color="green">846</FONT>        }<a name="line.846"></a>
<FONT color="green">847</FONT>    <a name="line.847"></a>
<FONT color="green">848</FONT>    <a name="line.848"></a>
<FONT color="green">849</FONT>    }<a name="line.849"></a>




























































</PRE>
</BODY>
</HTML>
