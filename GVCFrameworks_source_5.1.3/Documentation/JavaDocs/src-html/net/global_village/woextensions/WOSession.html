<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    package net.global_village.woextensions;<a name="line.1"></a>
<FONT color="green">002</FONT>    <a name="line.2"></a>
<FONT color="green">003</FONT>    import com.webobjects.appserver.*;<a name="line.3"></a>
<FONT color="green">004</FONT>    import com.webobjects.appserver.WOComponent;<a name="line.4"></a>
<FONT color="green">005</FONT>    import com.webobjects.eoaccess.*;<a name="line.5"></a>
<FONT color="green">006</FONT>    import com.webobjects.eocontrol.*;<a name="line.6"></a>
<FONT color="green">007</FONT>    import com.webobjects.eocontrol.EOEditingContext;<a name="line.7"></a>
<FONT color="green">008</FONT>    import com.webobjects.foundation.*;<a name="line.8"></a>
<FONT color="green">009</FONT>    <a name="line.9"></a>
<FONT color="green">010</FONT>    import er.extensions.appserver.ajax.*;<a name="line.10"></a>
<FONT color="green">011</FONT>    import er.extensions.foundation.*;<a name="line.11"></a>
<FONT color="green">012</FONT>    <a name="line.12"></a>
<FONT color="green">013</FONT>    import net.global_village.eofextensions.*;<a name="line.13"></a>
<FONT color="green">014</FONT>    import net.global_village.eofvalidation.*;<a name="line.14"></a>
<FONT color="green">015</FONT>    import net.global_village.foundation.*;<a name="line.15"></a>
<FONT color="green">016</FONT>    <a name="line.16"></a>
<FONT color="green">017</FONT>    <a name="line.17"></a>
<FONT color="green">018</FONT>    /**<a name="line.18"></a>
<FONT color="green">019</FONT>     * &lt;p&gt;Extension of WOSession with localization support and managed (locked) editing contexts. There are four related areas that need localization: WOComponents, validation error messages,<a name="line.19"></a>
<FONT color="green">020</FONT>     * database lookup tables (Generic Objects), and EO Based Localization&lt;/p&gt;<a name="line.20"></a>
<FONT color="green">021</FONT>     * &lt;dl&gt;<a name="line.21"></a>
<FONT color="green">022</FONT>     *   &lt;dt&gt;WOComponents<a name="line.22"></a>
<FONT color="green">023</FONT>     *   &lt;dd&gt;There are two ways to localize a WO component: either localize the entire component, or localized just the strings.<a name="line.23"></a>
<FONT color="green">024</FONT>     *       To do the former, merely include a copy of the component for each language in a &lt;Language Name&gt;.lproj directory.<a name="line.24"></a>
<FONT color="green">025</FONT>     *       You might need to do this if you have a component that needs it's structure changed when the language changes in order to handle the various<a name="line.25"></a>
<FONT color="green">026</FONT>     *       language differences. If you don't need a different component for each language, there are two options.  One is to use bindings like<a name="line.26"></a>
<FONT color="green">027</FONT>     *       value = @localize.KeyForString, @see localizedStringInContext(String, WOContext).  The otther is to use WOOgnl key paths and one of the<a name="line.27"></a>
<FONT color="green">028</FONT>     *       &lt;code&gt;localizedString&lt;/code&gt; methods from this class.  These keys will go into the value binding of &lt;code&gt;WOString&lt;/code&gt;, for example, and will look like<a name="line.28"></a>
<FONT color="green">029</FONT>     *       &lt;code&gt;~session().localizedString(\"String to localize\")&lt;/code&gt; or<a name="line.29"></a>
<FONT color="green">030</FONT>     *       &lt;code&gt;~session().localizedString(\"String to localize\", \"StringsFileNameWithoutExtension\", \"FrameworkNameWithoutExtension\")&lt;/code&gt;.&lt;br&gt;<a name="line.30"></a>
<FONT color="green">031</FONT>     *       &lt;em&gt;Note&lt;/em&gt;: you will need to subclass WOApplication from this package (or initialize WOOgnl yourself) if you want to use this facility.<a name="line.31"></a>
<FONT color="green">032</FONT>     *<a name="line.32"></a>
<FONT color="green">033</FONT>     *   &lt;dt&gt;Validation Error Messages<a name="line.33"></a>
<FONT color="green">034</FONT>     *   &lt;dd&gt;Use these as normal, except use &lt;code&gt;Session.localizedMessage&lt;/code&gt; (or the WOOgnl key path &lt;code&gt;~session().localizedMessage(exception)&lt;/code&gt;<a name="line.34"></a>
<FONT color="green">035</FONT>     *       for components) instead of &lt;code&gt;EOFValidationException.getLocalizedMessage&lt;/code&gt;.<a name="line.35"></a>
<FONT color="green">036</FONT>     *       The exact same search order for non-localized validation error messages is used, except languages are searched &lt;em&gt;depth-first&lt;/em&gt;.<a name="line.36"></a>
<FONT color="green">037</FONT>     *       (e.g., when looking for a key, all possibilities are tested within a single langauge, and it only moves on to the the next language if it can't find one).<a name="line.37"></a>
<FONT color="green">038</FONT>     *<a name="line.38"></a>
<FONT color="green">039</FONT>     *   &lt;dt&gt;Database Lookup Tables<a name="line.39"></a>
<FONT color="green">040</FONT>     *   &lt;dd&gt;Once again, use WOOgnl key paths, as in &lt;code&gt;~myGenericObject().localizedName(session().languages())&lt;/code&gt;, or use the Java call, similar<a name="line.40"></a>
<FONT color="green">041</FONT>     *       to the WOOgnl key path.<a name="line.41"></a>
<FONT color="green">042</FONT>     *<a name="line.42"></a>
<FONT color="green">043</FONT>     *   &lt;dt&gt;EO Based Localization<a name="line.43"></a>
<FONT color="green">044</FONT>     *   &lt;dd&gt;Use localizedEOStringExists and localizedEOString as a gateway to the functions in EOValidation's LocalizationEngine.<a name="line.44"></a>
<FONT color="green">045</FONT>     * &lt;/dl&gt;<a name="line.45"></a>
<FONT color="green">046</FONT>     *<a name="line.46"></a>
<FONT color="green">047</FONT>     * &lt;p&gt;Note: this currently uses the default WO language detection. This means that locale-specific language dialects are folded into a single language,<a name="line.47"></a>
<FONT color="green">048</FONT>     * i.e. EN-CA (Canadian English), EN-GB (British English), and EN-US (US English) all resolve as "English". If necessary, use the code from<a name="line.48"></a>
<FONT color="green">049</FONT>     * Chapter 8 of Practical WO to detect and use locale-specific languages. This code was not added here, as sometimes one does not want to<a name="line.49"></a>
<FONT color="green">050</FONT>     * have to do different translations for each language dialect.&lt;/p&gt;<a name="line.50"></a>
<FONT color="green">051</FONT>     *<a name="line.51"></a>
<FONT color="green">052</FONT>     * @author Copyright (c) 2001-2005  Global Village Consulting, Inc.  All rights reserved.<a name="line.52"></a>
<FONT color="green">053</FONT>     * This software is published under the terms of the Educational Community License (ECL) version 1.0,<a name="line.53"></a>
<FONT color="green">054</FONT>     * a copy of which has been included with this distribution in the LICENSE.TXT file.<a name="line.54"></a>
<FONT color="green">055</FONT>     * @version $Revision: 26$<a name="line.55"></a>
<FONT color="green">056</FONT>     */<a name="line.56"></a>
<FONT color="green">057</FONT>    public class WOSession extends ERXAjaxSession<a name="line.57"></a>
<FONT color="green">058</FONT>    {<a name="line.58"></a>
<FONT color="green">059</FONT>        private static final long serialVersionUID = -926657844329305028L;<a name="line.59"></a>
<FONT color="green">060</FONT>    <a name="line.60"></a>
<FONT color="green">061</FONT>        /** This class manages the editing contexts vended by this session. */<a name="line.61"></a>
<FONT color="green">062</FONT>        protected MultiECLockManager ecLockManager;<a name="line.62"></a>
<FONT color="green">063</FONT>    <a name="line.63"></a>
<FONT color="green">064</FONT>        /** This is used to detect when the user's language preference needs to be changed.  */<a name="line.64"></a>
<FONT color="green">065</FONT>        protected String lastSeenLanguages = null;<a name="line.65"></a>
<FONT color="green">066</FONT>    <a name="line.66"></a>
<FONT color="green">067</FONT>        /** This is an optimization used to cached strings previously localized.  */<a name="line.67"></a>
<FONT color="green">068</FONT>        protected NSMutableDictionary cachedLocalizedStrings = new NSMutableDictionary();<a name="line.68"></a>
<FONT color="green">069</FONT>    <a name="line.69"></a>
<FONT color="green">070</FONT>    <a name="line.70"></a>
<FONT color="green">071</FONT>        /**<a name="line.71"></a>
<FONT color="green">072</FONT>         * Returns the session being used in the current thread.  Returns null if thread not in R-R loop,<a name="line.72"></a>
<FONT color="green">073</FONT>         * in R-R loop before session.awake(), or in in R-R loop after session.sleep().<a name="line.73"></a>
<FONT color="green">074</FONT>         *<a name="line.74"></a>
<FONT color="green">075</FONT>         * @return the session being used in the current thread, null if thread not in R-R loop<a name="line.75"></a>
<FONT color="green">076</FONT>         * or before session.awake()<a name="line.76"></a>
<FONT color="green">077</FONT>         */<a name="line.77"></a>
<FONT color="green">078</FONT>        public static WOSession session()<a name="line.78"></a>
<FONT color="green">079</FONT>        {<a name="line.79"></a>
<FONT color="green">080</FONT>            return (WOSession) ERXThreadStorage.valueForKey("session");<a name="line.80"></a>
<FONT color="green">081</FONT>        }<a name="line.81"></a>
<FONT color="green">082</FONT>    <a name="line.82"></a>
<FONT color="green">083</FONT>    <a name="line.83"></a>
<FONT color="green">084</FONT>    <a name="line.84"></a>
<FONT color="green">085</FONT>        /**<a name="line.85"></a>
<FONT color="green">086</FONT>         * Sets the session being used by the current thread.  This is called by awake() and sleep().<a name="line.86"></a>
<FONT color="green">087</FONT>         *<a name="line.87"></a>
<FONT color="green">088</FONT>         * @param session the session being used by the current thread<a name="line.88"></a>
<FONT color="green">089</FONT>         */<a name="line.89"></a>
<FONT color="green">090</FONT>        public static void setSession(WOSession session)<a name="line.90"></a>
<FONT color="green">091</FONT>        {<a name="line.91"></a>
<FONT color="green">092</FONT>            ERXThreadStorage.takeValueForKey(session, "session");<a name="line.92"></a>
<FONT color="green">093</FONT>        }<a name="line.93"></a>
<FONT color="green">094</FONT>    <a name="line.94"></a>
<FONT color="green">095</FONT>    <a name="line.95"></a>
<FONT color="green">096</FONT>    <a name="line.96"></a>
<FONT color="green">097</FONT>        /**<a name="line.97"></a>
<FONT color="green">098</FONT>         * Method to handle terminating session upon logout (forced or requested).<a name="line.98"></a>
<FONT color="green">099</FONT>         */<a name="line.99"></a>
<FONT color="green">100</FONT>        public static void logout(com.webobjects.appserver.WOSession session, WOResponse response)<a name="line.100"></a>
<FONT color="green">101</FONT>        {<a name="line.101"></a>
<FONT color="green">102</FONT>            /** require [valid_session] session != null;  [valid_response] response != null;  **/<a name="line.102"></a>
<FONT color="green">103</FONT>    <a name="line.103"></a>
<FONT color="green">104</FONT>            // Try to avoid deadlock when multiple requests came in for a session that is getting terminated<a name="line.104"></a>
<FONT color="green">105</FONT>            // Ajax components can cause this<a name="line.105"></a>
<FONT color="green">106</FONT>            session.setTimeOut(WOApplication.appProperties().intPropertyForKey("SessionTerminateTimeOutInSeconds"));<a name="line.106"></a>
<FONT color="green">107</FONT>    <a name="line.107"></a>
<FONT color="green">108</FONT>            // This prevents WO from returning a cookie from the soon to be expired session<a name="line.108"></a>
<FONT color="green">109</FONT>            // and instructs the browser to discard the cookie that it has for the session<a name="line.109"></a>
<FONT color="green">110</FONT>            session.setStoresIDsInCookies(false);<a name="line.110"></a>
<FONT color="green">111</FONT>            discardSessionCookies(response);<a name="line.111"></a>
<FONT color="green">112</FONT>    <a name="line.112"></a>
<FONT color="green">113</FONT>            session.defaultEditingContext().revert();<a name="line.113"></a>
<FONT color="green">114</FONT>        }<a name="line.114"></a>
<FONT color="green">115</FONT>    <a name="line.115"></a>
<FONT color="green">116</FONT>    <a name="line.116"></a>
<FONT color="green">117</FONT>    <a name="line.117"></a>
<FONT color="green">118</FONT>    <a name="line.118"></a>
<FONT color="green">119</FONT>        /**<a name="line.119"></a>
<FONT color="green">120</FONT>         * Sends adds expired cookies for session ID and instance number to response.<a name="line.120"></a>
<FONT color="green">121</FONT>         */<a name="line.121"></a>
<FONT color="green">122</FONT>        public static void discardSessionCookies(WOResponse response)<a name="line.122"></a>
<FONT color="green">123</FONT>        {<a name="line.123"></a>
<FONT color="green">124</FONT>            /** require [valid_response] response != null;  **/<a name="line.124"></a>
<FONT color="green">125</FONT>            WOCookie killSession = new WOCookie(WOApplication.application().sessionIdKey(), ".", "/", null, 0, true);<a name="line.125"></a>
<FONT color="green">126</FONT>            response.addCookie(killSession);<a name="line.126"></a>
<FONT color="green">127</FONT>    <a name="line.127"></a>
<FONT color="green">128</FONT>            // Leave the instance number there during development for apps using rewrites etc.<a name="line.128"></a>
<FONT color="green">129</FONT>            if ( ! ((WOApplication)WOApplication.application()).developmentMode())<a name="line.129"></a>
<FONT color="green">130</FONT>            {<a name="line.130"></a>
<FONT color="green">131</FONT>                WOCookie killInstance = new WOCookie(WOApplication.application().instanceIdKey(), ".", "/", null, 0, true);<a name="line.131"></a>
<FONT color="green">132</FONT>                response.addCookie(killInstance);<a name="line.132"></a>
<FONT color="green">133</FONT>            }<a name="line.133"></a>
<FONT color="green">134</FONT>        }<a name="line.134"></a>
<FONT color="green">135</FONT>    <a name="line.135"></a>
<FONT color="green">136</FONT>    <a name="line.136"></a>
<FONT color="green">137</FONT>    <a name="line.137"></a>
<FONT color="green">138</FONT>        /**<a name="line.138"></a>
<FONT color="green">139</FONT>         * Designated constructor.<a name="line.139"></a>
<FONT color="green">140</FONT>         */<a name="line.140"></a>
<FONT color="green">141</FONT>        public WOSession()<a name="line.141"></a>
<FONT color="green">142</FONT>        {<a name="line.142"></a>
<FONT color="green">143</FONT>            super();<a name="line.143"></a>
<FONT color="green">144</FONT>    <a name="line.144"></a>
<FONT color="green">145</FONT>            // This needs to happen before anyone uses the default editing context<a name="line.145"></a>
<FONT color="green">146</FONT>            // setDefaultEditingContext also locks the ec<a name="line.146"></a>
<FONT color="green">147</FONT>            setDefaultEditingContext(application().newEditingContext());<a name="line.147"></a>
<FONT color="green">148</FONT>    <a name="line.148"></a>
<FONT color="green">149</FONT>            NSLog.out.appendln("Creating session " + sessionID());<a name="line.149"></a>
<FONT color="green">150</FONT>            NSLog.out.appendln("Current active sessions: "<a name="line.150"></a>
<FONT color="green">151</FONT>                    + application().activeSessionsCount());<a name="line.151"></a>
<FONT color="green">152</FONT>    <a name="line.152"></a>
<FONT color="green">153</FONT>            ecLockManager = new MultiECLockManager(application().editingContextClass());<a name="line.153"></a>
<FONT color="green">154</FONT>        }<a name="line.154"></a>
<FONT color="green">155</FONT>    <a name="line.155"></a>
<FONT color="green">156</FONT>    <a name="line.156"></a>
<FONT color="green">157</FONT>    <a name="line.157"></a>
<FONT color="green">158</FONT>        /**<a name="line.158"></a>
<FONT color="green">159</FONT>         * Overridden to lock any editing context's registered with the lock manager.<a name="line.159"></a>
<FONT color="green">160</FONT>         */<a name="line.160"></a>
<FONT color="green">161</FONT>        public void awake()<a name="line.161"></a>
<FONT color="green">162</FONT>        {<a name="line.162"></a>
<FONT color="green">163</FONT>            NSLog.out.appendln("Awake session " + sessionID());<a name="line.163"></a>
<FONT color="green">164</FONT>            NSLog.out.appendln("====================================");<a name="line.164"></a>
<FONT color="green">165</FONT>            try<a name="line.165"></a>
<FONT color="green">166</FONT>            {<a name="line.166"></a>
<FONT color="green">167</FONT>                WOSession.setSession(this);<a name="line.167"></a>
<FONT color="green">168</FONT>                    ecLockManager().lock();<a name="line.168"></a>
<FONT color="green">169</FONT>            }<a name="line.169"></a>
<FONT color="green">170</FONT>            catch(Throwable t)<a name="line.170"></a>
<FONT color="green">171</FONT>            {<a name="line.171"></a>
<FONT color="green">172</FONT>                    // DANGEROUS: we *must* eat this exception or the whole app might deadlock<a name="line.172"></a>
<FONT color="green">173</FONT>                    NSLog.err.appendln("********** EXCEPTION in WOSession.awake() calling ecLockManager.lock(): " + t);<a name="line.173"></a>
<FONT color="green">174</FONT>            }<a name="line.174"></a>
<FONT color="green">175</FONT>            super.awake();<a name="line.175"></a>
<FONT color="green">176</FONT>        }<a name="line.176"></a>
<FONT color="green">177</FONT>    <a name="line.177"></a>
<FONT color="green">178</FONT>    <a name="line.178"></a>
<FONT color="green">179</FONT>    <a name="line.179"></a>
<FONT color="green">180</FONT>        /**<a name="line.180"></a>
<FONT color="green">181</FONT>         * Overridden to provide log messages and to unlock any editing context's registered with the lock manager.<a name="line.181"></a>
<FONT color="green">182</FONT>         */<a name="line.182"></a>
<FONT color="green">183</FONT>        public void sleep()<a name="line.183"></a>
<FONT color="green">184</FONT>        {<a name="line.184"></a>
<FONT color="green">185</FONT>            // Need to check as this gets called after terminate() when logging out<a name="line.185"></a>
<FONT color="green">186</FONT>            synchronized (ecLockManager)<a name="line.186"></a>
<FONT color="green">187</FONT>            {<a name="line.187"></a>
<FONT color="green">188</FONT>                if (ecLockManager().isLocked())<a name="line.188"></a>
<FONT color="green">189</FONT>                {<a name="line.189"></a>
<FONT color="green">190</FONT>                    try<a name="line.190"></a>
<FONT color="green">191</FONT>                    {<a name="line.191"></a>
<FONT color="green">192</FONT>                            ecLockManager().unlock();<a name="line.192"></a>
<FONT color="green">193</FONT>                        WOSession.setSession(null);<a name="line.193"></a>
<FONT color="green">194</FONT>                    }<a name="line.194"></a>
<FONT color="green">195</FONT>                    catch (Throwable t)<a name="line.195"></a>
<FONT color="green">196</FONT>                    {<a name="line.196"></a>
<FONT color="green">197</FONT>                            // DANGEROUS: we *must* eat this exception or the whole app might deadlock<a name="line.197"></a>
<FONT color="green">198</FONT>                            NSLog.err.appendln("********** EXCEPTION in WOSession.sleep() calling ecLockManager.unlock(): " + t);<a name="line.198"></a>
<FONT color="green">199</FONT>                    }<a name="line.199"></a>
<FONT color="green">200</FONT>                }<a name="line.200"></a>
<FONT color="green">201</FONT>            }<a name="line.201"></a>
<FONT color="green">202</FONT>    <a name="line.202"></a>
<FONT color="green">203</FONT>            super.sleep();<a name="line.203"></a>
<FONT color="green">204</FONT>    <a name="line.204"></a>
<FONT color="green">205</FONT>            NSLog.out.appendln("sleep session " + sessionID());<a name="line.205"></a>
<FONT color="green">206</FONT>            NSLog.out.appendln("====================================");<a name="line.206"></a>
<FONT color="green">207</FONT>        }<a name="line.207"></a>
<FONT color="green">208</FONT>    <a name="line.208"></a>
<FONT color="green">209</FONT>    <a name="line.209"></a>
<FONT color="green">210</FONT>    <a name="line.210"></a>
<FONT color="green">211</FONT>        /**<a name="line.211"></a>
<FONT color="green">212</FONT>         * Skips caching the page if the page or response does not want to be cached.<a name="line.212"></a>
<FONT color="green">213</FONT>         *<a name="line.213"></a>
<FONT color="green">214</FONT>         * @see ERXAjaxSession#savePage(com.webobjects.appserver.WOComponent)<a name="line.214"></a>
<FONT color="green">215</FONT>         * @see Response#isPageCachingDisabled()<a name="line.215"></a>
<FONT color="green">216</FONT>         *<a name="line.216"></a>
<FONT color="green">217</FONT>         * @param page the WOComponent instance to cache for this request<a name="line.217"></a>
<FONT color="green">218</FONT>         */<a name="line.218"></a>
<FONT color="green">219</FONT>        public void savePage(WOComponent page)<a name="line.219"></a>
<FONT color="green">220</FONT>        {<a name="line.220"></a>
<FONT color="green">221</FONT>            WOResponse response = context().response();<a name="line.221"></a>
<FONT color="green">222</FONT>            boolean isPageCachingDisabled = response instanceof Response &amp;&amp; ((Response)response).isPageCachingDisabled();<a name="line.222"></a>
<FONT color="green">223</FONT>            if ( ! isPageCachingDisabled)<a name="line.223"></a>
<FONT color="green">224</FONT>            {<a name="line.224"></a>
<FONT color="green">225</FONT>                super.savePage(page);<a name="line.225"></a>
<FONT color="green">226</FONT>            }<a name="line.226"></a>
<FONT color="green">227</FONT>        }<a name="line.227"></a>
<FONT color="green">228</FONT>    <a name="line.228"></a>
<FONT color="green">229</FONT>    <a name="line.229"></a>
<FONT color="green">230</FONT>    <a name="line.230"></a>
<FONT color="green">231</FONT>        /**<a name="line.231"></a>
<FONT color="green">232</FONT>         * Method to handle terminating session upon logout (forced or requested).<a name="line.232"></a>
<FONT color="green">233</FONT>         * @see #logout(WOSession, WOResponse)<a name="line.233"></a>
<FONT color="green">234</FONT>         */<a name="line.234"></a>
<FONT color="green">235</FONT>        public void logout(WOResponse response)<a name="line.235"></a>
<FONT color="green">236</FONT>        {<a name="line.236"></a>
<FONT color="green">237</FONT>            WOSession.logout(this, response);<a name="line.237"></a>
<FONT color="green">238</FONT>        }<a name="line.238"></a>
<FONT color="green">239</FONT>    <a name="line.239"></a>
<FONT color="green">240</FONT>    <a name="line.240"></a>
<FONT color="green">241</FONT>    <a name="line.241"></a>
<FONT color="green">242</FONT>        /**<a name="line.242"></a>
<FONT color="green">243</FONT>         * Unlock lock manager and diagnostic messages.<a name="line.243"></a>
<FONT color="green">244</FONT>         */<a name="line.244"></a>
<FONT color="green">245</FONT>        public void terminate()<a name="line.245"></a>
<FONT color="green">246</FONT>        {<a name="line.246"></a>
<FONT color="green">247</FONT>            // Need to make sure this is unlocked so that editing contexts nested in the defaultEditingContext<a name="line.247"></a>
<FONT color="green">248</FONT>            // don't hold locks on it when it gets disposed<a name="line.248"></a>
<FONT color="green">249</FONT>            synchronized (ecLockManager)<a name="line.249"></a>
<FONT color="green">250</FONT>            {<a name="line.250"></a>
<FONT color="green">251</FONT>                if (ecLockManager().isLocked())<a name="line.251"></a>
<FONT color="green">252</FONT>                {<a name="line.252"></a>
<FONT color="green">253</FONT>                    try<a name="line.253"></a>
<FONT color="green">254</FONT>                    {<a name="line.254"></a>
<FONT color="green">255</FONT>                            ecLockManager().unlock();<a name="line.255"></a>
<FONT color="green">256</FONT>                    }<a name="line.256"></a>
<FONT color="green">257</FONT>                    catch (Throwable t)<a name="line.257"></a>
<FONT color="green">258</FONT>                    {<a name="line.258"></a>
<FONT color="green">259</FONT>                            // DANGEROUS: we *must* eat this exception or the whole app might deadlock<a name="line.259"></a>
<FONT color="green">260</FONT>                            NSLog.err.appendln("********** EXCEPTION in WOSession.terminate() calling ecLockManager.unlock(): " + t);<a name="line.260"></a>
<FONT color="green">261</FONT>                    }<a name="line.261"></a>
<FONT color="green">262</FONT>                }<a name="line.262"></a>
<FONT color="green">263</FONT>            }<a name="line.263"></a>
<FONT color="green">264</FONT>    <a name="line.264"></a>
<FONT color="green">265</FONT>            super.terminate();<a name="line.265"></a>
<FONT color="green">266</FONT>    <a name="line.266"></a>
<FONT color="green">267</FONT>            NSLog.out.appendln("Terminated session " + sessionID());<a name="line.267"></a>
<FONT color="green">268</FONT>            NSLog.out.appendln("Remaining active sessions: " + WOApplication.application().activeSessionsCount());<a name="line.268"></a>
<FONT color="green">269</FONT>        }<a name="line.269"></a>
<FONT color="green">270</FONT>    <a name="line.270"></a>
<FONT color="green">271</FONT>    <a name="line.271"></a>
<FONT color="green">272</FONT>    <a name="line.272"></a>
<FONT color="green">273</FONT>        /**<a name="line.273"></a>
<FONT color="green">274</FONT>         * Returns a new peer editing context that is registered with this session's lock manager.  All<a name="line.274"></a>
<FONT color="green">275</FONT>         * editing contexts should be created with this method or it's parent version, below.  The<a name="line.275"></a>
<FONT color="green">276</FONT>         * returned editing context is locked if this is called during the Request-Response loop.<a name="line.276"></a>
<FONT color="green">277</FONT>         *<a name="line.277"></a>
<FONT color="green">278</FONT>         * @return a new editing context that is registered with this session's lock manager<a name="line.278"></a>
<FONT color="green">279</FONT>         */<a name="line.279"></a>
<FONT color="green">280</FONT>        public EOEditingContext newEditingContext()<a name="line.280"></a>
<FONT color="green">281</FONT>        {<a name="line.281"></a>
<FONT color="green">282</FONT>            return ecLockManager().newEditingContext();<a name="line.282"></a>
<FONT color="green">283</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.283"></a>
<FONT color="green">284</FONT>        }<a name="line.284"></a>
<FONT color="green">285</FONT>    <a name="line.285"></a>
<FONT color="green">286</FONT>    <a name="line.286"></a>
<FONT color="green">287</FONT>    <a name="line.287"></a>
<FONT color="green">288</FONT>        /**<a name="line.288"></a>
<FONT color="green">289</FONT>         * Returns a new child editing context that is registered with this session's lock manager.  All<a name="line.289"></a>
<FONT color="green">290</FONT>         * editing contexts should be created with this method or it's no-parent version, above.  The<a name="line.290"></a>
<FONT color="green">291</FONT>         * returned editing context is locked if this is called during the Request-Response loop.<a name="line.291"></a>
<FONT color="green">292</FONT>         *<a name="line.292"></a>
<FONT color="green">293</FONT>         * @param parentEC the new editing context's parent editing context<a name="line.293"></a>
<FONT color="green">294</FONT>         * @return a new editing context that is registered with this session's lock manager<a name="line.294"></a>
<FONT color="green">295</FONT>         */<a name="line.295"></a>
<FONT color="green">296</FONT>        public EOEditingContext newEditingContext(EOObjectStore parentEC)<a name="line.296"></a>
<FONT color="green">297</FONT>        {<a name="line.297"></a>
<FONT color="green">298</FONT>            /** require [valid_param] parentEC != null; **/<a name="line.298"></a>
<FONT color="green">299</FONT>            return ecLockManager().newEditingContext(parentEC);<a name="line.299"></a>
<FONT color="green">300</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.300"></a>
<FONT color="green">301</FONT>        }<a name="line.301"></a>
<FONT color="green">302</FONT>    <a name="line.302"></a>
<FONT color="green">303</FONT>    <a name="line.303"></a>
<FONT color="green">304</FONT>    <a name="line.304"></a>
<FONT color="green">305</FONT>        /**<a name="line.305"></a>
<FONT color="green">306</FONT>         * Registers the given EC in the lock manager.  Useful for custom-created ECs.<a name="line.306"></a>
<FONT color="green">307</FONT>         *<a name="line.307"></a>
<FONT color="green">308</FONT>         * @param anEC the editing context to register<a name="line.308"></a>
<FONT color="green">309</FONT>         */<a name="line.309"></a>
<FONT color="green">310</FONT>        public void registerEditingContext(EOEditingContext anEC)<a name="line.310"></a>
<FONT color="green">311</FONT>        {<a name="line.311"></a>
<FONT color="green">312</FONT>            /** require [valid_param] anEC != null; **/<a name="line.312"></a>
<FONT color="green">313</FONT>            ecLockManager().registerEditingContext(anEC);<a name="line.313"></a>
<FONT color="green">314</FONT>        }<a name="line.314"></a>
<FONT color="green">315</FONT>    <a name="line.315"></a>
<FONT color="green">316</FONT>    <a name="line.316"></a>
<FONT color="green">317</FONT>        /**<a name="line.317"></a>
<FONT color="green">318</FONT>         * Unregisters the given EC from the lock manager.  Useful for custom-created ECs.<a name="line.318"></a>
<FONT color="green">319</FONT>         *<a name="line.319"></a>
<FONT color="green">320</FONT>         * @param anEC the editing context to unregister<a name="line.320"></a>
<FONT color="green">321</FONT>         */<a name="line.321"></a>
<FONT color="green">322</FONT>        public void unregisterEditingContext(EOEditingContext anEC)<a name="line.322"></a>
<FONT color="green">323</FONT>        {<a name="line.323"></a>
<FONT color="green">324</FONT>            /** require [valid_param] anEC != null; **/<a name="line.324"></a>
<FONT color="green">325</FONT>            ecLockManager().unregisterEditingContext(anEC);<a name="line.325"></a>
<FONT color="green">326</FONT>        }<a name="line.326"></a>
<FONT color="green">327</FONT>    <a name="line.327"></a>
<FONT color="green">328</FONT>    <a name="line.328"></a>
<FONT color="green">329</FONT>    <a name="line.329"></a>
<FONT color="green">330</FONT>        /**<a name="line.330"></a>
<FONT color="green">331</FONT>         * Return the object managing editing context locking on this session's behalf.<a name="line.331"></a>
<FONT color="green">332</FONT>         *<a name="line.332"></a>
<FONT color="green">333</FONT>         * @return the object managing editing context locking on this session's behalf<a name="line.333"></a>
<FONT color="green">334</FONT>         */<a name="line.334"></a>
<FONT color="green">335</FONT>        protected MultiECLockManager ecLockManager()<a name="line.335"></a>
<FONT color="green">336</FONT>        {<a name="line.336"></a>
<FONT color="green">337</FONT>            return ecLockManager;<a name="line.337"></a>
<FONT color="green">338</FONT>        }<a name="line.338"></a>
<FONT color="green">339</FONT>    <a name="line.339"></a>
<FONT color="green">340</FONT>    <a name="line.340"></a>
<FONT color="green">341</FONT>    <a name="line.341"></a>
<FONT color="green">342</FONT>        /**<a name="line.342"></a>
<FONT color="green">343</FONT>         * Despite the name, this is actually the path used in the cookies for the session ID and instance number.<a name="line.343"></a>
<FONT color="green">344</FONT>         * Returning just the root '/' ensures that the cookies are always sent for any request to the domain.<a name="line.344"></a>
<FONT color="green">345</FONT>         * This was needed so that they are sent with URLs which will be rewritten.<a name="line.345"></a>
<FONT color="green">346</FONT>         * Note that super.domainForIDCookies() would return: /cgi-bin/WebObjects/AppName.woa<a name="line.346"></a>
<FONT color="green">347</FONT>         *<a name="line.347"></a>
<FONT color="green">348</FONT>         * @return "/"<a name="line.348"></a>
<FONT color="green">349</FONT>         */<a name="line.349"></a>
<FONT color="green">350</FONT>        public String domainForIDCookies()<a name="line.350"></a>
<FONT color="green">351</FONT>        {<a name="line.351"></a>
<FONT color="green">352</FONT>            return "/";<a name="line.352"></a>
<FONT color="green">353</FONT>        }<a name="line.353"></a>
<FONT color="green">354</FONT>    <a name="line.354"></a>
<FONT color="green">355</FONT>    <a name="line.355"></a>
<FONT color="green">356</FONT>    <a name="line.356"></a>
<FONT color="green">357</FONT>        /**<a name="line.357"></a>
<FONT color="green">358</FONT>         * Overidden to use RequestUtilities.browserLanguages so that the list of languages<a name="line.358"></a>
<FONT color="green">359</FONT>         * can include country specific differences.<a name="line.359"></a>
<FONT color="green">360</FONT>         */<a name="line.360"></a>
<FONT color="green">361</FONT>        public NSArray languages()<a name="line.361"></a>
<FONT color="green">362</FONT>        {<a name="line.362"></a>
<FONT color="green">363</FONT>            if(context() != null)<a name="line.363"></a>
<FONT color="green">364</FONT>            {<a name="line.364"></a>
<FONT color="green">365</FONT>                String languagesFromBrowswer = RequestUtilities.rawBrowserLanguages(context().request());<a name="line.365"></a>
<FONT color="green">366</FONT>                if ((lastSeenLanguages == null) || ( ! lastSeenLanguages.equals(languagesFromBrowswer)))<a name="line.366"></a>
<FONT color="green">367</FONT>                {<a name="line.367"></a>
<FONT color="green">368</FONT>                    lastSeenLanguages = languagesFromBrowswer;<a name="line.368"></a>
<FONT color="green">369</FONT>                    cachedLocalizedStrings = new NSMutableDictionary();<a name="line.369"></a>
<FONT color="green">370</FONT>                    setLanguages(RequestUtilities.browserLanguages(context().request()));<a name="line.370"></a>
<FONT color="green">371</FONT>                    NSLog.debug.appendln("Set session languages to " + super.languages());<a name="line.371"></a>
<FONT color="green">372</FONT>                }<a name="line.372"></a>
<FONT color="green">373</FONT>            }<a name="line.373"></a>
<FONT color="green">374</FONT>    <a name="line.374"></a>
<FONT color="green">375</FONT>            return super.languages();<a name="line.375"></a>
<FONT color="green">376</FONT>        }<a name="line.376"></a>
<FONT color="green">377</FONT>    <a name="line.377"></a>
<FONT color="green">378</FONT>    <a name="line.378"></a>
<FONT color="green">379</FONT>    <a name="line.379"></a>
<FONT color="green">380</FONT>        /**<a name="line.380"></a>
<FONT color="green">381</FONT>         * Returns a localized error message from on the passed exception.<a name="line.381"></a>
<FONT color="green">382</FONT>         *<a name="line.382"></a>
<FONT color="green">383</FONT>         * @param exception the exception to localize<a name="line.383"></a>
<FONT color="green">384</FONT>         * @return a localized error message from on the passed exception.<a name="line.384"></a>
<FONT color="green">385</FONT>         */<a name="line.385"></a>
<FONT color="green">386</FONT>        public String localizedMessage(Throwable exception)<a name="line.386"></a>
<FONT color="green">387</FONT>        {<a name="line.387"></a>
<FONT color="green">388</FONT>            /** require [valid_param] exception != null; **/<a name="line.388"></a>
<FONT color="green">389</FONT>    <a name="line.389"></a>
<FONT color="green">390</FONT>            String localizedMessage;<a name="line.390"></a>
<FONT color="green">391</FONT>    <a name="line.391"></a>
<FONT color="green">392</FONT>            if (exception instanceof EOFValidationException)<a name="line.392"></a>
<FONT color="green">393</FONT>            {<a name="line.393"></a>
<FONT color="green">394</FONT>                EOFValidationException validationException = (EOFValidationException)exception;<a name="line.394"></a>
<FONT color="green">395</FONT>                localizedMessage = validationException.getLocalizedMessage(languages());<a name="line.395"></a>
<FONT color="green">396</FONT>            }<a name="line.396"></a>
<FONT color="green">397</FONT>            else<a name="line.397"></a>
<FONT color="green">398</FONT>            {<a name="line.398"></a>
<FONT color="green">399</FONT>                // It is not one of our exceptions, so there is not much we can do.<a name="line.399"></a>
<FONT color="green">400</FONT>                localizedMessage = exception.getLocalizedMessage();<a name="line.400"></a>
<FONT color="green">401</FONT>            }<a name="line.401"></a>
<FONT color="green">402</FONT>    <a name="line.402"></a>
<FONT color="green">403</FONT>            return localizedMessage;<a name="line.403"></a>
<FONT color="green">404</FONT>    <a name="line.404"></a>
<FONT color="green">405</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.405"></a>
<FONT color="green">406</FONT>        }<a name="line.406"></a>
<FONT color="green">407</FONT>    <a name="line.407"></a>
<FONT color="green">408</FONT>    <a name="line.408"></a>
<FONT color="green">409</FONT>    <a name="line.409"></a>
<FONT color="green">410</FONT>        /**<a name="line.410"></a>
<FONT color="green">411</FONT>         * Returns the given string, localized in the session's language order. If the strings table for the current locale does not contain the given string, the next locale is tried, and so on. If no locale's contain the given string, the string itself is returned.<a name="line.411"></a>
<FONT color="green">412</FONT>         *<a name="line.412"></a>
<FONT color="green">413</FONT>         * @param string the string to localize<a name="line.413"></a>
<FONT color="green">414</FONT>         * @param table the name of the table to look for in the framework<a name="line.414"></a>
<FONT color="green">415</FONT>         * @param framework the name of the framework to look in<a name="line.415"></a>
<FONT color="green">416</FONT>         * @return the given string, localized in the session's language order<a name="line.416"></a>
<FONT color="green">417</FONT>         */<a name="line.417"></a>
<FONT color="green">418</FONT>        public String localizedString(String string, String table, String framework)<a name="line.418"></a>
<FONT color="green">419</FONT>        {<a name="line.419"></a>
<FONT color="green">420</FONT>            /** require [valid_param] string != null; **/<a name="line.420"></a>
<FONT color="green">421</FONT>            return WOApplication.application().resourceManager().stringForKey(string, table, string, framework, languages());<a name="line.421"></a>
<FONT color="green">422</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.422"></a>
<FONT color="green">423</FONT>        }<a name="line.423"></a>
<FONT color="green">424</FONT>    <a name="line.424"></a>
<FONT color="green">425</FONT>    <a name="line.425"></a>
<FONT color="green">426</FONT>        /**<a name="line.426"></a>
<FONT color="green">427</FONT>         * Returns the given string, localized in the session's language order. If the strings table for the current locale does not contain the given string, the next locale is tried, and so on. If no locale's contain the given string, the string itself is returned. Looks for a strings file in the main bundle, in a file named "&lt;Main Bundle Name&gt;.strings".<a name="line.427"></a>
<FONT color="green">428</FONT>         *<a name="line.428"></a>
<FONT color="green">429</FONT>         * @param string the string to localize<a name="line.429"></a>
<FONT color="green">430</FONT>         * @return the given string, localized in the session's language order<a name="line.430"></a>
<FONT color="green">431</FONT>         */<a name="line.431"></a>
<FONT color="green">432</FONT>        public String localizedString(String string)<a name="line.432"></a>
<FONT color="green">433</FONT>        {<a name="line.433"></a>
<FONT color="green">434</FONT>            /** require [valid_param] string != null; **/<a name="line.434"></a>
<FONT color="green">435</FONT>            return localizedString(string, NSBundle.mainBundle().name(), NSBundle.mainBundle().name());<a name="line.435"></a>
<FONT color="green">436</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.436"></a>
<FONT color="green">437</FONT>        }<a name="line.437"></a>
<FONT color="green">438</FONT>    <a name="line.438"></a>
<FONT color="green">439</FONT>    <a name="line.439"></a>
<FONT color="green">440</FONT>    <a name="line.440"></a>
<FONT color="green">441</FONT>    <a name="line.441"></a>
<FONT color="green">442</FONT>        /**<a name="line.442"></a>
<FONT color="green">443</FONT>         * Returns the given string, localized in the session's language order. The string is sought in several places:&lt;br/&gt;<a name="line.443"></a>
<FONT color="green">444</FONT>         * &lt;ol&gt;<a name="line.444"></a>
<FONT color="green">445</FONT>         * &lt;li&gt;As ComponentName.string (e.g. SearchForm.firstName) in PageName.strings (e.g. SearchPage.strings) in the configuration framework's bundle.&lt;/li&gt;<a name="line.445"></a>
<FONT color="green">446</FONT>         * &lt;li&gt;As string (e.g. firstName) in ComponentName.strings (e.g. SearchForm.strings) in the configuration framework's bundle.&lt;/li&gt;<a name="line.446"></a>
<FONT color="green">447</FONT>         * &lt;li&gt;As ComponentName.string in PageName.strings in the main bundle.&lt;/li&gt;<a name="line.447"></a>
<FONT color="green">448</FONT>         * &lt;li&gt;As ComponentName.string in PageName.strings in the page's bundle.&lt;/li&gt;<a name="line.448"></a>
<FONT color="green">449</FONT>         * &lt;li&gt;As string in ComponentName.strings in the main bundle.&lt;/li&gt;<a name="line.449"></a>
<FONT color="green">450</FONT>         * &lt;li&gt;As string in ComponentName.strings in the component's bundle.&lt;/li&gt;<a name="line.450"></a>
<FONT color="green">451</FONT>         * &lt;/ol&gt;<a name="line.451"></a>
<FONT color="green">452</FONT>         * If no locale's contain the given string, the string itself is returned.<a name="line.452"></a>
<FONT color="green">453</FONT>         *<a name="line.453"></a>
<FONT color="green">454</FONT>         * @param string the string to localize<a name="line.454"></a>
<FONT color="green">455</FONT>         * @param context WOContext indicating current page and component<a name="line.455"></a>
<FONT color="green">456</FONT>         * @return the given string, localized in the session's language order<a name="line.456"></a>
<FONT color="green">457</FONT>         */<a name="line.457"></a>
<FONT color="green">458</FONT>        public String localizedStringInContext(String string, WOContext context)<a name="line.458"></a>
<FONT color="green">459</FONT>        {<a name="line.459"></a>
<FONT color="green">460</FONT>            /** require [valid_string] string != null;<a name="line.460"></a>
<FONT color="green">461</FONT>                        [valid_context] context != null;<a name="line.461"></a>
<FONT color="green">462</FONT>                        [known_page] context.page() != null;  **/<a name="line.462"></a>
<FONT color="green">463</FONT>    <a name="line.463"></a>
<FONT color="green">464</FONT>            String pageName;<a name="line.464"></a>
<FONT color="green">465</FONT>            String componentName;<a name="line.465"></a>
<FONT color="green">466</FONT>            String componentQualifiedName;<a name="line.466"></a>
<FONT color="green">467</FONT>    <a name="line.467"></a>
<FONT color="green">468</FONT>            boolean isLocalizingForPage;<a name="line.468"></a>
<FONT color="green">469</FONT>    <a name="line.469"></a>
<FONT color="green">470</FONT>            // When the component is the top level page, we can avoid some redundant searches<a name="line.470"></a>
<FONT color="green">471</FONT>            if (context.page() == context.component())<a name="line.471"></a>
<FONT color="green">472</FONT>            {<a name="line.472"></a>
<FONT color="green">473</FONT>                pageName = componentName = ClassAdditions.unqualifiedClassName(context.page().getClass());<a name="line.473"></a>
<FONT color="green">474</FONT>                componentQualifiedName = string;<a name="line.474"></a>
<FONT color="green">475</FONT>                isLocalizingForPage = true;<a name="line.475"></a>
<FONT color="green">476</FONT>            }<a name="line.476"></a>
<FONT color="green">477</FONT>            else<a name="line.477"></a>
<FONT color="green">478</FONT>            {<a name="line.478"></a>
<FONT color="green">479</FONT>                pageName = ClassAdditions.unqualifiedClassName(context.page().getClass());<a name="line.479"></a>
<FONT color="green">480</FONT>                componentName = ClassAdditions.unqualifiedClassName(context.component().getClass());<a name="line.480"></a>
<FONT color="green">481</FONT>                componentQualifiedName = componentName + "." + string;<a name="line.481"></a>
<FONT color="green">482</FONT>                isLocalizingForPage = false;<a name="line.482"></a>
<FONT color="green">483</FONT>            }<a name="line.483"></a>
<FONT color="green">484</FONT>    <a name="line.484"></a>
<FONT color="green">485</FONT>            String uniqueKey = pageName + "." + componentQualifiedName;<a name="line.485"></a>
<FONT color="green">486</FONT>    <a name="line.486"></a>
<FONT color="green">487</FONT>            // Use previously cached value if found<a name="line.487"></a>
<FONT color="green">488</FONT>            String localizedString = (String) cachedLocalizedStrings().objectForKey(uniqueKey);<a name="line.488"></a>
<FONT color="green">489</FONT>            if (localizedString != null)<a name="line.489"></a>
<FONT color="green">490</FONT>            {<a name="line.490"></a>
<FONT color="green">491</FONT>                    return localizedString;<a name="line.491"></a>
<FONT color="green">492</FONT>            }<a name="line.492"></a>
<FONT color="green">493</FONT>    <a name="line.493"></a>
<FONT color="green">494</FONT>            WOResourceManager localizer = WOApplication.application().resourceManager();<a name="line.494"></a>
<FONT color="green">495</FONT>    <a name="line.495"></a>
<FONT color="green">496</FONT>            // First, check the configuration framework if there is one:<a name="line.496"></a>
<FONT color="green">497</FONT>            String configurationFrameworkName = application().configurationFrameworkName();<a name="line.497"></a>
<FONT color="green">498</FONT>            if (configurationFrameworkName != null)<a name="line.498"></a>
<FONT color="green">499</FONT>            {<a name="line.499"></a>
<FONT color="green">500</FONT>                 localizedString = localizer.stringForKey(componentQualifiedName, pageName, null, configurationFrameworkName, languages());<a name="line.500"></a>
<FONT color="green">501</FONT>    <a name="line.501"></a>
<FONT color="green">502</FONT>                if (localizedString == null &amp;&amp; ! isLocalizingForPage)<a name="line.502"></a>
<FONT color="green">503</FONT>                {<a name="line.503"></a>
<FONT color="green">504</FONT>                    localizedString = localizer.stringForKey(string, componentName, null, configurationFrameworkName, languages());<a name="line.504"></a>
<FONT color="green">505</FONT>                }<a name="line.505"></a>
<FONT color="green">506</FONT>            }<a name="line.506"></a>
<FONT color="green">507</FONT>    <a name="line.507"></a>
<FONT color="green">508</FONT>            // The second place to look is in the Application<a name="line.508"></a>
<FONT color="green">509</FONT>            if (localizedString == null)<a name="line.509"></a>
<FONT color="green">510</FONT>            {<a name="line.510"></a>
<FONT color="green">511</FONT>                localizedString = localizer.stringForKey(componentQualifiedName, pageName, null, null, languages());<a name="line.511"></a>
<FONT color="green">512</FONT>            }<a name="line.512"></a>
<FONT color="green">513</FONT>    <a name="line.513"></a>
<FONT color="green">514</FONT>            // Then check the page's bundle if not the application<a name="line.514"></a>
<FONT color="green">515</FONT>            NSBundle mainBundle = NSBundle.mainBundle();<a name="line.515"></a>
<FONT color="green">516</FONT>            if (localizedString == null)<a name="line.516"></a>
<FONT color="green">517</FONT>            {<a name="line.517"></a>
<FONT color="green">518</FONT>                NSBundle pageBundle = NSBundleAdditions.bundleForClass(context.page().getClass());<a name="line.518"></a>
<FONT color="green">519</FONT>                if ( ! pageBundle.equals(mainBundle))<a name="line.519"></a>
<FONT color="green">520</FONT>                {<a name="line.520"></a>
<FONT color="green">521</FONT>                    localizedString = localizer.stringForKey(componentQualifiedName, pageName, null, pageBundle.name(), languages());<a name="line.521"></a>
<FONT color="green">522</FONT>                }<a name="line.522"></a>
<FONT color="green">523</FONT>            }<a name="line.523"></a>
<FONT color="green">524</FONT>    <a name="line.524"></a>
<FONT color="green">525</FONT>            // Next, look for an application wide definition for the component<a name="line.525"></a>
<FONT color="green">526</FONT>            if (localizedString == null &amp;&amp; ! isLocalizingForPage)<a name="line.526"></a>
<FONT color="green">527</FONT>            {<a name="line.527"></a>
<FONT color="green">528</FONT>                localizedString = localizer.stringForKey(string, componentName, null, null, languages());<a name="line.528"></a>
<FONT color="green">529</FONT>            }<a name="line.529"></a>
<FONT color="green">530</FONT>    <a name="line.530"></a>
<FONT color="green">531</FONT>            // Finally check the components's bundle the component is not the page and not in the application bundle<a name="line.531"></a>
<FONT color="green">532</FONT>            if (localizedString == null &amp;&amp; ! isLocalizingForPage)<a name="line.532"></a>
<FONT color="green">533</FONT>            {<a name="line.533"></a>
<FONT color="green">534</FONT>               NSBundle componentBundle = NSBundleAdditions.bundleForClass(context.component().getClass());<a name="line.534"></a>
<FONT color="green">535</FONT>               if ( ! componentBundle.equals(mainBundle)) {<a name="line.535"></a>
<FONT color="green">536</FONT>                     localizedString = localizer.stringForKey(string, componentName, null, componentBundle.name(), languages());<a name="line.536"></a>
<FONT color="green">537</FONT>                }<a name="line.537"></a>
<FONT color="green">538</FONT>            }<a name="line.538"></a>
<FONT color="green">539</FONT>    <a name="line.539"></a>
<FONT color="green">540</FONT>            // Handle the string not being found<a name="line.540"></a>
<FONT color="green">541</FONT>            if (localizedString == null)<a name="line.541"></a>
<FONT color="green">542</FONT>            {<a name="line.542"></a>
<FONT color="green">543</FONT>                localizedString = string;<a name="line.543"></a>
<FONT color="green">544</FONT>    <a name="line.544"></a>
<FONT color="green">545</FONT>                // Not the most beautiful piece of code, but useful when debugging<a name="line.545"></a>
<FONT color="green">546</FONT>                NSLog.out.appendln("Unable to localize String " + string + " for languages " + languages());<a name="line.546"></a>
<FONT color="green">547</FONT>                NSLog.out.appendln("              pageName " + pageName);<a name="line.547"></a>
<FONT color="green">548</FONT>                NSLog.out.appendln("         componentName " + componentName);<a name="line.548"></a>
<FONT color="green">549</FONT>                NSLog.out.appendln("componentQualifiedName " + componentQualifiedName);<a name="line.549"></a>
<FONT color="green">550</FONT>                if (configurationFrameworkName != null) NSLog.out.appendln("Checked for " + componentQualifiedName + " in table " + pageName + ".strings in framework " + configurationFrameworkName);<a name="line.550"></a>
<FONT color="green">551</FONT>                if ((configurationFrameworkName != null) &amp;&amp; ! isLocalizingForPage) NSLog.out.appendln("Checked for " + string + " in table " + componentName + ".strings in framework " + configurationFrameworkName);<a name="line.551"></a>
<FONT color="green">552</FONT>                NSLog.out.appendln("Checked for " + componentQualifiedName + " in table " + pageName + ".strings in app ");<a name="line.552"></a>
<FONT color="green">553</FONT>                if ( ! NSBundleAdditions.bundleForClass(context.page().getClass()).equals(mainBundle)) NSLog.out.appendln("Checked for " + componentQualifiedName + " in table " + pageName + ".strings in framework " + NSBundleAdditions.bundleForClass(context.page().getClass()).name());<a name="line.553"></a>
<FONT color="green">554</FONT>                if (! isLocalizingForPage) NSLog.out.appendln("Checked for " + string + " in table " + componentName + ".strings in app " );<a name="line.554"></a>
<FONT color="green">555</FONT>                if ((! isLocalizingForPage) &amp;&amp; ( ! NSBundleAdditions.bundleForClass(context.component().getClass()).equals(mainBundle))) NSLog.out.appendln("Checking for " + string + " in table " + componentName + ".strings in framework " + NSBundleAdditions.bundleForClass(context.component().getClass()).name());<a name="line.555"></a>
<FONT color="green">556</FONT>            }<a name="line.556"></a>
<FONT color="green">557</FONT>    <a name="line.557"></a>
<FONT color="green">558</FONT>            // Cache return value for optimization<a name="line.558"></a>
<FONT color="green">559</FONT>            cachedLocalizedStrings().setObjectForKey(localizedString, uniqueKey);<a name="line.559"></a>
<FONT color="green">560</FONT>    <a name="line.560"></a>
<FONT color="green">561</FONT>            return localizedString;<a name="line.561"></a>
<FONT color="green">562</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.562"></a>
<FONT color="green">563</FONT>        }<a name="line.563"></a>
<FONT color="green">564</FONT>    <a name="line.564"></a>
<FONT color="green">565</FONT>    <a name="line.565"></a>
<FONT color="green">566</FONT>    <a name="line.566"></a>
<FONT color="green">567</FONT>        /**<a name="line.567"></a>
<FONT color="green">568</FONT>         * Cover method for the primary localization existance method for EOFValidation.<a name="line.568"></a>
<FONT color="green">569</FONT>         *<a name="line.569"></a>
<FONT color="green">570</FONT>         * @param entityName name of the entity to lookup<a name="line.570"></a>
<FONT color="green">571</FONT>         * @param propertyName property name to look up this localized string for.  Ignored if it is null or an empty string<a name="line.571"></a>
<FONT color="green">572</FONT>         * @param key key to look up this localized string for<a name="line.572"></a>
<FONT color="green">573</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if there is a localized string in any of the string tables for any of the languages. Languages are searched depth first.<a name="line.573"></a>
<FONT color="green">574</FONT>         */<a name="line.574"></a>
<FONT color="green">575</FONT>        public boolean localizedEOStringExists(String entityName, String propertyName, String key)<a name="line.575"></a>
<FONT color="green">576</FONT>        {<a name="line.576"></a>
<FONT color="green">577</FONT>            /** require<a name="line.577"></a>
<FONT color="green">578</FONT>            [valid_entity_param] entityName != null;<a name="line.578"></a>
<FONT color="green">579</FONT>            [valid_key_param] (key != null)  &amp;&amp; (key.length() &gt; 0);   **/<a name="line.579"></a>
<FONT color="green">580</FONT>    <a name="line.580"></a>
<FONT color="green">581</FONT>            return LocalizationEngine.localizedStringExists(entityName, propertyName, key, languages());<a name="line.581"></a>
<FONT color="green">582</FONT>        }<a name="line.582"></a>
<FONT color="green">583</FONT>    <a name="line.583"></a>
<FONT color="green">584</FONT>    <a name="line.584"></a>
<FONT color="green">585</FONT>    <a name="line.585"></a>
<FONT color="green">586</FONT>        /**<a name="line.586"></a>
<FONT color="green">587</FONT>         * Cover method for the primary localization existance method for EOFValidation.<a name="line.587"></a>
<FONT color="green">588</FONT>         *<a name="line.588"></a>
<FONT color="green">589</FONT>         * @param entity EOEntity to look up this localized string for<a name="line.589"></a>
<FONT color="green">590</FONT>         * @param propertyName property name to look up this localized string for.  Ignored if it is null or an empty string<a name="line.590"></a>
<FONT color="green">591</FONT>         * @param key key to look up this localized string for<a name="line.591"></a>
<FONT color="green">592</FONT>         * @return &lt;code&gt;true&lt;/code&gt; if there is a localized string in any of the string tables for any of the languages. Languages are searched depth first.<a name="line.592"></a>
<FONT color="green">593</FONT>         */<a name="line.593"></a>
<FONT color="green">594</FONT>        public boolean localizedEOStringExists(EOEntity entity, String propertyName, String key)<a name="line.594"></a>
<FONT color="green">595</FONT>        {<a name="line.595"></a>
<FONT color="green">596</FONT>            /** require<a name="line.596"></a>
<FONT color="green">597</FONT>            [valid_entity_param] entity != null;<a name="line.597"></a>
<FONT color="green">598</FONT>            [valid_key_param] (key != null)  &amp;&amp; (key.length() &gt; 0);          **/<a name="line.598"></a>
<FONT color="green">599</FONT>    <a name="line.599"></a>
<FONT color="green">600</FONT>            return LocalizationEngine.localizedStringExists(entity.name(), propertyName, key, languages());<a name="line.600"></a>
<FONT color="green">601</FONT>        }<a name="line.601"></a>
<FONT color="green">602</FONT>    <a name="line.602"></a>
<FONT color="green">603</FONT>    <a name="line.603"></a>
<FONT color="green">604</FONT>    <a name="line.604"></a>
<FONT color="green">605</FONT>        /**<a name="line.605"></a>
<FONT color="green">606</FONT>         * Cover method for the primary localization method for EOFValidation.<a name="line.606"></a>
<FONT color="green">607</FONT>         *<a name="line.607"></a>
<FONT color="green">608</FONT>         * @param entityName name of the entity to lookup<a name="line.608"></a>
<FONT color="green">609</FONT>         * @param propertyName property name to look up this localized string for.  Ignored if it is null or an empty string<a name="line.609"></a>
<FONT color="green">610</FONT>         * @param key key to look up this localized string for<a name="line.610"></a>
<FONT color="green">611</FONT>         * @return localized string on entity for propertyName and key<a name="line.611"></a>
<FONT color="green">612</FONT>         */<a name="line.612"></a>
<FONT color="green">613</FONT>        public String localizedEOString(String entityName, String propertyName, String key)<a name="line.613"></a>
<FONT color="green">614</FONT>        {<a name="line.614"></a>
<FONT color="green">615</FONT>            /** require<a name="line.615"></a>
<FONT color="green">616</FONT>            [valid_entityName_param] entityName != null;<a name="line.616"></a>
<FONT color="green">617</FONT>            [valid_key_param] (key != null)  &amp;&amp; (key.length() &gt; 0);<a name="line.617"></a>
<FONT color="green">618</FONT>            [localization_exists] localizedEOStringExists(entityName, propertyName, key); **/<a name="line.618"></a>
<FONT color="green">619</FONT>    <a name="line.619"></a>
<FONT color="green">620</FONT>            return LocalizationEngine.localizedString(entityName, propertyName, key, languages());<a name="line.620"></a>
<FONT color="green">621</FONT>    <a name="line.621"></a>
<FONT color="green">622</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.622"></a>
<FONT color="green">623</FONT>        }<a name="line.623"></a>
<FONT color="green">624</FONT>    <a name="line.624"></a>
<FONT color="green">625</FONT>    <a name="line.625"></a>
<FONT color="green">626</FONT>    <a name="line.626"></a>
<FONT color="green">627</FONT>        /**<a name="line.627"></a>
<FONT color="green">628</FONT>         * Cover method for the primary localization method for EOFValidation.<a name="line.628"></a>
<FONT color="green">629</FONT>         *<a name="line.629"></a>
<FONT color="green">630</FONT>         * @param entity EOEntity to look up this localized string for<a name="line.630"></a>
<FONT color="green">631</FONT>         * @param propertyName property name to look up this localized string for.  Ignored if it is null or an empty string<a name="line.631"></a>
<FONT color="green">632</FONT>         * @param key key to look up this localized string for<a name="line.632"></a>
<FONT color="green">633</FONT>         * @return localized string on entity for propertyName and key<a name="line.633"></a>
<FONT color="green">634</FONT>         */<a name="line.634"></a>
<FONT color="green">635</FONT>        public String localizedEOString(EOEntity entity, String propertyName, String key)<a name="line.635"></a>
<FONT color="green">636</FONT>        {<a name="line.636"></a>
<FONT color="green">637</FONT>            /** require<a name="line.637"></a>
<FONT color="green">638</FONT>            [valid_entity_param] entity != null;<a name="line.638"></a>
<FONT color="green">639</FONT>            [valid_key_param] (key != null)  &amp;&amp; (key.length() &gt; 0);<a name="line.639"></a>
<FONT color="green">640</FONT>            [localization_exists] localizedEOStringExists(entity.name(), propertyName, key); **/<a name="line.640"></a>
<FONT color="green">641</FONT>    <a name="line.641"></a>
<FONT color="green">642</FONT>            return LocalizationEngine.localizedString(entity.name(), propertyName, key, languages());<a name="line.642"></a>
<FONT color="green">643</FONT>    <a name="line.643"></a>
<FONT color="green">644</FONT>            /** ensure [valid_result] Result != null; **/<a name="line.644"></a>
<FONT color="green">645</FONT>        }<a name="line.645"></a>
<FONT color="green">646</FONT>    <a name="line.646"></a>
<FONT color="green">647</FONT>    <a name="line.647"></a>
<FONT color="green">648</FONT>    <a name="line.648"></a>
<FONT color="green">649</FONT>        /**<a name="line.649"></a>
<FONT color="green">650</FONT>         * @return dictionary of cached localization keyed on page name and localization key<a name="line.650"></a>
<FONT color="green">651</FONT>         */<a name="line.651"></a>
<FONT color="green">652</FONT>        protected NSMutableDictionary cachedLocalizedStrings()<a name="line.652"></a>
<FONT color="green">653</FONT>        {<a name="line.653"></a>
<FONT color="green">654</FONT>            return cachedLocalizedStrings;<a name="line.654"></a>
<FONT color="green">655</FONT>        }<a name="line.655"></a>
<FONT color="green">656</FONT>    <a name="line.656"></a>
<FONT color="green">657</FONT>    <a name="line.657"></a>
<FONT color="green">658</FONT>    <a name="line.658"></a>
<FONT color="green">659</FONT>        public WOApplication application()<a name="line.659"></a>
<FONT color="green">660</FONT>        {<a name="line.660"></a>
<FONT color="green">661</FONT>            return (WOApplication)WOApplication.application();<a name="line.661"></a>
<FONT color="green">662</FONT>        }<a name="line.662"></a>
<FONT color="green">663</FONT>    <a name="line.663"></a>
<FONT color="green">664</FONT>    }<a name="line.664"></a>




























































</PRE>
</BODY>
</HTML>
